!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.P2PEngineShaka=t():e.P2PEngineShaka=t()}(self,(()=>(()=>{var e={539:(e,t)=>{"use strict";function s(e,t){return void 0===t&&(t=Object),t&&"function"==typeof t.freeze?t.freeze(e):e}var i=s({HTML:"text/html",isHTML:function(e){return e===i.HTML},XML_APPLICATION:"application/xml",XML_TEXT:"text/xml",XML_XHTML_APPLICATION:"application/xhtml+xml",XML_SVG_IMAGE:"image/svg+xml"}),r=s({HTML:"http://www.w3.org/1999/xhtml",isHTML:function(e){return e===r.HTML},SVG:"http://www.w3.org/2000/svg",XML:"http://www.w3.org/XML/1998/namespace",XMLNS:"http://www.w3.org/2000/xmlns/"});t.freeze=s,t.MIME_TYPE=i,t.NAMESPACE=r},588:(e,t,s)=>{var i=s(539),r=s(89),n=s(369),o=s(835),a=r.DOMImplementation,h=i.NAMESPACE,l=o.ParseError,c=o.XMLReader;function d(e){this.options=e||{locator:{}}}function u(){this.cdata=!1}function f(e,t){t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber}function g(e){if(e)return"\n@"+(e.systemId||"")+"#[line:"+e.lineNumber+",col:"+e.columnNumber+"]"}function p(e,t,s){return"string"==typeof e?e.substr(t,s):e.length>=t+s||t?new java.lang.String(e,t,s)+"":e}function m(e,t){e.currentElement?e.currentElement.appendChild(t):e.doc.appendChild(t)}d.prototype.parseFromString=function(e,t){var s=this.options,i=new c,r=s.domBuilder||new u,o=s.errorHandler,a=s.locator,l=s.xmlns||{},d=/\/x?html?$/.test(t),f=d?n.HTML_ENTITIES:n.XML_ENTITIES;return a&&r.setDocumentLocator(a),i.errorHandler=function(e,t,s){if(!e){if(t instanceof u)return t;e=t}var i={},r=e instanceof Function;function n(t){var n=e[t];!n&&r&&(n=2==e.length?function(s){e(t,s)}:e),i[t]=n&&function(e){n("[xmldom "+t+"]\t"+e+g(s))}||function(){}}return s=s||{},n("warning"),n("error"),n("fatalError"),i}(o,r,a),i.domBuilder=s.domBuilder||r,d&&(l[""]=h.HTML),l.xml=l.xml||h.XML,e&&"string"==typeof e?i.parse(e,l,f):i.errorHandler.error("invalid doc source"),r.doc},u.prototype={startDocument:function(){this.doc=(new a).createDocument(null,null,null),this.locator&&(this.doc.documentURI=this.locator.systemId)},startElement:function(e,t,s,i){var r=this.doc,n=r.createElementNS(e,s||t),o=i.length;m(this,n),this.currentElement=n,this.locator&&f(this.locator,n);for(var a=0;a<o;a++){e=i.getURI(a);var h=i.getValue(a),l=(s=i.getQName(a),r.createAttributeNS(e,s));this.locator&&f(i.getLocator(a),l),l.value=l.nodeValue=h,n.setAttributeNode(l)}},endElement:function(e,t,s){var i=this.currentElement;i.tagName;this.currentElement=i.parentNode},startPrefixMapping:function(e,t){},endPrefixMapping:function(e){},processingInstruction:function(e,t){var s=this.doc.createProcessingInstruction(e,t);this.locator&&f(this.locator,s),m(this,s)},ignorableWhitespace:function(e,t,s){},characters:function(e,t,s){if(e=p.apply(this,arguments)){if(this.cdata)var i=this.doc.createCDATASection(e);else i=this.doc.createTextNode(e);this.currentElement?this.currentElement.appendChild(i):/^\s*$/.test(e)&&this.doc.appendChild(i),this.locator&&f(this.locator,i)}},skippedEntity:function(e){},endDocument:function(){this.doc.normalize()},setDocumentLocator:function(e){(this.locator=e)&&(e.lineNumber=0)},comment:function(e,t,s){e=p.apply(this,arguments);var i=this.doc.createComment(e);this.locator&&f(this.locator,i),m(this,i)},startCDATA:function(){this.cdata=!0},endCDATA:function(){this.cdata=!1},startDTD:function(e,t,s){var i=this.doc.implementation;if(i&&i.createDocumentType){var r=i.createDocumentType(e,t,s);this.locator&&f(this.locator,r),m(this,r),this.doc.doctype=r}},warning:function(e){console.warn("[xmldom warning]\t"+e,g(this.locator))},error:function(e){console.error("[xmldom error]\t"+e,g(this.locator))},fatalError:function(e){throw new l(e,this.locator)}},"endDTD,startEntity,endEntity,attributeDecl,elementDecl,externalEntityDecl,internalEntityDecl,resolveEntity,getExternalSubset,notationDecl,unparsedEntityDecl".replace(/\w+/g,(function(e){u.prototype[e]=function(){return null}})),t.DOMParser=d,r.DOMImplementation,r.XMLSerializer},89:(e,t,s)=>{var i=s(539).NAMESPACE;function r(e){return""!==e}function n(e,t){return e.hasOwnProperty(t)||(e[t]=!0),e}function o(e){if(!e)return[];var t=function(e){return e?e.split(/[\t\n\f\r ]+/).filter(r):[]}(e);return Object.keys(t.reduce(n,{}))}function a(e,t){for(var s in e)t[s]=e[s]}function h(e,t){var s=e.prototype;if(!(s instanceof t)){function i(){}i.prototype=t.prototype,a(s,i=new i),e.prototype=s=i}s.constructor!=e&&("function"!=typeof e&&console.error("unknown Class:"+e),s.constructor=e)}var l={},c=l.ELEMENT_NODE=1,d=l.ATTRIBUTE_NODE=2,u=l.TEXT_NODE=3,f=l.CDATA_SECTION_NODE=4,g=l.ENTITY_REFERENCE_NODE=5,p=l.ENTITY_NODE=6,m=l.PROCESSING_INSTRUCTION_NODE=7,_=l.COMMENT_NODE=8,y=l.DOCUMENT_NODE=9,v=l.DOCUMENT_TYPE_NODE=10,b=l.DOCUMENT_FRAGMENT_NODE=11,S=l.NOTATION_NODE=12,w={},P={},E=(w.INDEX_SIZE_ERR=(P[1]="Index size error",1),w.DOMSTRING_SIZE_ERR=(P[2]="DOMString size error",2),w.HIERARCHY_REQUEST_ERR=(P[3]="Hierarchy request error",3)),T=(w.WRONG_DOCUMENT_ERR=(P[4]="Wrong document",4),w.INVALID_CHARACTER_ERR=(P[5]="Invalid character",5),w.NO_DATA_ALLOWED_ERR=(P[6]="No data allowed",6),w.NO_MODIFICATION_ALLOWED_ERR=(P[7]="No modification allowed",7),w.NOT_FOUND_ERR=(P[8]="Not found",8)),C=(w.NOT_SUPPORTED_ERR=(P[9]="Not supported",9),w.INUSE_ATTRIBUTE_ERR=(P[10]="Attribute in use",10));w.INVALID_STATE_ERR=(P[11]="Invalid state",11),w.SYNTAX_ERR=(P[12]="Syntax error",12),w.INVALID_MODIFICATION_ERR=(P[13]="Invalid modification",13),w.NAMESPACE_ERR=(P[14]="Invalid namespace",14),w.INVALID_ACCESS_ERR=(P[15]="Invalid access",15);function I(e,t){if(t instanceof Error)var s=t;else s=this,Error.call(this,P[e]),this.message=P[e],Error.captureStackTrace&&Error.captureStackTrace(this,I);return s.code=e,t&&(this.message=this.message+": "+t),s}function N(){}function L(e,t){this._node=e,this._refresh=t,D(this)}function D(e){var t=e._node._inc||e._node.ownerDocument._inc;if(e._inc!=t){var s=e._refresh(e._node);le(e,"length",s.length),a(s,e),e._inc=t}}function R(){}function M(e,t){for(var s=e.length;s--;)if(e[s]===t)return s}function A(e,t,s,r){if(r?t[M(t,r)]=s:t[t.length++]=s,e){s.ownerElement=e;var n=e.ownerDocument;n&&(r&&q(n,e,r),function(e,t,s){e&&e._inc++,s.namespaceURI===i.XMLNS&&(t._nsMap[s.prefix?s.localName:""]=s.value)}(n,e,s))}}function O(e,t,s){var i=M(t,s);if(!(i>=0))throw I(T,new Error(e.tagName+"@"+s));for(var r=t.length-1;i<r;)t[i]=t[++i];if(t.length=r,e){var n=e.ownerDocument;n&&(q(n,e,s),s.ownerElement=null)}}function k(){}function x(){}function B(e){return("<"==e?"&lt;":">"==e&&"&gt;")||"&"==e&&"&amp;"||'"'==e&&"&quot;"||"&#"+e.charCodeAt()+";"}function $(e,t){if(t(e))return!0;if(e=e.firstChild)do{if($(e,t))return!0}while(e=e.nextSibling)}function U(){}function q(e,t,s,r){e&&e._inc++,s.namespaceURI===i.XMLNS&&delete t._nsMap[s.prefix?s.localName:""]}function z(e,t,s){if(e&&e._inc){e._inc++;var i=t.childNodes;if(s)i[i.length++]=s;else{for(var r=t.firstChild,n=0;r;)i[n++]=r,r=r.nextSibling;i.length=n}}}function F(e,t){var s=t.previousSibling,i=t.nextSibling;return s?s.nextSibling=i:e.firstChild=i,i?i.previousSibling=s:e.lastChild=s,z(e.ownerDocument,e),t}function H(e,t,s){var i=t.parentNode;if(i&&i.removeChild(t),t.nodeType===b){var r=t.firstChild;if(null==r)return t;var n=t.lastChild}else r=n=t;var o=s?s.previousSibling:e.lastChild;r.previousSibling=o,n.nextSibling=s,o?o.nextSibling=r:e.firstChild=r,null==s?e.lastChild=n:s.previousSibling=n;do{r.parentNode=e}while(r!==n&&(r=r.nextSibling));return z(e.ownerDocument||e,e),t.nodeType==b&&(t.firstChild=t.lastChild=null),t}function W(){this._nsMap={}}function j(){}function G(){}function X(){}function V(){}function Y(){}function Q(){}function J(){}function K(){}function Z(){}function ee(){}function te(){}function se(){}function ie(e,t){var s=[],i=9==this.nodeType&&this.documentElement||this,r=i.prefix,n=i.namespaceURI;if(n&&null==r&&null==(r=i.lookupPrefix(n)))var o=[{namespace:n,prefix:null}];return oe(this,s,e,t,o),s.join("")}function re(e,t,s){var r=e.prefix||"",n=e.namespaceURI;if(!n)return!1;if("xml"===r&&n===i.XML||n===i.XMLNS)return!1;for(var o=s.length;o--;){var a=s[o];if(a.prefix===r)return a.namespace!==n}return!0}function ne(e,t,s){e.push(" ",t,'="',s.replace(/[<&"]/g,B),'"')}function oe(e,t,s,r,n){if(n||(n=[]),r){if(!(e=r(e)))return;if("string"==typeof e)return void t.push(e)}switch(e.nodeType){case c:var o=e.attributes,a=o.length,h=e.firstChild,l=e.tagName,p=l;if(!(s=i.isHTML(e.namespaceURI)||s)&&!e.prefix&&e.namespaceURI){for(var S,w=0;w<o.length;w++)if("xmlns"===o.item(w).name){S=o.item(w).value;break}if(!S)for(var P=n.length-1;P>=0;P--){if(""===(E=n[P]).prefix&&E.namespace===e.namespaceURI){S=E.namespace;break}}if(S!==e.namespaceURI)for(P=n.length-1;P>=0;P--){var E;if((E=n[P]).namespace===e.namespaceURI){E.prefix&&(p=E.prefix+":"+l);break}}}t.push("<",p);for(var T=0;T<a;T++){"xmlns"==(C=o.item(T)).prefix?n.push({prefix:C.localName,namespace:C.value}):"xmlns"==C.nodeName&&n.push({prefix:"",namespace:C.value})}for(T=0;T<a;T++){var C,I,N;if(re(C=o.item(T),0,n))ne(t,(I=C.prefix||"")?"xmlns:"+I:"xmlns",N=C.namespaceURI),n.push({prefix:I,namespace:N});oe(C,t,s,r,n)}if(l===p&&re(e,0,n))ne(t,(I=e.prefix||"")?"xmlns:"+I:"xmlns",N=e.namespaceURI),n.push({prefix:I,namespace:N});if(h||s&&!/^(?:meta|link|img|br|hr|input)$/i.test(l)){if(t.push(">"),s&&/^script$/i.test(l))for(;h;)h.data?t.push(h.data):oe(h,t,s,r,n.slice()),h=h.nextSibling;else for(;h;)oe(h,t,s,r,n.slice()),h=h.nextSibling;t.push("</",p,">")}else t.push("/>");return;case y:case b:for(h=e.firstChild;h;)oe(h,t,s,r,n.slice()),h=h.nextSibling;return;case d:return ne(t,e.name,e.value);case u:return t.push(e.data.replace(/[<&]/g,B).replace(/]]>/g,"]]&gt;"));case f:return t.push("<![CDATA[",e.data,"]]>");case _:return t.push("\x3c!--",e.data,"--\x3e");case v:var L=e.publicId,D=e.systemId;if(t.push("<!DOCTYPE ",e.name),L)t.push(" PUBLIC ",L),D&&"."!=D&&t.push(" ",D),t.push(">");else if(D&&"."!=D)t.push(" SYSTEM ",D,">");else{var R=e.internalSubset;R&&t.push(" [",R,"]"),t.push(">")}return;case m:return t.push("<?",e.target," ",e.data,"?>");case g:return t.push("&",e.nodeName,";");default:t.push("??",e.nodeName)}}function ae(e,t,s){var i;switch(t.nodeType){case c:(i=t.cloneNode(!1)).ownerDocument=e;case b:break;case d:s=!0}if(i||(i=t.cloneNode(!1)),i.ownerDocument=e,i.parentNode=null,s)for(var r=t.firstChild;r;)i.appendChild(ae(e,r,s)),r=r.nextSibling;return i}function he(e,t,s){var i=new t.constructor;for(var r in t){var n=t[r];"object"!=typeof n&&n!=i[r]&&(i[r]=n)}switch(t.childNodes&&(i.childNodes=new N),i.ownerDocument=e,i.nodeType){case c:var o=t.attributes,a=i.attributes=new R,h=o.length;a._ownerElement=i;for(var l=0;l<h;l++)i.setAttributeNode(he(e,o.item(l),!0));break;case d:s=!0}if(s)for(var u=t.firstChild;u;)i.appendChild(he(e,u,s)),u=u.nextSibling;return i}function le(e,t,s){e[t]=s}I.prototype=Error.prototype,a(w,I),N.prototype={length:0,item:function(e){return this[e]||null},toString:function(e,t){for(var s=[],i=0;i<this.length;i++)oe(this[i],s,e,t);return s.join("")}},L.prototype.item=function(e){return D(this),this[e]},h(L,N),R.prototype={length:0,item:N.prototype.item,getNamedItem:function(e){for(var t=this.length;t--;){var s=this[t];if(s.nodeName==e)return s}},setNamedItem:function(e){var t=e.ownerElement;if(t&&t!=this._ownerElement)throw new I(C);var s=this.getNamedItem(e.nodeName);return A(this._ownerElement,this,e,s),s},setNamedItemNS:function(e){var t,s=e.ownerElement;if(s&&s!=this._ownerElement)throw new I(C);return t=this.getNamedItemNS(e.namespaceURI,e.localName),A(this._ownerElement,this,e,t),t},removeNamedItem:function(e){var t=this.getNamedItem(e);return O(this._ownerElement,this,t),t},removeNamedItemNS:function(e,t){var s=this.getNamedItemNS(e,t);return O(this._ownerElement,this,s),s},getNamedItemNS:function(e,t){for(var s=this.length;s--;){var i=this[s];if(i.localName==t&&i.namespaceURI==e)return i}return null}},k.prototype={hasFeature:function(e,t){return!0},createDocument:function(e,t,s){var i=new U;if(i.implementation=this,i.childNodes=new N,i.doctype=s||null,s&&i.appendChild(s),t){var r=i.createElementNS(e,t);i.appendChild(r)}return i},createDocumentType:function(e,t,s){var i=new Q;return i.name=e,i.nodeName=e,i.publicId=t||"",i.systemId=s||"",i}},x.prototype={firstChild:null,lastChild:null,previousSibling:null,nextSibling:null,attributes:null,parentNode:null,childNodes:null,ownerDocument:null,nodeValue:null,namespaceURI:null,prefix:null,localName:null,insertBefore:function(e,t){return H(this,e,t)},replaceChild:function(e,t){this.insertBefore(e,t),t&&this.removeChild(t)},removeChild:function(e){return F(this,e)},appendChild:function(e){return this.insertBefore(e,null)},hasChildNodes:function(){return null!=this.firstChild},cloneNode:function(e){return he(this.ownerDocument||this,this,e)},normalize:function(){for(var e=this.firstChild;e;){var t=e.nextSibling;t&&t.nodeType==u&&e.nodeType==u?(this.removeChild(t),e.appendData(t.data)):(e.normalize(),e=t)}},isSupported:function(e,t){return this.ownerDocument.implementation.hasFeature(e,t)},hasAttributes:function(){return this.attributes.length>0},lookupPrefix:function(e){for(var t=this;t;){var s=t._nsMap;if(s)for(var i in s)if(s[i]==e)return i;t=t.nodeType==d?t.ownerDocument:t.parentNode}return null},lookupNamespaceURI:function(e){for(var t=this;t;){var s=t._nsMap;if(s&&e in s)return s[e];t=t.nodeType==d?t.ownerDocument:t.parentNode}return null},isDefaultNamespace:function(e){return null==this.lookupPrefix(e)}},a(l,x),a(l,x.prototype),U.prototype={nodeName:"#document",nodeType:y,doctype:null,documentElement:null,_inc:1,insertBefore:function(e,t){if(e.nodeType==b){for(var s=e.firstChild;s;){var i=s.nextSibling;this.insertBefore(s,t),s=i}return e}return null==this.documentElement&&e.nodeType==c&&(this.documentElement=e),H(this,e,t),e.ownerDocument=this,e},removeChild:function(e){return this.documentElement==e&&(this.documentElement=null),F(this,e)},importNode:function(e,t){return ae(this,e,t)},getElementById:function(e){var t=null;return $(this.documentElement,(function(s){if(s.nodeType==c&&s.getAttribute("id")==e)return t=s,!0})),t},getElementsByClassName:function(e){var t=o(e);return new L(this,(function(s){var i=[];return t.length>0&&$(s.documentElement,(function(r){if(r!==s&&r.nodeType===c){var n=r.getAttribute("class");if(n){var a=e===n;if(!a){var h=o(n);a=t.every((l=h,function(e){return l&&-1!==l.indexOf(e)}))}a&&i.push(r)}}var l})),i}))},createElement:function(e){var t=new W;return t.ownerDocument=this,t.nodeName=e,t.tagName=e,t.localName=e,t.childNodes=new N,(t.attributes=new R)._ownerElement=t,t},createDocumentFragment:function(){var e=new ee;return e.ownerDocument=this,e.childNodes=new N,e},createTextNode:function(e){var t=new X;return t.ownerDocument=this,t.appendData(e),t},createComment:function(e){var t=new V;return t.ownerDocument=this,t.appendData(e),t},createCDATASection:function(e){var t=new Y;return t.ownerDocument=this,t.appendData(e),t},createProcessingInstruction:function(e,t){var s=new te;return s.ownerDocument=this,s.tagName=s.target=e,s.nodeValue=s.data=t,s},createAttribute:function(e){var t=new j;return t.ownerDocument=this,t.name=e,t.nodeName=e,t.localName=e,t.specified=!0,t},createEntityReference:function(e){var t=new Z;return t.ownerDocument=this,t.nodeName=e,t},createElementNS:function(e,t){var s=new W,i=t.split(":"),r=s.attributes=new R;return s.childNodes=new N,s.ownerDocument=this,s.nodeName=t,s.tagName=t,s.namespaceURI=e,2==i.length?(s.prefix=i[0],s.localName=i[1]):s.localName=t,r._ownerElement=s,s},createAttributeNS:function(e,t){var s=new j,i=t.split(":");return s.ownerDocument=this,s.nodeName=t,s.name=t,s.namespaceURI=e,s.specified=!0,2==i.length?(s.prefix=i[0],s.localName=i[1]):s.localName=t,s}},h(U,x),W.prototype={nodeType:c,hasAttribute:function(e){return null!=this.getAttributeNode(e)},getAttribute:function(e){var t=this.getAttributeNode(e);return t&&t.value||""},getAttributeNode:function(e){return this.attributes.getNamedItem(e)},setAttribute:function(e,t){var s=this.ownerDocument.createAttribute(e);s.value=s.nodeValue=""+t,this.setAttributeNode(s)},removeAttribute:function(e){var t=this.getAttributeNode(e);t&&this.removeAttributeNode(t)},appendChild:function(e){return e.nodeType===b?this.insertBefore(e,null):function(e,t){var s=t.parentNode;if(s){var i=e.lastChild;s.removeChild(t),i=e.lastChild}return i=e.lastChild,t.parentNode=e,t.previousSibling=i,t.nextSibling=null,i?i.nextSibling=t:e.firstChild=t,e.lastChild=t,z(e.ownerDocument,e,t),t}(this,e)},setAttributeNode:function(e){return this.attributes.setNamedItem(e)},setAttributeNodeNS:function(e){return this.attributes.setNamedItemNS(e)},removeAttributeNode:function(e){return this.attributes.removeNamedItem(e.nodeName)},removeAttributeNS:function(e,t){var s=this.getAttributeNodeNS(e,t);s&&this.removeAttributeNode(s)},hasAttributeNS:function(e,t){return null!=this.getAttributeNodeNS(e,t)},getAttributeNS:function(e,t){var s=this.getAttributeNodeNS(e,t);return s&&s.value||""},setAttributeNS:function(e,t,s){var i=this.ownerDocument.createAttributeNS(e,t);i.value=i.nodeValue=""+s,this.setAttributeNode(i)},getAttributeNodeNS:function(e,t){return this.attributes.getNamedItemNS(e,t)},getElementsByTagName:function(e){return new L(this,(function(t){var s=[];return $(t,(function(i){i===t||i.nodeType!=c||"*"!==e&&i.tagName!=e||s.push(i)})),s}))},getElementsByTagNameNS:function(e,t){return new L(this,(function(s){var i=[];return $(s,(function(r){r===s||r.nodeType!==c||"*"!==e&&r.namespaceURI!==e||"*"!==t&&r.localName!=t||i.push(r)})),i}))}},U.prototype.getElementsByTagName=W.prototype.getElementsByTagName,U.prototype.getElementsByTagNameNS=W.prototype.getElementsByTagNameNS,h(W,x),j.prototype.nodeType=d,h(j,x),G.prototype={data:"",substringData:function(e,t){return this.data.substring(e,e+t)},appendData:function(e){e=this.data+e,this.nodeValue=this.data=e,this.length=e.length},insertData:function(e,t){this.replaceData(e,0,t)},appendChild:function(e){throw new Error(P[E])},deleteData:function(e,t){this.replaceData(e,t,"")},replaceData:function(e,t,s){s=this.data.substring(0,e)+s+this.data.substring(e+t),this.nodeValue=this.data=s,this.length=s.length}},h(G,x),X.prototype={nodeName:"#text",nodeType:u,splitText:function(e){var t=this.data,s=t.substring(e);t=t.substring(0,e),this.data=this.nodeValue=t,this.length=t.length;var i=this.ownerDocument.createTextNode(s);return this.parentNode&&this.parentNode.insertBefore(i,this.nextSibling),i}},h(X,G),V.prototype={nodeName:"#comment",nodeType:_},h(V,G),Y.prototype={nodeName:"#cdata-section",nodeType:f},h(Y,G),Q.prototype.nodeType=v,h(Q,x),J.prototype.nodeType=S,h(J,x),K.prototype.nodeType=p,h(K,x),Z.prototype.nodeType=g,h(Z,x),ee.prototype.nodeName="#document-fragment",ee.prototype.nodeType=b,h(ee,x),te.prototype.nodeType=m,h(te,x),se.prototype.serializeToString=function(e,t,s){return ie.call(e,t,s)},x.prototype.toString=ie;try{if(Object.defineProperty){function ce(e){switch(e.nodeType){case c:case b:var t=[];for(e=e.firstChild;e;)7!==e.nodeType&&8!==e.nodeType&&t.push(ce(e)),e=e.nextSibling;return t.join("");default:return e.nodeValue}}Object.defineProperty(L.prototype,"length",{get:function(){return D(this),this.$$length}}),Object.defineProperty(x.prototype,"textContent",{get:function(){return ce(this)},set:function(e){switch(this.nodeType){case c:case b:for(;this.firstChild;)this.removeChild(this.firstChild);(e||String(e))&&this.appendChild(this.ownerDocument.createTextNode(e));break;default:this.data=e,this.value=e,this.nodeValue=e}}}),le=function(e,t,s){e["$$"+t]=s}}}catch(de){}t.DocumentType=Q,t.DOMException=I,t.DOMImplementation=k,t.Element=W,t.Node=x,t.NodeList=N,t.XMLSerializer=se},369:(e,t,s)=>{var i=s(539).freeze;t.XML_ENTITIES=i({amp:"&",apos:"'",gt:">",lt:"<",quot:'"'}),t.HTML_ENTITIES=i({lt:"<",gt:">",amp:"&",quot:'"',apos:"'",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",times:"×",divide:"÷",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",fnof:"ƒ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",bull:"•",hellip:"…",permil:"‰",prime:"′",Prime:"″",lsaquo:"‹",rsaquo:"›",oline:"‾",euro:"€",trade:"™",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦"}),t.entityMap=t.HTML_ENTITIES},716:(e,t,s)=>{var i=s(89);i.DOMImplementation,i.XMLSerializer,t.DOMParser=s(588).DOMParser},835:(e,t,s)=>{var i=s(539).NAMESPACE,r=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,n=new RegExp("[\\-\\.0-9"+r.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),o=new RegExp("^"+r.source+n.source+"*(?::"+r.source+n.source+"*)?$");function a(e,t){this.message=e,this.locator=t,Error.captureStackTrace&&Error.captureStackTrace(this,a)}function h(){}function l(e,t){return t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber,t}function c(e,t,s,r,n,o){function a(e,t,i){s.attributeNames.hasOwnProperty(e)&&o.fatalError("Attribute "+e+" redefined"),s.addValue(e,t,i)}for(var h,l=++t,c=0;;){var d=e.charAt(l);switch(d){case"=":if(1===c)h=e.slice(t,l),c=3;else{if(2!==c)throw new Error("attribute equal must after attrName");c=3}break;case"'":case'"':if(3===c||1===c){if(1===c&&(o.warning('attribute value must after "="'),h=e.slice(t,l)),t=l+1,!((l=e.indexOf(d,t))>0))throw new Error("attribute value no end '"+d+"' match");a(h,u=e.slice(t,l).replace(/&#?\w+;/g,n),t-1),c=5}else{if(4!=c)throw new Error('attribute value must after "="');a(h,u=e.slice(t,l).replace(/&#?\w+;/g,n),t),o.warning('attribute "'+h+'" missed start quot('+d+")!!"),t=l+1,c=5}break;case"/":switch(c){case 0:s.setTagName(e.slice(t,l));case 5:case 6:case 7:c=7,s.closed=!0;case 4:case 1:case 2:break;default:throw new Error("attribute invalid close char('/')")}break;case"":return o.error("unexpected end of input"),0==c&&s.setTagName(e.slice(t,l)),l;case">":switch(c){case 0:s.setTagName(e.slice(t,l));case 5:case 6:case 7:break;case 4:case 1:"/"===(u=e.slice(t,l)).slice(-1)&&(s.closed=!0,u=u.slice(0,-1));case 2:2===c&&(u=h),4==c?(o.warning('attribute "'+u+'" missed quot(")!'),a(h,u.replace(/&#?\w+;/g,n),t)):(i.isHTML(r[""])&&u.match(/^(?:disabled|checked|selected)$/i)||o.warning('attribute "'+u+'" missed value!! "'+u+'" instead!!'),a(u,u,t));break;case 3:throw new Error("attribute value missed!!")}return l;case"":d=" ";default:if(d<=" ")switch(c){case 0:s.setTagName(e.slice(t,l)),c=6;break;case 1:h=e.slice(t,l),c=2;break;case 4:var u=e.slice(t,l).replace(/&#?\w+;/g,n);o.warning('attribute "'+u+'" missed quot(")!!'),a(h,u,t);case 5:c=6}else switch(c){case 2:s.tagName;i.isHTML(r[""])&&h.match(/^(?:disabled|checked|selected)$/i)||o.warning('attribute "'+h+'" missed value!! "'+h+'" instead2!!'),a(h,h,t),t=l,c=1;break;case 5:o.warning('attribute space is required"'+h+'"!!');case 6:c=1,t=l;break;case 3:c=4,t=l;break;case 7:throw new Error("elements closed character '/' and '>' must be connected to")}}l++}}function d(e,t,s){for(var r=e.tagName,n=null,o=e.length;o--;){var a=e[o],h=a.qName,l=a.value;if((f=h.indexOf(":"))>0)var c=a.prefix=h.slice(0,f),d=h.slice(f+1),u="xmlns"===c&&d;else d=h,c=null,u="xmlns"===h&&"";a.localName=d,!1!==u&&(null==n&&(n={},g(s,s={})),s[u]=n[u]=l,a.uri=i.XMLNS,t.startPrefixMapping(u,l))}for(o=e.length;o--;){(c=(a=e[o]).prefix)&&("xml"===c&&(a.uri=i.XML),"xmlns"!==c&&(a.uri=s[c||""]))}var f;(f=r.indexOf(":"))>0?(c=e.prefix=r.slice(0,f),d=e.localName=r.slice(f+1)):(c=null,d=e.localName=r);var p=e.uri=s[c||""];if(t.startElement(p,d,r,e),!e.closed)return e.currentNSMap=s,e.localNSMap=n,!0;if(t.endElement(p,d,r),n)for(c in n)t.endPrefixMapping(c)}function u(e,t,s,i,r){if(/^(?:script|textarea)$/i.test(s)){var n=e.indexOf("</"+s+">",t),o=e.substring(t+1,n);if(/[&<]/.test(o))return/^script$/i.test(s)?(r.characters(o,0,o.length),n):(o=o.replace(/&#?\w+;/g,i),r.characters(o,0,o.length),n)}return t+1}function f(e,t,s,i){var r=i[s];return null==r&&((r=e.lastIndexOf("</"+s+">"))<t&&(r=e.lastIndexOf("</"+s)),i[s]=r),r<t}function g(e,t){for(var s in e)t[s]=e[s]}function p(e,t,s,i){if("-"===e.charAt(t+2))return"-"===e.charAt(t+3)?(r=e.indexOf("--\x3e",t+4))>t?(s.comment(e,t+4,r-t-4),r+3):(i.error("Unclosed comment"),-1):-1;if("CDATA["==e.substr(t+3,6)){var r=e.indexOf("]]>",t+9);return s.startCDATA(),s.characters(e,t+9,r-t-9),s.endCDATA(),r+3}var n=function(e,t){var s,i=[],r=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;r.lastIndex=t,r.exec(e);for(;s=r.exec(e);)if(i.push(s),s[1])return i}(e,t),o=n.length;if(o>1&&/!doctype/i.test(n[0][0])){var a=n[1][0],h=!1,l=!1;o>3&&(/^public$/i.test(n[2][0])?(h=n[3][0],l=o>4&&n[4][0]):/^system$/i.test(n[2][0])&&(l=n[3][0]));var c=n[o-1];return s.startDTD(a,h,l),s.endDTD(),c.index+c[0].length}return-1}function m(e,t,s){var i=e.indexOf("?>",t);if(i){var r=e.substring(t,i).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/);if(r){r[0].length;return s.processingInstruction(r[1],r[2]),i+2}return-1}return-1}function _(){this.attributeNames={}}a.prototype=new Error,a.prototype.name=a.name,h.prototype={parse:function(e,t,s){var r=this.domBuilder;r.startDocument(),g(t,t={}),function(e,t,s,r,n){function o(e){if(e>65535){var t=55296+((e-=65536)>>10),s=56320+(1023&e);return String.fromCharCode(t,s)}return String.fromCharCode(e)}function h(e){var t=e.slice(1,-1);return t in s?s[t]:"#"===t.charAt(0)?o(parseInt(t.substr(1).replace("x","0x"))):(n.error("entity not found:"+e),e)}function g(t){if(t>T){var s=e.substring(T,t).replace(/&#?\w+;/g,h);w&&y(T),r.characters(s,0,t-T),T=t}}function y(t,s){for(;t>=b&&(s=S.exec(e));)v=s.index,b=v+s[0].length,w.lineNumber++;w.columnNumber=t-v+1}var v=0,b=0,S=/.*(?:\r\n?|\n)|.*$/g,w=r.locator,P=[{currentNSMap:t}],E={},T=0;for(;;){try{var C=e.indexOf("<",T);if(C<0){if(!e.substr(T).match(/^\s*$/)){var I=r.doc,N=I.createTextNode(e.substr(T));I.appendChild(N),r.currentElement=N}return}switch(C>T&&g(C),e.charAt(C+1)){case"/":var L=e.indexOf(">",C+3),D=e.substring(C+2,L).replace(/[ \t\n\r]+$/g,""),R=P.pop();L<0?(D=e.substring(C+2).replace(/[\s<].*/,""),n.error("end tag name: "+D+" is not complete:"+R.tagName),L=C+1+D.length):D.match(/\s</)&&(D=D.replace(/[\s<].*/,""),n.error("end tag name: "+D+" maybe not complete"),L=C+1+D.length);var M=R.localNSMap,A=R.tagName==D;if(A||R.tagName&&R.tagName.toLowerCase()==D.toLowerCase()){if(r.endElement(R.uri,R.localName,D),M)for(var O in M)r.endPrefixMapping(O);A||n.fatalError("end tag name: "+D+" is not match the current start tagName:"+R.tagName)}else P.push(R);L++;break;case"?":w&&y(C),L=m(e,C,r);break;case"!":w&&y(C),L=p(e,C,r,n);break;default:w&&y(C);var k=new _,x=P[P.length-1].currentNSMap,B=(L=c(e,C,k,x,h,n),k.length);if(!k.closed&&f(e,L,k.tagName,E)&&(k.closed=!0,s.nbsp||n.warning("unclosed xml attribute")),w&&B){for(var $=l(w,{}),U=0;U<B;U++){var q=k[U];y(q.offset),q.locator=l(w,{})}r.locator=$,d(k,r,x)&&P.push(k),r.locator=w}else d(k,r,x)&&P.push(k);i.isHTML(k.uri)&&!k.closed?L=u(e,L,k.tagName,h,r):L++}}catch(e){if(e instanceof a)throw e;n.error("element parse error: "+e),L=-1}L>T?T=L:g(Math.max(C,T)+1)}}(e,t,s,r,this.errorHandler),r.endDocument()}},_.prototype={setTagName:function(e){if(!o.test(e))throw new Error("invalid tagName:"+e);this.tagName=e},addValue:function(e,t,s){if(!o.test(e))throw new Error("invalid attribute:"+e);this.attributeNames[e]=this.length,this[this.length++]={qName:e,value:t,offset:s}},length:0,getLocalName:function(e){return this[e].localName},getLocator:function(e){return this[e].locator},getQName:function(e){return this[e].qName},getURI:function(e){return this[e].uri},getValue:function(e){return this[e].value}},t.XMLReader=h,t.ParseError=a},204:e=>{"use strict";var t,s="object"==typeof Reflect?Reflect:null,i=s&&"function"==typeof s.apply?s.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)};t=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var r=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this)}e.exports=n,e.exports.once=function(e,t){return new Promise((function(s,i){function r(s){e.removeListener(t,n),i(s)}function n(){"function"==typeof e.removeListener&&e.removeListener("error",r),s([].slice.call(arguments))}p(e,t,n,{once:!0}),"error"!==t&&function(e,t,s){"function"==typeof e.on&&p(e,"error",t,s)}(e,r,{once:!0})}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function l(e,t,s,i){var r,n,o,l;if(a(s),void 0===(n=e._events)?(n=e._events=Object.create(null),e._eventsCount=0):(void 0!==n.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),n=e._events),o=n[t]),void 0===o)o=n[t]=s,++e._eventsCount;else if("function"==typeof o?o=n[t]=i?[s,o]:[o,s]:i?o.unshift(s):o.push(s),(r=h(e))>0&&o.length>r&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,l=c,console&&console.warn&&console.warn(l)}return e}function c(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,s){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:s},r=c.bind(i);return r.listener=s,i.wrapFn=r,r}function u(e,t,s){var i=e._events;if(void 0===i)return[];var r=i[t];return void 0===r?[]:"function"==typeof r?s?[r.listener||r]:[r]:s?function(e){for(var t=new Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}(r):g(r,r.length)}function f(e){var t=this._events;if(void 0!==t){var s=t[e];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function g(e,t){for(var s=new Array(t),i=0;i<t;++i)s[i]=e[i];return s}function p(e,t,s,i){if("function"==typeof e.on)i.once?e.once(t,s):e.on(t,s);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function r(n){i.once&&e.removeEventListener(t,r),s(n)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return h(this)},n.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var r="error"===e,n=this._events;if(void 0!==n)r=r&&void 0===n.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var h=n[e];if(void 0===h)return!1;if("function"==typeof h)i(h,this,t);else{var l=h.length,c=g(h,l);for(s=0;s<l;++s)i(c[s],this,t)}return!0},n.prototype.addListener=function(e,t){return l(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return l(this,e,t,!0)},n.prototype.once=function(e,t){return a(t),this.on(e,d(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,d(this,e,t)),this},n.prototype.removeListener=function(e,t){var s,i,r,n,o;if(a(t),void 0===(i=this._events))return this;if(void 0===(s=i[e]))return this;if(s===t||s.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(r=-1,n=s.length-1;n>=0;n--)if(s[n]===t||s[n].listener===t){o=s[n].listener,r=n;break}if(r<0)return this;0===r?s.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(s,r),1===s.length&&(i[e]=s[0]),void 0!==i.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,s,i;if(void 0===(s=this._events))return this;if(void 0===s.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete s[e]),this;if(0===arguments.length){var r,n=Object.keys(s);for(i=0;i<n.length;++i)"removeListener"!==(r=n[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},n.prototype.listeners=function(e){return u(this,e,!0)},n.prototype.rawListeners=function(e){return u(this,e,!1)},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},n.prototype.listenerCount=f,n.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},622:function(e){var t,s,i,r,n;t=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,i=/(?:\/|^)\.(?=\/)/g,r=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,n={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),!(t=t.trim())){if(!i.alwaysNormalize)return e;var r=n.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");return r.path=n.normalizePath(r.path),n.buildURLFromParts(r)}var o=n.parseURL(t);if(!o)throw new Error("Error trying to parse relative URL.");if(o.scheme)return i.alwaysNormalize?(o.path=n.normalizePath(o.path),n.buildURLFromParts(o)):t;var a=n.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var h=s.exec(a.path);a.netLoc=h[1],a.path=h[2]}a.netLoc&&!a.path&&(a.path="/");var l={scheme:a.scheme,netLoc:o.netLoc,path:null,params:o.params,query:o.query,fragment:o.fragment};if(!o.netLoc&&(l.netLoc=a.netLoc,"/"!==o.path[0]))if(o.path){var c=a.path,d=c.substring(0,c.lastIndexOf("/")+1)+o.path;l.path=n.normalizePath(d)}else l.path=a.path,o.params||(l.params=a.params,o.query||(l.query=a.query));return null===l.path&&(l.path=i.alwaysNormalize?n.normalizePath(o.path):o.path),n.buildURLFromParts(l)},parseURL:function(e){var s=t.exec(e);return s?{scheme:s[1]||"",netLoc:s[2]||"",path:s[3]||"",params:s[4]||"",query:s[5]||"",fragment:s[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(i,"");e.length!==(e=e.replace(r,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=n},47:(e,t)=>{"use strict";t.l=r;var s=2147483647;function i(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=r.prototype,t}function r(e,t,s){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return a(e)}return n(e,t,s)}function n(e,t,s){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!r.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var s=0|c(e,t),n=i(s),o=n.write(e,t);o!==s&&(n=n.slice(0,o));return n}(e,t);if(ArrayBuffer.isView(e))return h(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(_(e,ArrayBuffer)||e&&_(e.buffer,ArrayBuffer))return function(e,t,s){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(s||0))throw new RangeError('"length" is outside of buffer bounds');var i;i=void 0===t&&void 0===s?new Uint8Array(e):void 0===s?new Uint8Array(e,t):new Uint8Array(e,t,s);return i.__proto__=r.prototype,i}(e,t,s);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return r.from(n,t,s);var o=function(e){if(r.isBuffer(e)){var t=0|l(e.length),s=i(t);return 0===s.length||e.copy(s,0,0,t),s}if(void 0!==e.length)return"number"!=typeof e.length||y(e.length)?i(0):h(e);if("Buffer"===e.type&&Array.isArray(e.data))return h(e.data)}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return r.from(e[Symbol.toPrimitive]("string"),t,s);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function o(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function a(e){return o(e),i(e<0?0:0|l(e))}function h(e){for(var t=e.length<0?0:0|l(e.length),s=i(t),r=0;r<t;r+=1)s[r]=255&e[r];return s}function l(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function c(e,t){if(r.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||_(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var s=e.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===s)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return s;case"utf8":case"utf-8":return m(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*s;case"hex":return s>>>1;default:if(n)return i?-1:m(e).length;t=(""+t).toLowerCase(),n=!0}}function d(e,t,s,i){s=Number(s)||0;const r=e.length-s;i?(i=Number(i))>r&&(i=r):i=r;const n=t.length;let o;for(i>n/2&&(i=n/2),o=0;o<i;++o){const i=parseInt(t.substr(2*o,2),16);if(y(i))return o;e[s+o]=i}return o}function u(e,t,s,i){return p(m(t,e.length-s),e,s,i)}function f(e,t,s,i){return p(function(e){const t=[];for(let s=0;s<e.length;++s)t.push(255&e.charCodeAt(s));return t}(t),e,s,i)}function g(e,t,s,i){return p(function(e,t){let s,i,r;const n=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)s=e.charCodeAt(o),i=s>>8,r=s%256,n.push(r),n.push(i);return n}(t,e.length-s),e,s,i)}function p(e,t,s,i){let r;for(r=0;r<i&&!(r+s>=t.length||r>=e.length);++r)t[r+s]=e[r];return r}function m(e,t){var s;t=t||1/0;for(var i=e.length,r=null,n=[],o=0;o<i;++o){if((s=e.charCodeAt(o))>55295&&s<57344){if(!r){if(s>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(o+1===i){(t-=3)>-1&&n.push(239,191,189);continue}r=s;continue}if(s<56320){(t-=3)>-1&&n.push(239,191,189),r=s;continue}s=65536+(r-55296<<10|s-56320)}else r&&(t-=3)>-1&&n.push(239,191,189);if(r=null,s<128){if((t-=1)<0)break;n.push(s)}else if(s<2048){if((t-=2)<0)break;n.push(s>>6|192,63&s|128)}else if(s<65536){if((t-=3)<0)break;n.push(s>>12|224,s>>6&63|128,63&s|128)}else{if(!(s<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}}return n}function _(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function y(e){return e!=e}"undefined"!=typeof Symbol&&null!=Symbol.species&&r[Symbol.species]===r&&Object.defineProperty(r,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),r.from=function(e,t,s){return n(e,t,s)},r.prototype.__proto__=Uint8Array.prototype,r.__proto__=Uint8Array,r.alloc=function(e,t,s){return function(e,t,s){return o(e),e<=0?i(e):void 0!==t?"string"==typeof s?i(e).fill(t,s):i(e).fill(t):i(e)}(e,t,s)},r.allocUnsafe=function(e){return a(e)},r.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==r.prototype},r.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},r.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return r.alloc(0);var s;if(void 0===t)for(t=0,s=0;s<e.length;++s)t+=e[s].length;var i=r.allocUnsafe(t),n=0;for(s=0;s<e.length;++s){var o=e[s];if(_(o,Uint8Array)&&(o=r.from(o)),!r.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(i,n),n+=o.length}return i},r.byteLength=c,r.prototype._isBuffer=!0,r.prototype.copy=function(e,t,s,i){if(!r.isBuffer(e))throw new TypeError("argument should be a Buffer");if(s||(s=0),i||0===i||(i=this.length),t>=e.length&&(t=e.length),t||(t=0),i>0&&i<s&&(i=s),i===s)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(s<0||s>=this.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-s&&(i=e.length-t+s);var n=i-s;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,s,i);else if(this===e&&s<t&&t<i)for(var o=n-1;o>=0;--o)e[o+t]=this[o+s];else Uint8Array.prototype.set.call(e,this.subarray(s,i),t);return n},r.prototype.write=function(e,t,s,i){if(void 0===t)i="utf8",s=this.length,t=0;else if(void 0===s&&"string"==typeof t)i=t,s=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(s)?(s>>>=0,void 0===i&&(i="utf8")):(i=s,s=void 0)}const r=this.length-t;if((void 0===s||s>r)&&(s=r),e.length>0&&(s<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");let n=!1;for(;;)switch(i){case"hex":return d(this,e,t,s);case"utf8":case"utf-8":return u(this,e,t,s);case"ascii":case"latin1":case"binary":return f(this,e,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return g(this,e,t,s);default:if(n)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),n=!0}}},934:e=>{"use strict";function t(e,t){for(const s in t)Object.defineProperty(e,s,{value:t[s],enumerable:!0,configurable:!0});return e}e.exports=function(e,s,i){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");i||(i={}),"object"==typeof s&&(i=s,s=void 0),null!=s&&(i.code=s);try{return t(e,i)}catch(s){i.message=e.message,i.stack=e.stack;const r=function(){};return r.prototype=Object.create(Object.getPrototypeOf(e)),t(new r,i)}}},485:function(e,t,s){var i;!function(r){"use strict";function n(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function o(e,t,s,i,r,o){return n((a=n(n(t,e),n(i,o)))<<(h=r)|a>>>32-h,s);var a,h}function a(e,t,s,i,r,n,a){return o(t&s|~t&i,e,t,r,n,a)}function h(e,t,s,i,r,n,a){return o(t&i|s&~i,e,t,r,n,a)}function l(e,t,s,i,r,n,a){return o(t^s^i,e,t,r,n,a)}function c(e,t,s,i,r,n,a){return o(s^(t|~i),e,t,r,n,a)}function d(e,t){var s,i,r,o,d;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var u=1732584193,f=-271733879,g=-1732584194,p=271733878;for(s=0;s<e.length;s+=16)i=u,r=f,o=g,d=p,u=a(u,f,g,p,e[s],7,-680876936),p=a(p,u,f,g,e[s+1],12,-389564586),g=a(g,p,u,f,e[s+2],17,606105819),f=a(f,g,p,u,e[s+3],22,-1044525330),u=a(u,f,g,p,e[s+4],7,-176418897),p=a(p,u,f,g,e[s+5],12,1200080426),g=a(g,p,u,f,e[s+6],17,-1473231341),f=a(f,g,p,u,e[s+7],22,-45705983),u=a(u,f,g,p,e[s+8],7,1770035416),p=a(p,u,f,g,e[s+9],12,-1958414417),g=a(g,p,u,f,e[s+10],17,-42063),f=a(f,g,p,u,e[s+11],22,-1990404162),u=a(u,f,g,p,e[s+12],7,1804603682),p=a(p,u,f,g,e[s+13],12,-40341101),g=a(g,p,u,f,e[s+14],17,-1502002290),u=h(u,f=a(f,g,p,u,e[s+15],22,1236535329),g,p,e[s+1],5,-165796510),p=h(p,u,f,g,e[s+6],9,-1069501632),g=h(g,p,u,f,e[s+11],14,643717713),f=h(f,g,p,u,e[s],20,-373897302),u=h(u,f,g,p,e[s+5],5,-701558691),p=h(p,u,f,g,e[s+10],9,38016083),g=h(g,p,u,f,e[s+15],14,-660478335),f=h(f,g,p,u,e[s+4],20,-405537848),u=h(u,f,g,p,e[s+9],5,568446438),p=h(p,u,f,g,e[s+14],9,-1019803690),g=h(g,p,u,f,e[s+3],14,-187363961),f=h(f,g,p,u,e[s+8],20,1163531501),u=h(u,f,g,p,e[s+13],5,-1444681467),p=h(p,u,f,g,e[s+2],9,-51403784),g=h(g,p,u,f,e[s+7],14,1735328473),u=l(u,f=h(f,g,p,u,e[s+12],20,-1926607734),g,p,e[s+5],4,-378558),p=l(p,u,f,g,e[s+8],11,-2022574463),g=l(g,p,u,f,e[s+11],16,1839030562),f=l(f,g,p,u,e[s+14],23,-35309556),u=l(u,f,g,p,e[s+1],4,-1530992060),p=l(p,u,f,g,e[s+4],11,1272893353),g=l(g,p,u,f,e[s+7],16,-155497632),f=l(f,g,p,u,e[s+10],23,-1094730640),u=l(u,f,g,p,e[s+13],4,681279174),p=l(p,u,f,g,e[s],11,-358537222),g=l(g,p,u,f,e[s+3],16,-722521979),f=l(f,g,p,u,e[s+6],23,76029189),u=l(u,f,g,p,e[s+9],4,-640364487),p=l(p,u,f,g,e[s+12],11,-421815835),g=l(g,p,u,f,e[s+15],16,530742520),u=c(u,f=l(f,g,p,u,e[s+2],23,-995338651),g,p,e[s],6,-198630844),p=c(p,u,f,g,e[s+7],10,1126891415),g=c(g,p,u,f,e[s+14],15,-1416354905),f=c(f,g,p,u,e[s+5],21,-57434055),u=c(u,f,g,p,e[s+12],6,1700485571),p=c(p,u,f,g,e[s+3],10,-1894986606),g=c(g,p,u,f,e[s+10],15,-1051523),f=c(f,g,p,u,e[s+1],21,-2054922799),u=c(u,f,g,p,e[s+8],6,1873313359),p=c(p,u,f,g,e[s+15],10,-30611744),g=c(g,p,u,f,e[s+6],15,-1560198380),f=c(f,g,p,u,e[s+13],21,1309151649),u=c(u,f,g,p,e[s+4],6,-145523070),p=c(p,u,f,g,e[s+11],10,-1120210379),g=c(g,p,u,f,e[s+2],15,718787259),f=c(f,g,p,u,e[s+9],21,-343485551),u=n(u,i),f=n(f,r),g=n(g,o),p=n(p,d);return[u,f,g,p]}function u(e){var t,s="",i=32*e.length;for(t=0;t<i;t+=8)s+=String.fromCharCode(e[t>>5]>>>t%32&255);return s}function f(e){var t,s=[];for(s[(e.length>>2)-1]=void 0,t=0;t<s.length;t+=1)s[t]=0;var i=8*e.length;for(t=0;t<i;t+=8)s[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return s}function g(e){var t,s,i="0123456789abcdef",r="";for(s=0;s<e.length;s+=1)t=e.charCodeAt(s),r+=i.charAt(t>>>4&15)+i.charAt(15&t);return r}function p(e){return unescape(encodeURIComponent(e))}function m(e){return function(e){return u(d(f(e),8*e.length))}(p(e))}function _(e,t){return function(e,t){var s,i,r=f(e),n=[],o=[];for(n[15]=o[15]=void 0,r.length>16&&(r=d(r,8*e.length)),s=0;s<16;s+=1)n[s]=909522486^r[s],o[s]=1549556828^r[s];return i=d(n.concat(f(t)),512+8*t.length),u(d(o.concat(i),640))}(p(e),p(t))}function y(e,t,s){return t?s?_(t,e):g(_(t,e)):s?m(e):g(m(e))}void 0===(i=function(){return y}.call(t,s,t,e))||(e.exports=i)}()},422:e=>{const t={ANDROID_WEB:"android-web",IOS_WEB:"iOS-web",PC_NATIVE:"PC-native",PC_WEB:"PC-web"};var s={getNetType:function(){let e=(new RegExp("nettype\\/(\\w*)").exec(i())||[,""])[1].toLowerCase();if(!e&&navigator.connection){switch(navigator.connection.type){case"ethernet":e="ethernet";break;case"cellular":e="cellular";break;default:e="wifi"}}return e},getPlatform:function(){return s.isAndroid()?t.ANDROID_WEB:s.isIOS()?t.IOS_WEB:s.isElectron()?t.PC_NATIVE:t.PC_WEB},isX5:function(){return this.isAndroid()&&/\s(TBS|X5Core)\/[\w\.\-]+/i.test(i())},isPC:function(){return!n(r("os "))&&!n(r("android[/ ]"))},isIOS:function(){return n(r("os "))},isAndroid:function(){return n(r("android[/ ]"))},isIOSSafari:function(){return this.isIOS()&&this.isSafari()},isElectron:function(){return/electron/i.test(i())},isMobile:function(){return s.isAndroid()||s.isIOS()},isSafari:function(){return/^((?!chrome|android).)*safari/i.test(i())},isFirefox:function(){return/firefox/i.test(i())},isChrome:function(){return/chrome/i.test(i())},isLocalHost:function(){return"localhost"===location.hostname},device:t,getBrowser:function(){return s.isX5()?"X5":s.isChrome()?"Chrome":s.isFirefox()?"Firefox":s.isIOSSafari()?"iOS-Safari":s.isSafari()?"Mac-Safari":"Unknown"}};function i(){return navigator.userAgent.toLowerCase()}function r(e){return""+(new RegExp(e+"(\\d+((\\.|_)\\d+)*)").exec(i())||[,0])[1]||void 0}function n(e){return parseFloat((e||"").replace(/\_/g,"."))||0}e.exports=s},77:e=>{let t;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind(globalThis):e=>(t||(t=Promise.resolve())).then(e).catch((e=>setTimeout((()=>{throw e}),0)))}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,s),n.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var i={};return(()=>{"use strict";s.d(i,{default:()=>Zs});var e=s(622),t=s.n(e),r=s(47);const n="__sw_proxy__",o=64e3;function a(){return!0}function h(){return Date.parse(new Date)/1e3}function l(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}function c(e,t,s,i=2e3,r=!1){const o=new XMLHttpRequest;return new Promise(((a,h)=>{o.open("GET",e,!0),o.responseType="arraybuffer",o.timeout=i,o.onreadystatechange=e=>{if(4===o.readyState){const e=o.status;206===e?a(o.response):h(`status ${e}`)}},o.onerror=e=>{h("request error")},o.ontimeout=e=>{h("timeout")},o.setRequestHeader("Range",t||"bytes=0-0"),s&&s(o,e),r&&o.setRequestHeader(n,"bypass"),o.send()}))}function d(){if("undefined"==typeof window)return null;var e={RTCPeerConnection:window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCSessionDescription:window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,RTCIceCandidate:window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate};return e.RTCPeerConnection?e:null}function u(e){const t=r.l.from(e),s=new r.l(e.byteLength);return t.copy(s),s}function f(e,t){const s=e.byteLength-t,i=[];let n=t,a=Math.floor(s/o),h=s%o;for(let t=0;t<a;t++){const t=(0,r.l)(o);e.copy(t,0,n,n+o),i.push(t),n+=o}if(h>0){const t=(0,r.l)(h);e.copy(t,0,n,n+h),i.push(t)}return i}function g(e,t){if(e.size<=t)return;const s=[...e.keys()];do{e.delete(s.shift())}while(e.size>t)}function p(e,t){if(e.size<=t)return;const s=[...e.values()];do{e.delete(s.shift())}while(e.size>t)}function m(e){return e instanceof ArrayBuffer&&0!==e.byteLength}var _=s(204),y=s.n(_),v=s(77),b=s.n(v);const S=65536;function w(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}class P extends(y()){constructor(e){super(),this.channelName=e.initiator?e.channelName:null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||P.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},P.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||5e3,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=e.wrtc&&"object"==typeof e.wrtc?e.wrtc:d(),this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(e){return void b()((()=>this.destroy(e)))}this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this._needsNegotiation()}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}signal(e){if(!this.destroyed&&this._pc){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}if(e.renegotiate&&this.initiator&&this._needsNegotiation(),e.candidate)if(this._pc.remoteDescription&&this._pc.remoteDescription.type)try{this._addIceCandidate(e.candidate)}catch(e){}else this._pendingCandidates.push(e.candidate);e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{try{this._addIceCandidate(e)}catch(e){}})),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{this.destroy(e)})),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(new Error("signal() called with invalid signal data"))}}_addIceCandidate(e){const t=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch((e=>{var s;!t.address||t.address.endsWith(".local")?(s="Ignoring unsupported ICE candidate.",console.warn(s)):this.destroy(e)}))}send(e){if("string"==typeof e){RTCDataChannel.prototype.send.toString().includes("[native code]")&&this._channel.send(e)}else this._channel.send(e)}_needsNegotiation(){this._batchedNegotiation||(this._batchedNegotiation=!0,b()((()=>{this._batchedNegotiation=!1,!this.initiator&&this._firstNegotiation||this.negotiate(),this._firstNegotiation=!1})))}negotiate(){this.initiator?this._isNegotiating?this._queuedNegotiation=!0:setTimeout((()=>{this._createOffer()}),0):this._isNegotiating?this._queuedNegotiation=!0:this.emit("signal",{type:"renegotiate",renegotiate:!0}),this._isNegotiating=!0}destroy(e){this._destroy(e)}_destroy(e){this.destroyed||this.destroying||(this.destroying=!0,b()((()=>{if(this.destroyed=!0,this.destroying=!1,this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")})))}_setupData(e){if(!e.channel)return this.destroy(new Error("Data channel event is missing `channel` property"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=S),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=e=>{this.destroy(e)};let t=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1}),5e3)}get isBufferedAmountHigh(){return this._channel.bufferedAmount>S}write(e,t){if(this.destroyed)return t(new Error("cannot write after peer is destroyed"));if(this._connected){try{this.send(e)}catch(e){return this.destroy(e)}this.isBufferedAmountHigh?this._cb=t:t(null)}else this._chunk=e,this._cb=t}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=w(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(e)}))})).catch((e=>{this.destroy(e)}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=w(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(e)}))})).catch((e=>{this.destroy(e)}))}_onConnectionStateChange(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(new Error("Connection failed."))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(new Error("Ice connection failed.")),"closed"===e&&this.destroy(new Error("Ice connection closed."))}getStats(e){const t=e=>("[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length?this._pc.getStats().then((s=>{const i=[];s.forEach((e=>{i.push(t(e))})),e(null,i)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((s=>{if(this.destroyed)return;const i=[];s.result().forEach((e=>{const s={};e.names().forEach((t=>{s[t]=e.stat(t)})),s.id=e.id,s.type=e.type,s.timestamp=e.timestamp,i.push(t(s))})),e(null,i)}),(t=>e(t))):e(null,[])}_maybeReady(){if(this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this.getStats(((t,s)=>{if(this.destroyed)return;t&&(s=[]);const i={},r={},n={};let o=!1;s.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(i[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(r[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(n[e.id]=e)}));const a=e=>{o=!0;let t=r[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let s=i[e.remoteCandidateId];s&&(s.ip||s.address)?(this.remoteAddress=s.ip||s.address,this.remotePort=Number(s.port)):s&&s.ipAddress?(this.remoteAddress=s.ipAddress,this.remotePort=Number(s.portNumber)):"string"==typeof e.googRemoteAddress&&(s=e.googRemoteAddress.split(":"),this.remoteAddress=s[0],this.remotePort=Number(s[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4")};if(s.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&a(n[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&a(e)})),o||Object.keys(n).length&&!Object.keys(r).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.destroy(t)}this._chunk=null;const e=this._cb;this._cb=null,e(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this.emit("connect")}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>S||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._sendersAwaitingStable.forEach((e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._queuedNegotiation=!1,this._needsNegotiation()):this.emit("negotiated")),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=r.l.from(t)),this.emit("data",t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||this.destroy()}}P.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},P.channelConfig={};const E=P,T={DC_SIGNAL:"SIGNAL",DC_OPEN:"OPEN",DC_REQUEST:"REQUEST",DC_SEND_REQUEST:"SEND_REQUEST",DC_PIECE_NOT_FOUND:"PIECE_NOT_FOUND",DC_PIECE_ABORT:"PIECE_ABORT",DC_PIECE_CANCEL:"PIECE_CANCEL",DC_CLOSE:"CLOSE",DC_RESPONSE:"RESPONSE",DC_ERROR:"ERROR",DC_PIECE:"PIECE",DC_PIECE_DATA:"PIECE_DATA",DC_TIMEOUT:"TIMEOUT",DC_PIECE_ACK:"PIECE_ACK",DC_METADATA:"METADATA",DC_PLAT_ANDROID:"ANDROID",DC_PLAT_IOS:"IOS",DC_PLAT_WEB:"WEB",DC_CHOKE:"CHOKE",DC_UNCHOKE:"UNCHOKE",DC_HAVE:"HAVE",DC_HAVE_REVERSE:"HAVE_REVERSE",DC_LOST:"LOST",DC_GET_PEERS:"GET_PEERS",DC_PEERS:"PEERS",DC_STATS:"STATS",DC_PEER_SIGNAL:"PEER_SIGNAL",DC_PLAYLIST:"PLAYLIST",BM_LOST:"lost",BM_ADDED_SEG_:"BM_ADDED_SEG_",BM_ADDED_SN_:"BM_ADDED_SN_",BM_SEG_ADDED:"BM_SEG_ADDED",FRAG_CHANGED:"FRAG_CHANGED",FRAG_LOADED:"FRAG_LOADED",FRAG_LOADING:"FRAG_LOADING",RESTART_P2P:"RESTART_P2P",EXCEPTION:"exception",REQUESTING_MAP_HAVE:"REQUESTING_MAP_HAVE",BUILDER_MAP_HAVE:"BUILDER_MAP_HAVE",SYN_OUTPUT:"SYN_OUTPUT",SYN_ERROR:"SYN_ERROR",SYN_PARTIAL:"SYN_PARTIAL"};class C{constructor(e,t,s,i,r=0){this.sn=e,this.segId=t,this.data=s,this.fromPeerId=i,this.level=r||0}static fromSegment(e){const t=new C(e.sn,e.segId,e.data,e.fromPeerId,e.level);return t.from=e.from,t}get size(){return this.data.byteLength}get isSequential(){return this.sn>=0}}var I=s(422),N=s.n(I);class L extends(y()){static get defaultPacketSize(){return o}static get VERSION(){return"8"}constructor(e,t,s,i,r,n={}){super(),this.channel=e.fetcher.channelId,this.logger=e.logger,this.config=r,this.isInitiator=i,this.options=n,this.intermediator=n.intermediator||null,this.signalMsgs=[],this.assignPeerId(t,s),this.platform="unknown",this.super=!1,this.mobile=!1,this.mobileWeb=!1,this.mobileNet=!1,this.connected=!1,this.msgQueue=[],this.miss=0,this.notifySet=new Set,this.bufArr=[],this.packetSize=o,this.sendReqQueue=[],this.downloading=!1,this.uploading=!1,this.choked=!1,this.streamListeners=[],this.pieceMsg={},this.uploadInterrupter={targetSegId:void 0,currentSegId:void 0,canceled:!1},this.datasToSend=[],this.bytesUploaded=0,this.dataWriting=!1,this.timeSendRequest=0,this.timeReceivePiece=0,this.timeSendPiece=0,this.weight=0,this.peersConnected=1,this.uploadSpeed=0,this.gotPeers=!1,this.currentLevel=0,this.currentPos=0,this.useBackupSignal=!1,this.webRTCConfig={};const{stuns:a}=this.options;if(a&&a.length>0){const e=[];a.forEach((t=>{this.logger.info(`use stun ${t}`),e.push({urls:t})})),this.webRTCConfig.iceServers=e}this.config.webRTCConfig&&(this.webRTCConfig={...this.config.webRTCConfig,...this.webRTCConfig}),this.playlistMap=new Map,this._initPeerChannel(),this.notFatalClosed=!1,this.startSN=Number.MAX_SAFE_INTEGER,this.endSN=-1,this._loadedBytes=0}assignPeerId(e,t){this.remotePeerId=t,this.channelId=this.isInitiator?`${e}-${t}`:`${t}-${e}`,t&&(this.timeJoin=h(),this.dataExchangeTs=this.timeJoin,this.gotStatsTs=this.timeJoin,this._startTimer()),setTimeout((()=>{for(let e of this.signalMsgs)this.emit(T.DC_SIGNAL,e,!0)}),0)}_startTimer(){this.connTimeout=setTimeout((()=>{this.logger.warn(`dc ${this.channelId} connection timeout`),this.emit(T.DC_TIMEOUT)}),2e4)}get isAvailable(){return this.downloadNum<2&&!this.choked}get isAvailableUrgently(){return!this.downloading&&!this.choked}cancelDownload(e,t,s){if(s&&this.downloading&&!(this.streamListeners.length>0||this.remainAttachments<=2))return this.logger.info(`cancel download ${s} remain packets ${this.remainAttachments}`),this.timeReceivePiece=0,this.sendJson({event:T.DC_PIECE_CANCEL,sn:e,level:t,seg_id:s})}addStreamListener(e,t,s){this.streamListeners.push({handler:s,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_initPeerChannel(){const e=new E({initiator:this.isInitiator,trickle:this.options.trickle||!1,config:this.webRTCConfig});this._datachannel=e,e.on("error",(e=>{let t=!0;"Ice connection failed."===e.message&&this.notFatalClosed&&(t=!1),this.emit(T.DC_ERROR,t)})),e.on("signal",(e=>{this.signalMsgs.push(e),this.emit(T.DC_SIGNAL,e)}));e.on("connect",(()=>{for(this.logger.info(`datachannel CONNECTED to ${this.remotePeerId} from ${this.intermediator?"peer":"server"}`),this.connected=!0,clearTimeout(this.connTimeout),this.signalMsgs=[],this.emit(T.DC_OPEN);this.msgQueue.length>0;){let e=this.msgQueue.shift();this.emit(e.event,e)}})),e.on("data",(e=>{const{logger:t}=this;if("string"==typeof e){let s=JSON.parse(e);if(!s)return void t.error("dc received string is null");if(!this.connected)return void this.msgQueue.push(s);let i,r=s.event;switch(i=r!==T.DC_PLAYLIST&&r!==T.DC_PEER_SIGNAL?`string: ${e}`:`event: ${r}`,t.debug(`datachannel receive ${i} from ${this.remotePeerId}`),r){case T.DC_HAVE:if(this.emit(s.event,s),!s.sn)return;this.config.live||(s.sn<this.startSN&&(this.startSN=s.sn),s.sn>this.endSN&&(this.endSN=s.sn));break;case T.DC_PIECE:this.downloading=!0,this.dataExchangeTs=h(),this.timeReceivePiece=performance.now(),this.pieceMsg=s,this._prepareForBinary(s.attachments,s.seg_id,s.sn,s.size),this.emit(s.event,s);break;case T.DC_PIECE_CANCEL:this.uploadInterrupter.targetSegId=s.seg_id,this.emit(s.event,s);break;case T.DC_PIECE_NOT_FOUND:this._sendNextReq()||(this.downloading=!1),this.emit(s.event,s);break;case T.DC_REQUEST:this._handleRequestMsg(s);break;case T.DC_PIECE_ACK:this.uploadInterrupter.canceled||(this._handlePieceAck(s.size,s.miss),this.emit(s.event,s));break;case T.DC_STATS:this._handleStats(s);break;case T.DC_PLAYLIST:this.config.sharePlaylist&&this._handlePlaylist(s);break;case T.DC_METADATA:this._handleMetadata(s);break;case T.DC_PIECE_ABORT:this.downloading&&(this._notifyDownloadListenersAbort("aborted by upstream peer"),this.emit(T.DC_PIECE_ABORT,s));break;case T.DC_CHOKE:t.info(`choke peer ${this.remotePeerId}`),this.choked=!0;break;case T.DC_UNCHOKE:t.info(`unchoke peer ${this.remotePeerId}`),this.choked=!1;break;case T.DC_CLOSE:this.emit(s.event,s.fatal||!1);break;default:this.emit(s.event,s)}}else{if(!e)return void t.error("datachannel on data is undefined!");if(!this.downloading)return void t.warn(`peer not downloading, data size ${e.byteLength} pieceMsg ${JSON.stringify(this.pieceMsg)}`);this._handleBinaryMsg(e)}})),e.once("close",(()=>{this.emit(T.DC_CLOSE,!1)})),e.on("iceStateChange",((e,t)=>{"disconnected"===e&&(this.logger.warn(`${this.remotePeerId} disconnected`),this.connected=!1)}))}sendJson(e){e.event!==T.DC_PLAYLIST&&e.event!==T.DC_PEER_SIGNAL?this.logger.debug(`dc bufferSize ${this._datachannel.bufferSize} send ${JSON.stringify(e)} to ${this.remotePeerId}`):this.logger.debug(`dc send event ${e.event} to ${this.remotePeerId}`);const t=JSON.stringify(e);return t.length>o?(this.logger.error("string to send is too large"),!1):this.send(t,!1)}send(e,t=!0){return t?(this.datasToSend.push(e),this.dataWriting||this._sendDataSync(),!0):this.sendImmediately(e)}_checkIfNeedInterrupt(){const{targetSegId:e,currentSegId:t,canceled:s}=this.uploadInterrupter;return!!s||!(!e||e!==t)&&(this.logger.info("cancel send data"),this.sendMsgPieceAbort(`${t} transfer canceled`),this.datasToSend=[],this.uploadInterrupter.canceled=!0,this._handlePieceAck(this.bytesUploaded,0),this.emit(T.DC_PIECE_ACK,{seg_id:t,size:this.bytesUploaded,canceled:!0}),!0)}_sendDataSync(){if(this._checkIfNeedInterrupt()||0===this.datasToSend.length)return void(this.dataWriting=!1);this.dataWriting=!0;const e=this.datasToSend.shift();e?(this.bytesUploaded+=e.byteLength,this._datachannel.write(e,(e=>{if(e)return this.dataWriting=!1,this.logger.warn(e.message),void this.emit(T.DC_ERROR,!1);this._sendDataSync()}))):this.logger.error("sendDataSync data is undefined!")}sendImmediately(e){if(this._datachannel.connected)try{return this._datachannel.send(e),!0}catch(e){this.logger.warn(`datachannel ${this.channelId} send data failed, close it`),this.emit(T.DC_ERROR,!1)}return!1}sendMsgHave(e,t,s={}){const i=s.reverse||void 0;delete s.reverse,this.sendJson({event:i?T.DC_HAVE_REVERSE:T.DC_HAVE,sn:e,seg_id:t,...s})}sendPieceNotFound(e,t,s={}){this.uploading=!1,this.sendJson({event:T.DC_PIECE_NOT_FOUND,seg_id:t,sn:e,...s})}sendPeers(e){this.sendJson({event:T.DC_PEERS,peers:e})}sendPeersRequest(){this.sendJson({event:T.DC_GET_PEERS})}sendMsgStats(e,t={}){const s={event:T.DC_STATS,total_conns:e,...t};this.sendJson(s)}sendMsgPlaylist(e,t,s){const i=this.playlistMap.get(e);if(i&&i.seq>=s)return;const r={event:T.DC_PLAYLIST,url:e,data:t,seq:s};this.playlistMap.set(e,{data:t,seq:s}),this.sendJson(r)}sendMsgSignal(e,t,s){return this.sendJson({event:T.DC_PEER_SIGNAL,action:"signal",to_peer_id:e,from_peer_id:t,data:s})}sendMsgSignalReject(e,t,s,i=!1){return this.sendJson({event:T.DC_PEER_SIGNAL,action:"reject",to_peer_id:e,from_peer_id:t,reason:s,fatal:i})}sendMetaData(e,t,s,i=!1){this.isInitiator&&(this.timeSendRequest=performance.now()),this.sendJson({event:T.DC_METADATA,field:e,platform:T.DC_PLAT_WEB,mobile:!!N().isMobile(),mobile_net:i,channel:this.channel,version:"0.5.1",sequential:t,peers:s})}sendPartialBuffer(e,t,s={}){this.sendMsgPiece(e,s);for(let e=0;e<t.length;e++)this.send(t[e])}sendMsgPiece(e,t={}){const{targetSegId:s}=this.uploadInterrupter;if(s&&s===e.seg_id)return this.logger.info("cancel send piece msg"),this.sendMsgPieceAbort(`${s} piece canceled`),void(this.uploadInterrupter.canceled=!0);this.uploadInterrupter={currentSegId:e.seg_id,targetSegId:void 0,canceled:!1},this.datasToSend=[],this.bytesUploaded=0,e.ext||(e.ext={}),e.ext.from&&t.from&&(t.from=`${e.ext.from}->${t.from}`),t.incompletes&&e.ext.incompletes&&(t.incompletes+=e.ext.incompletes),t=Object.assign({},e.ext,t);const i={...e,ext:t};this.sendJson(i)}sendBuffer(e,t,s,i={}){const r=i.reverse||void 0;if(delete i.reverse,!s)return void this.logger.error("sendBuffer payload is undefined!");let n=s.byteLength,o=0,a=0;n%this.packetSize==0?a=n/this.packetSize:(a=Math.floor(n/this.packetSize)+1,o=n%this.packetSize);let h={event:T.DC_PIECE,attachments:a,seg_id:t,sn:e,level:i.level,size:n,reverse:r};delete i.level,this.sendMsgPiece(h,i);const l=function(e,t,s,i){let r=[];if(i){let n;for(let i=0;i<s-1;i++)n=e.slice(i*t,(i+1)*t),r.push(n);n=e.slice(e.byteLength-i,e.byteLength),r.push(n)}else{let i;for(let n=0;n<s;n++)i=e.slice(n*t,(n+1)*t),r.push(i)}return r}(s,this.packetSize,a,o);this._sendBufferArray(l,r),this.uploading=!1,this.timeSendPiece=performance.now()}get downloadNum(){return this.downloading?this.sendReqQueue.length+1:0}requestDataById(e,t,s=!1,i={}){const r={event:T.DC_REQUEST,seg_id:e,sn:t,...i,urgent:s};this.downloading?(this.logger.info(`${this.remotePeerId} add req ${e} in queue`),s?this.sendReqQueue.unshift(r):this.sendReqQueue.push(r)):this._realRequestData(r)}requestDataBySN(e,t=!1,s={}){const i={event:T.DC_REQUEST,sn:e,...s,urgent:t};this.downloading?(this.logger.info(`add req ${e} in queue`),t?this.sendReqQueue.unshift(i):this.sendReqQueue.push(i)):this._realRequestData(i)}_sendBufferArray(e,t=!1){const s=t?e.reverse():e;for(let e=0;e<s.length;e++)this.send(s[e])}_realRequestData(e){this.sendJson(e),this.timeSendRequest=performance.now(),this.downloading=!0,this.emit(T.DC_SEND_REQUEST)}shouldWaitForRemain(e){return 0!==this.bufArrSize&&(0!==this.timeReceivePiece&&this.currentLoadSpeed()>=this.minRequiredSpeed(e))}close(e){e||(this.notFatalClosed=!0),this.emit(T.DC_CLOSE,e)}receiveSignal(e){e&&this._datachannel.signal(e)}_notifyDownloadListenersAbort(e){for(let t of this.streamListeners){const{handler:s}=t;s(void 0,void 0,!0,e)}this.streamListeners=[]}destroy(e=!0){this.logger.info(`destroy datachannel ${this.channelId}`),this.chokeTimer&&clearTimeout(this.chokeTimer),this.connTimeout&&clearTimeout(this.connTimeout),this.uploading&&this.sendMsgPieceAbort("peer is closing"),this._notifyDownloadListenersAbort("upstream peer is closed");let t={event:T.DC_CLOSE,fatal:e};this.sendJson(t),this._datachannel.removeAllListeners(),this.removeAllListeners(),this._datachannel.destroy()}_handleBinaryMsg(e){const{attachments:t,level:s,reverse:i}=this.pieceMsg;this.listenerCount(T.DC_RESPONSE)>0&&this.bufArr.push(e),this._loadedBytes+=e.byteLength,this.remainAttachments--;let r=i?this.remainAttachments+1:t-this.remainAttachments;const n=0===this.remainAttachments;if(this.emit(T.DC_PIECE_DATA,this.bufSN,this.segId,e,r,n,this.pieceMsg),this.streamListeners.length>0)for(let t of this.streamListeners){const{handler:s}=t;s(this.bufSN,this.segId,!1,e,n)}if(n){if(this.streamListeners=[],this.timeSendRequest>0)if(this.super)this.weight=1;else{const e=this.expectedSize/(performance.now()-this.timeSendRequest);this.weight=this.weight>0?.6*this.weight+.4*e:e}this.sendJson({event:T.DC_PIECE_ACK,sn:this.bufSN,seg_id:this.segId,level:s,size:this.expectedSize,miss:this.miss||void 0}),this.timeSendRequest=0,this.timeReceivePiece=0,this._sendNextReq()||(this.downloading=!1),this._handleBinaryData(i)}}_sendNextReq(){if(this.sendReqQueue.length>0){const e=this.sendReqQueue.shift();return this.logger.info(`get msg from sendReqQueue ${JSON.stringify(e)}`),this._realRequestData(e),!0}return!1}_handlePlaylist(e){const{url:t,data:s,seq:i}=e;this.playlistMap.set(t,{data:s,seq:i})}getLatestPlaylist(e,t){if(!this.playlistMap.has(e))return null;const s=this.playlistMap.get(e);return s.seq<=t||s.seq>t+2?null:s}_handleMetadata(e){const{logger:t}=this;if(this.isInitiator){const e=performance.now()-this.timeSendRequest;e>0&&(this.weight=1e5/e,t.info(`handle Metadata from ${this.remotePeerId} initial weight ${this.weight}`)),this.timeSendRequest=0}const s=e.channel;if(this.channel!==s)return t.error(`peer channel ${s} not matched!`),void this.emit(T.DC_ERROR,!0);if(e.super){t.info(`got super peer ${this.remotePeerId}`),this.super=!0;const{token:s}=this.config;if(s&&e.token!==s)return t.warn(`super peer token ${e.token} not matched!`),void this.emit(T.DC_ERROR,!0)}switch(e.platform){case T.DC_PLAT_ANDROID:this.platform=T.DC_PLAT_ANDROID;break;case T.DC_PLAT_IOS:this.platform=T.DC_PLAT_IOS;break;case T.DC_PLAT_WEB:this.platform=T.DC_PLAT_WEB}if(this.mobile=e.mobile||!1,this.mobileNet=e.mobile_net||!1,this.mobileWeb=this.mobile&&this.platform===T.DC_PLAT_WEB||!1,this.sequential=e.sequential,t.info(`${this.remotePeerId} platform ${this.platform} sequential ${this.sequential}`),e.peers&&(this.peersConnected+=e.peers,t.info(`${this.remotePeerId} now has ${this.peersConnected} peers`)),this.emit(T.DC_METADATA,e),e.field&&!this.config.live&&e.sequential){const{field:t}=e;if(Array.isArray(t))this._handleField(t);else for(let e in t)this._handleField(t[e])}}_handleField(e){e.forEach((e=>{e>=0&&(e<this.startSN&&(this.startSN=e),e>this.endSN&&(this.endSN=e))}))}_handleStats(e){this.gotStatsTs=h();const t=e.total_conns;t>0&&this.peersConnected!==t&&(this.peersConnected=t,this.logger.info(`${this.remotePeerId} now has ${this.peersConnected} peers`)),e.level&&(this.currentLevel=e.level),e.pos&&(this.currentPos=e.pos)}_handleRequestMsg(e){if(this.dataExchangeTs=h(),this.uploading)return this.logger.warn(`${this.remotePeerId} is uploading when receive request`),void this.sendPieceNotFound(e.sn,e.seg_id,{level:e.level});this.uploading=!0,this.emit(T.DC_REQUEST,e)}_handlePieceAck(e,t){0!==this.timeSendPiece&&(this.uploadSpeed=Math.round(e/(performance.now()-this.timeSendPiece)*2),this.timeSendPiece=0,this.logger.info(`${this.remotePeerId} uploadSpeed is ${this.uploadSpeed}`)),t>0&&this.logger.warn(`peer ${this.remotePeerId} miss ${t}`)}_prepareForBinary(e,t,s,i){this.bufArr=[],this._loadedBytes=0,this.remainAttachments=e,this.segId=t,this.bufSN=s,this.expectedSize=i}_handleBinaryData(e=!1){if(this.listenerCount(T.DC_RESPONSE)>0){e&&this.bufArr.reverse();let t=r.l.concat(this.bufArr);const s=t.byteLength;if(s===this.expectedSize){let e=t.buffer;const s=new C(this.bufSN,this.segId,e,this.remotePeerId,this.pieceMsg.level);this.emit(T.DC_RESPONSE,s,this.weight)}else this.logger.error(`${this.segId} expectedSize ${this.expectedSize} != byteLength ${s}`)}this.segId="",this.bufArr=[]}checkIfNeedChoke(e=!1){const{logger:t}=this,s=performance.now()-this.timeSendRequest;if(!e&&s<1500)t.info(`duration ${s} no need choke`);else if(this.miss++,t.info(`${this.remotePeerId} miss ${this.miss}`),this.miss>2&&!this.choked){this.choked=!0;const e=30*this.miss;e<=150?(t.warn(`datachannel ${this.channelId} is choked`),this.chokeTimer=setTimeout((()=>{this.choked=!1,t.warn(`datachannel ${this.channelId} is unchoked`)}),1e3*e)):t.warn(`datachannel ${this.channelId} is choked permanently`)}}get bufArrSize(){return this.downloading?this.pieceMsg.attachments-this.remainAttachments:0}loadtimeout(){const{logger:e,pieceMsg:t}=this;return e.warn(`timeout while downloading from ${this.remotePeerId}, ${this.bufArrSize} of ${t.attachments} packets loaded`),this.checkIfNeedChoke(),!0}sendMsgPieceAbort(e){(this.uploading||0!==this.datasToSend.length)&&(this.uploading=!1,this.sendJson({event:T.DC_PIECE_ABORT,reason:e}))}loadedBytes(){return this._loadedBytes}currentLoadSpeed(){return 0===this.timeReceivePiece?0:this.loadedBytes()/(performance.now()-this.timeReceivePiece)}minRequiredSpeed(e){return(this.pieceMsg.size-this.loadedBytes())/e}}const D=L;var R=s(485),M=s.n(R),A=s(934),O=s.n(A);const k=e=>{const t=localStorage.getItem(e);try{const e=JSON.parse(t);return e.value?e.value:e}catch(e){return t}},x=(e,t,s)=>{((e,t)=>{"object"==typeof t&&(t=JSON.stringify(t)),localStorage.setItem(e,t)})(e,{value:t,duration:s,startTime:Date.now()})};class B{constructor(){this.p2p=0,this.share=0,this.http=0}recordP2p(e){this.p2p+=e}recordShare(e){this.share+=e}recordHttp(e){this.http+=e}resetTraffic(){this.p2p=0,this.share=0,this.http=0}get healthRatio(){if(0===this.http)return 1e3;let e=Math.round((this.p2p+this.share)/this.http*100);return e<=0&&(e=1),e}}const $=window.atob("Ly9wcm8uaXAtYXBpLmNvbS9qc29uP2ZpZWxkcz0yMTgxODI2JmtleT1YT3BpYW5zUmdZeEdUaG8="),U="SW_GEOIP_KEY",q="TRACKER_EXPT",z="IPAPI_ERROR",F="ZXU",H="uY2R",W="LmNv",j="uYnll",G="bQ==",X="aGsuc3d",V="hcm1j",Y="bG91ZC",Q="5uZXQ=",J=Symbol("httpDownloaded"),K=Symbol("p2pDownloaded"),Z=Symbol("p2pUploaded");class ee extends(y()){constructor(e,s,i,r,n){let o;super(),this.config=e.config;let a=this.config.announceLocation;switch(this.config.trackerZone&&(a=this.config.trackerZone),a){case"cn":case"eu":o=F+H+j+W+G;break;case"hk":o=X+V+Y+Q;break;case"us":o="dXMuaGR0dmNsb3VkLmNvbQ=="}this.engine=e,this.key=s||void 0,this.baseUrl=r||`https://${window.atob(o)}/v1`,this.channelId=window.btoa(i),this.timestamp=h(),this.health=new B;const l=t().parseURL(this.baseUrl).netLoc;this.announce=l.replace(/\/\//,"");const c=function(e,t,s,i,r,n){let o=location.hostname;"localhost"===o&&n&&(o=`${n}.${o}`);function a(e,t,s,i,r,n){return M()(e+t+s+i+r,n)}const h=a(o,t,s,i,r,e);return h.substr(0,8)}(this.timestamp,"0.5.1",this.announce,this.channelId,n.type,this.key);this.native=!!n.bundle,this.announceInfo={...n,channel:this.channelId,ts:this.timestamp,version:"0.5.1",v:c,announce:this.announce,token:this.key},this.announceURL=`${this.baseUrl}/channel`,this.reportFails=0,this.statsRequesting=!1,this.forbidden=!1,this.failConns=0,this.totalHTTPDownloaded=0,this.totalP2PDownloaded=0,this.totalP2PUploaded=0,this[J]=0,this[K]=0,this[Z]=0,this.speed=0,this.offline=!1,this.errsBufStalled=0,this.mediaRequests=0,this.errsInternalExpt=0}geoipRequest(){const{logger:e}=this.engine;return new Promise(((t,s)=>{if((e=>{const t=localStorage.getItem(e);try{const e=JSON.parse(t);return!(!e.duration||!e.startTime)&&Date.now()-e.startTime<e.duration}catch(e){return!1}})(U)){const s=k(U);e.info("found local geo data"),t(s)}else fetch($).then((e=>e.json())).then((e=>{if("success"!==e.status){const t=new Error(`preflight status ${e.status}`);throw O()(t,z)}{const s=e.mobile?432e5:2592e5;x(U,e,s),t(e)}})).catch((e=>{s(e)}))}))}btAnnouncePreflight(){const{logger:e}=this.engine;return this.announceInfo.asn?this.btAnnounce():(e.info("preflight ip-api"),Promise.race([this.geoipRequest(),new Promise(((e,t)=>{setTimeout((()=>{t(O()(new Error("request timeout"),z))}),600)}))]).then((e=>(this._parseGeoResponse(e),this.btAnnounce()))).catch((t=>{if(t.code!==q){const t=k(U);return t&&(e.info("use expired ipData"),this._parseGeoResponse(t)),this.btAnnounce()}throw t})))}_parseGeoResponse(e){const{lat:t,lon:s,isp:i,as:r,mobile:n,countryCode:o,continentCode:a}=e;n&&(this.announceInfo.netType="cellular");const h=r.split(" ")[0].substr(2);this.announceInfo={...this.announceInfo,lat:t,lon:s,isp:i,asn:h,country:o}}btAnnounce(){const{logger:e}=this.engine;return this.announceInfo.tag||(this.announceInfo.tag=`${(0,I.getBrowser)()}${location.protocol.startsWith("https")?"s":""}`),new Promise(((t,s)=>{fetch(this.announceURL,{headers:this._requestHeader,method:"POST",body:JSON.stringify(this.announceInfo)}).then((e=>{if(!e.ok){const t=e.status>=500&&e.status<600;throw O()(new Error(`server response code is ${e.status}`),q,{retry:t})}return e.json()})).then((e=>{if(!this.engine)throw O()(new Error("runtime error"),q,{retry:!1});const s=e.data;if(s.f&&(this.forbidden=!0),-1===e.ret){const{code:t,msg:s}=e.data;throw O()(new Error(s),q,{retry:t>=5e3})}s.info&&console.info(`${s.info}`),s.warn&&console.warn(`${s.warn}`),s.min_conns||(s.min_conns=8),(!s.rejected||s.rejected&&s.share_only)&&s.id&&s.report_interval&&s.peers?(this.peerId=this.id=s.id,s.report_interval<20&&(s.report_interval=20),this.btStats(s.report_interval),this.getPeersURL=`${this.baseUrl}/channel/${this.channelId}/node/${this.peerId}/peers`,this.statsURL=`${this.baseUrl}/channel/${this.channelId}/node/${this.peerId}/stats`,t(s)):this.engine&&(this.engine.p2pEnabled=!1)})).catch((t=>{e.error(`btAnnounce error ${t}`),s(O()(t,t.code,{retry:t.retry}))}))}))}btStats(e=10){this.heartbeater=setInterval((()=>{this.postStats()}),1e3*e)}postStatsWithBeacon(){if(this.offline)return;this.offline=!0;let e={off:!0};this.statsRequesting||(e={...e,...this._makeStatsBody()}),this.statsURL&&navigator.sendBeacon&&navigator.sendBeacon(this.statsURL,JSON.stringify(e))}postStats(){const{logger:e}=this.engine;this.statsRequesting=!0,fetch(this.statsURL,{method:"POST",body:JSON.stringify(this._makeStatsBody())}).then((e=>(this.statsRequesting=!1,this.reportFails=0,e.text()))).then((t=>{let s;if(s=t?JSON.parse(t):{ret:0,data:{}},-1===s.ret)clearInterval(this.heartbeater),e.error(`${s.data.msg} code ${s.data.code}`),this.engine.emit(T.RESTART_P2P);else{const{http:e=0,p2p:t=0,share:s=0,failConns:i=0,rebuffers:r=0,requests:n=0,errsInternalExpt:o=0}=this.lastStats||{};this[J]>=e&&(this[J]-=e),this[K]>=t&&(this[K]-=t),this[Z]>=s&&(this[Z]-=s),this.failConns>=i&&(this.failConns-=i),this.errsBufStalled>=r&&(this.errsBufStalled-=r),this.mediaRequests>=n&&(this.mediaRequests-=n),this.errsInternalExpt>=o&&(this.errsInternalExpt-=o),this.exptMsg&&(this.exptMsg=void 0)}})).catch((t=>{e.error(`btStats error ${t}`),this.statsRequesting=!1,this.reportFails++,this.reportFails>=3&&clearInterval(this.heartbeater)}))}btGetPeers(e,t=!1){const{logger:s}=this.engine,{asn:i,country:r}=this.announceInfo;let n={exclusions:e,asn:i,country:r,ratio:this.health.healthRatio,urgent:t||void 0},o={};return this.engine.getExtraForPeersRequest&&(o=this.engine.getExtraForPeersRequest()),n=Object.assign({},n,o),new Promise(((e,t)=>{this.reportFails>=3?t(new Error("reportFails >= 3")):fetch(this.getPeersURL,{headers:this._requestHeader,method:"POST",body:JSON.stringify(n)}).then((e=>e.json())).then((s=>{-1===s.ret?t(s.data.msg):e(s.data)})).catch((e=>{s.error(`btGetPeers error ${e}`),t(e)})).finally((()=>{this.health.resetTraffic()}))}))}increFailConns(){this.failConns++}increRebuffers(){this.errsBufStalled++}increMediaRequests(){this.mediaRequests++}reportFlow(e){const t=Math.round(e/1024);this[J]+=t,this.totalHTTPDownloaded+=t,this.health.recordHttp(t),this._emitStats()}reportDCTraffic(e,t){const s=Math.round(e/1024);this[K]+=s,this.totalP2PDownloaded+=s,this.health.recordP2p(s),this.speed=Math.round(t),this._emitStats()}reportUploaded(e=0){const t=Math.round(e/1024);this.totalP2PUploaded+=t,this.health.recordShare(t),this[Z]+=t,this._emitStats()}destroy(){const{logger:e}=this.engine;e.warn("destroy fetcher"),this.removeAllListeners(),clearInterval(this.heartbeater)}_emitStats(){this.engine.emit("stats",{totalHTTPDownloaded:this.totalHTTPDownloaded,totalP2PDownloaded:this.totalP2PDownloaded,totalP2PUploaded:this.totalP2PUploaded,p2pDownloadSpeed:this.speed});const e=this.config.getStats;e&&"function"==typeof e&&e(this.totalP2PDownloaded,this.totalP2PUploaded,this.totalHTTPDownloaded,this.speed)}_makeStatsBody(){const{asn:e,country:t}=this.announceInfo;let s={totalConns:this.engine.tracker.totalConns,failConns:this.failConns,rebuffers:this.errsBufStalled||void 0,requests:this.mediaRequests||void 0,errsInternalExpt:this.errsInternalExpt,http:Math.round(this[J])||0,p2p:Math.round(this[K])||0,share:Math.round(this[Z])||0,asn:e,country:t},i={};return this.engine.getExtraForStats&&(i=this.engine.getExtraForStats()),s=Object.assign({},s,i),this.lastStats=JSON.parse(JSON.stringify(s)),Object.keys(s).forEach((e=>{0===s[e]&&delete s[e]})),this.exptMsg&&(s.exptMsg="0.5.1 "+this.exptMsg),s}get _requestHeader(){let e={};return this.native&&(e={...e,token:this.key,"User-Agent":"electron",appid:this.announceInfo.bundle}),e}}const te=ee;var se=function(e,t){return se=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])},se(e,t)};function ie(e,t){function s(){this.constructor=e}se(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}function re(e,t){var s="function"==typeof Symbol&&e[Symbol.iterator];if(!s)return e;var i,r,n=s.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(e){r={error:e}}finally{try{i&&!i.done&&(s=n.return)&&s.call(n)}finally{if(r)throw r.error}}return o}function ne(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(re(arguments[t]));return e}var oe=function(e,t){this.target=t,this.type=e},ae=function(e){function t(t,s){var i=e.call(this,"error",s)||this;return i.message=t.message,i.error=t,i}return ie(t,e),t}(oe),he=function(e){function t(t,s,i){void 0===t&&(t=1e3),void 0===s&&(s="");var r=e.call(this,"close",i)||this;return r.wasClean=!0,r.code=t,r.reason=s,r}return ie(t,e),t}(oe),le=function(){if("undefined"!=typeof WebSocket)return WebSocket},ce={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1};const de=function(){function e(e,t,s){var i=this;void 0===s&&(s={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){i._debug("open event");var t=i._options.minUptime,s=void 0===t?ce.minUptime:t;clearTimeout(i._connectTimeout),i._uptimeTimeout=setTimeout((function(){return i._acceptOpen()}),s),i._ws.binaryType=i._binaryType,i._messageQueue.forEach((function(e){return i._ws.send(e)})),i._messageQueue=[],i.onopen&&i.onopen(e),i._listeners.open.forEach((function(t){return i._callEventListener(e,t)}))},this._handleMessage=function(e){i._debug("message event"),i.onmessage&&i.onmessage(e),i._listeners.message.forEach((function(t){return i._callEventListener(e,t)}))},this._handleError=function(e){i._debug("error event",e.message),i._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),i.onerror&&i.onerror(e),i._debug("exec error listeners"),i._listeners.error.forEach((function(t){return i._callEventListener(e,t)})),i._connect()},this._handleClose=function(e){i._debug("close event"),i._clearTimeouts(),i._shouldReconnect&&i._connect(),i.onclose&&i.onclose(e),i._listeners.close.forEach((function(t){return i._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=s,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,s=void 0===t?ce.maxEnqueuedMessages:t;this._messageQueue.length<s&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,s,i=this._listeners[e.type];if(i)try{for(var r=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],s=0;return t?t.call(e):{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}}}(i),n=r.next();!n.done;n=r.next()){var o=n.value;this._callEventListener(e,o)}}catch(e){t={error:e}}finally{try{n&&!n.done&&(s=r.return)&&s.call(r)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,ne(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,s=void 0===t?ce.reconnectionDelayGrowFactor:t,i=e.minReconnectionDelay,r=void 0===i?ce.minReconnectionDelay:i,n=e.maxReconnectionDelay,o=void 0===n?ce.maxReconnectionDelay:n,a=0;return this._retryCount>0&&(a=r*Math.pow(s,this._retryCount-1))>o&&(a=o),this._debug("next delay",a),a},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,s=t.maxRetries,i=void 0===s?ce.maxRetries:s,r=t.connectionTimeout,n=void 0===r?ce.connectionTimeout:r,o=t.WebSocket,a=void 0===o?le():o;if(this._retryCount>=i)this._debug("max retries reached",this._retryCount,">=",i);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(h=a)||!h||2!==h.CLOSING)throw Error("No valid WebSocket class provided");var h;this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled||(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new a(t,e._protocols):new a(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout((function(){return e._handleTimeout()}),n))}))}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new ae(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new he(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}();class ue extends(y()){constructor(e,t){super(),this.logger=e,t.startsWith("wss")?this.addr=t.replace("wss","https"):t.startsWith("ws")&&(this.addr=t.replace("ws","http")),this.connected=!1,this.retryCount=0,this.closed=!1,this.msgQueue=[],this.posting=!1}start(){this.closed=!1,this._hello((()=>{this._longPolling()}))}_hello(e){fetch(this.addr+"&hello",{method:"POST"}).then((e=>{if(!e.ok)throw new Error("hello response was not ok");return e.json()})).then((t=>{this.connected=!0,e(),this.onopen&&this.onopen(t.ver)})).catch((e=>{this.closed=!0,this.onerror&&this.onerror(e)}))}send(e){this.msgQueue.push(e),this.posting||this._realSend([...this.msgQueue])}_realSend(e){0!==e.length&&(this.posting=!0,this.msgQueue=[],fetch(this.addr,{method:"POST",body:JSON.stringify(e)}).then((()=>{this.posting=!1,this.msgQueue.length>0&&this._realSend([...this.msgQueue])})).catch((e=>{this.logger.error(e),this.posting=!1})))}close(){this.connected&&(this.closed=!0,this.connected=!1,this.abortController&&this.abortController.abort(),this.onclose&&this.onclose())}destroy(){this.close(),this.removeAllListeners()}_longPolling(){if(this.closed)return;this.abortController=new AbortController;const e=this.abortController.signal;fetch(this.addr,{signal:e}).then((e=>{if(!e.ok)throw new Error("polling response was not ok");return e.text()})).then((e=>{e&&this.onmessage&&this.onmessage(JSON.parse(e)),this.retryCount=0,this._longPolling()})).catch((e=>{this.connected&&(this.retryCount<=3?(this.retryCount++,this._longPolling()):(this.connected=!1,this.onerror&&this.onerror(e)))}))}}class fe extends(y()){constructor(e,t,s,i,r="main"){super(),this.logger=e,this.config=t,this.wsAddr=s,this.serverVersion=0,this.pingInterval=i||60,this.name=r,this.pollingClient=new ue(e,s);try{this._ws=this._init()}catch(t){e.error(t),this._startPolling()}}_init(){const e={maxRetries:this.config.wsMaxRetries,minReconnectionDelay:l(1e4,6e4),maxReconnectionDelay:6e5,maxEnqueuedMessages:20};let t=new de(this.wsAddr,void 0,e);return t.addEventListener("open",(()=>{this.logger.info(`signal ${this.name} ${this.wsAddr} connection opened`),this.pollingClient.connected?this.pollingClient.close():(this.onopen&&this.onopen(),this._startPing(this.pingInterval))})),t.push=t.send,t.send=e=>{let s=JSON.stringify(e);t.push(s)},t.addEventListener("message",(e=>{let t=e.data;const s=JSON.parse(t),i=s.action;if("pong"!==i){if("ver"!==i)return"close"===i?(this.logger.warn(`server close signal ${this.name} reason ${s.reason}`),void this.close()):void(this.onmessage&&this.onmessage(s,this.name));this.serverVersion=s.ver}else clearTimeout(this.pongTimer)})),t.addEventListener("close",(e=>{this.logger.warn(`signal ${this.name} ${this.wsAddr} closed ${e.code} ${e.reason}`),e.code>=5e3||e.code<4e3?(this.onclose&&this.onclose(),this._stopPing()):this.close()})),t.addEventListener("error",(e=>{this._stopPing(),this.onerror&&this.onerror(e),this._startPolling()})),t}_startPolling(){this.pollingClient.connected||(this.logger.info("start polling"),this.pollingClient.start(),this._setupPolling(this.pollingClient))}sendSignal(e,t){const s={action:"signal",to_peer_id:e,data:t};this._send(s)}sendReject(e,t,s){const i={action:"reject",to_peer_id:e,reason:t,fatal:s};this._send(i)}_send(e){this.pollingClient.connected?this.pollingClient.send(e):this._ws&&this._ws.send(e)}_startPing(e=120){this.connected&&(this.pingTimer=setInterval((()=>{const e={action:"ping"};this._ws&&this._ws.send(e),this.serverVersion>=22&&this._waitForPong()}),1e3*e))}_waitForPong(){this.pongTimer=setTimeout((()=>{this.logger.warn(`signal ${this.name} wait for pong timeout, reconnect`),this.close(),this.reconnect()}),15e3)}_resetPing(){this._stopPing(),this._startPing(this.pingInterval)}_stopPing(){clearInterval(this.pingTimer),clearTimeout(this.pongTimer),this.pingTimer=null,this.pongTimer=null}close(){this.logger.info(`close signal ${this.name}`),this._stopPing(),(()=>{this._ws&&this._ws.close(1e3,"normal close")})(),this.pollingClient.close()}reconnect(){this._ws&&(this.logger.info(`reconnect signal ${this.name}`),this._ws.reconnect())}destroy(){this.close(),this._ws=null,this.removeAllListeners(),this.pollingClient.destroy()}get connected(){return!!this.pollingClient.connected||this._connected}get _connected(){return!!this._ws&&this._ws.readyState===de.OPEN}_setupPolling(e){e.onopen=e=>{e&&(this.serverVersion=e),this.logger.info("polling opened"),this.onopen&&this.onopen()},e.onerror=e=>{this._connected||this.onerror&&this.onerror(e)},e.onclose=()=>{this._connected||this.onclose&&this.onclose()},e.onmessage=e=>{if(this.onmessage)for(let t of e)this.onmessage(t,this.name)}}}const ge=fe,pe=class extends(y()){constructor(e,t,s,i){super(),this.logger=e,this.config=t,this.mainAddr=s,this.backupAddr=i,this.mainWS=this._init(s),this.backupTimer=setTimeout((()=>{this.destroyed||(this.backupWS=this._init(i,"backup"))}),900),this._connected=!1,this.destroyed=!1}_init(e,t){if(!e)return null;let s=new ge(this.logger,this.config,e,270,t);return s.onopen=()=>{!this._connected&&this.onopen&&(this._connected=!0,this.onopen())},s.onmessage=e=>{this.onmessage&&this.onmessage(e,s.name)},s.onclose=()=>{this._connected&&!this.connected&&this.onclose&&(this._connected=!1,this.onclose())},s.onerror=e=>{this.onerror&&this.onerror(e)},s}sendSignal(e,t,s){if(s){const i=this._getWSByName(s);i&&i.sendSignal(e,t)}else this.mainConnected?this.mainWS.sendSignal(e,t):this.backupConnected?this.backupWS.sendSignal(e,t):this.logger.warn("no signal available")}sendReject(e,t,s,i){if(i){const r=this._getWSByName(i);if(r)return void r.sendReject(e,t,s)}this.mainConnected?this.mainWS.sendReject(e,t,s):this.backupConnected?this.backupWS.sendReject(e,t,s):this.logger.warn("no signal available, send reject failed")}close(){this.mainWS&&this.mainWS.close(),this.backupWS&&this.backupWS.close()}_getWSByName(e){return this.mainWS&&this.mainWS.name===e?this.mainWS:this.backupWS&&this.backupWS.name===e?this.backupWS:null}reconnect(){this.mainWS&&this.mainWS.reconnect(),this.backupWS&&this.backupWS.reconnect()}destroy(){this.close(),clearTimeout(this.backupTimer),this.mainWS=null,this.backupWS=null,this.removeAllListeners(),this.destroyed=!0}get connected(){return this.mainConnected||this.backupConnected}get mainConnected(){return this.mainWS&&this.mainWS.connected}get backupConnected(){return this.backupWS&&this.backupWS.connected}};const me=function(e,t,s=40){var i=null,r=!1,n=s;return function(s=!1){if(s)return clearTimeout(i),void(r=!1);r||(r=!0,i=setTimeout((function(){e.call(t,n),r=!1,i=null}),1e3*n),n*=1.1)}};class _e{constructor(e,t,s=15){this.engine=e,this.config=t,this.trickle=t.waitForPeer,this.poolSize=s,this.pool=[];for(let e=0;e<s;e++)this.pool.push(this._createPeer());this.timer=setTimeout((()=>{this.destroy()}),2e4)}_createPeer(){return new D(this.engine,void 0,void 0,!0,this.config,{trickle:this.trickle})}get size(){return this.pool.length}getPeer(){return 0===this.size?this._createPeer():this.pool.shift()}destroy(){for(let e of this.pool)e.destroy(!0);this.pool=[],clearTimeout(this.timer)}}class ye extends(y()){constructor(e,t,s,i){super(),this.engine=e,this.logger=e.logger,this.config=i,this.connected=!1,this.scheduler=s,this.sequential=this.scheduler.sequential,this.DCMap=new Map,this.failedDCSet=new Set,this.notFoundDCSet=new Set;const r=N().isMobile();this.peerPool=new _e(e,i,r?10:15),this.signalerWs=null,this.fetcher=t,this.peers=[],this.minConns=5,this.stuns=[],this.requestMorePeers=me(this._requestMorePeers,this),this.maxConns=r?13:22,this.maxConnsActive=r?8:12,this.peersIncrement=0,this.gotPeersFromTracker=!1,this.fuseRate=-1,this.overloaded=!1}get totalConns(){return this.scheduler.peersNum+1}resumeP2P(){if(!this.fetcher)return;const{engine:e,config:t,fetcher:s}=this,{btAnnounce:i,btAnnouncePreflight:r}=s,{wsSignalerAddr:n,wifiOnly:o,geoIpPreflight:a,getPeerId:h}=t;(a?r:i).call(s).then((t=>{if(!this.scheduler)return;e.peerId=this.peerId=t.id,this.minConns=t.min_conns;const i=t.peers;this.scheduler.notifyPeersLoaded(i.length),e.netType=s.announceInfo.netType,(t.wifi_only||o)&&e.isMobileNet&&(this.scheduler.downloadOnly=!0,this.logger.info("downloadOnly mode")),t.overload&&(this.overloaded=!0,this.logger.warn("server is overloaded, degrade"));const r=n.main;let a=n.backup;t.signal&&!t.signal2&&(a=void 0),this.signalerWs=this._initSignalerWs(t.signal||r,t.signal2||a,t.token,t.token2),0===i.length?this.requestMorePeers():this.peers=this._filterPeers(i),e.emit("peerId",this.peerId),h&&"function"==typeof h&&h(this.peerId),t.stun&&t.stun.length>0&&(this.stuns=t.stun),t.debug&&this.logger.enableDebug(),t.fuse_rate&&(this.fuseRate=t.fuse_rate),this.logger.info(`announce request response ${JSON.stringify(t,null,2)}`)})).catch((t=>{if(this.scheduler&&("TRACKER_EXPT"===t.code&&e.emit(T.EXCEPTION,t),this.scheduler.notifyPeersLoaded(0),t.retry)){const e=l(15e3,4e4);this.logger.warn(`announce retry after ${e}ms`),this.announceTimer=setTimeout((()=>{this.resumeP2P()}),e)}}))}stopP2P(){this.fetcher.postStatsWithBeacon(),this.fetcher.destroy(),this.fetcher=null,this.requestMorePeers(!0),this.scheduler.destroy(),this.scheduler=null,this.signalerWs&&(this.signalerWs.destroy(),this.signalerWs=null),this.peers=[];for(let e of this.DCMap.values())e.destroy(!0);this.DCMap.clear(),this.peerPool.destroy(),this.peerPool=null,this.failedDCSet.clear(),this.notFoundDCSet.clear(),this.logger.warn("tracker stop p2p")}destroy(){this.stopP2P(),this.removeAllListeners(),clearTimeout(this.announceTimer);const{config:e}=this;e.getStats=e.getPeerId=e.getPeersInfo=null,this.logger.warn("destroy tracker")}_filterPeers(e){const t=[],s=[...this.DCMap.keys(),...this.failedDCSet.keys(),this.peerId];return e.filter((e=>!s.includes(e.id))).forEach((e=>{t.push({id:e.id,intermediator:e.intermediator})})),t}_tryConnectToAllPeers(){if(0!==this.peers.length&&this.signalerWs.connected)for(this.logger.info(`try connect to ${this.peers.length} peers`);this.peers.length>0&&!(this.DCMap.size>=this.maxConnsActive);){let e=this.peers.shift();const t=e.intermediator;this.logger.debug(`new DataChannel ${e.id} intermediator ${t}`),this._createDatachannel(e.id,!0,t)}}_setupDC(e){e.on(T.DC_SIGNAL,((t,s)=>{const i=e.remotePeerId;if(e.intermediator){const s=this.DCMap.get(e.intermediator);if(s){if(s.sendMsgSignal(i,this.peerId,t))return;this.logger.warn(`intermediator ${e.intermediator} relay failed`)}}this.signalerWs.sendSignal(i,t,e.signalName)})).on(T.DC_PEER_SIGNAL,(t=>{const s=t.to_peer_id,i=t.from_peer_id,r=t.action;if(s&&i&&r)if(s!==this.peerId){this.logger.info(`relay signal for ${i}`);const n=this.DCMap.get(s);if(n){if("signal"!==r)return void n.sendMsgSignalReject(s,i,t.reason,t.fatal);if(n.sendMsgSignal(s,i,t.data))return}e.sendMsgSignal(i,s)}else"signal"===r?this._handleSignalMsg(i,t,e.remotePeerId):this._handSignalRejected(i,t)})).on(T.DC_GET_PEERS,(()=>{const t=h(),s=this.scheduler.getPeers().filter((e=>e.peersConnected<(e.mobileWeb?13:22)&&!e.super));if(s&&s.length>0){const i=[];s.forEach((s=>{if(s.remotePeerId===e.remotePeerId||s.remotePeerId===this.peerId)return;if(!this.config.live&&(s.currentPos-e.currentPos>600||s.currentPos<e.currentPos))return;t-s.timeJoin>50&&i.push({id:s.remotePeerId})})),this.logger.info(`send ${i.length} peers to ${e.remotePeerId}`),e.sendPeers(i)}})).on(T.DC_PEERS,(t=>{e.gotPeers=!0;const s=t.peers;if(s&&s.length>0&&this.scheduler.peersNum<10){const t=5;this.logger.info(`receive ${s.length} peers from ${e.remotePeerId}`),s.forEach((t=>{t.intermediator=e.remotePeerId})),this.peers=this._filterPeers(s).slice(0,t),this._tryConnectToAllPeers()}})).once(T.DC_ERROR,(t=>{this.logger.info(`datachannel ${e.channelId} failed fatal ${t}`),this.scheduler&&(this.scheduler.deletePeer(e),this._destroyAndDeletePeer(e.remotePeerId,t),this.requestMorePeers(),this.fetcher&&(e.connected||t&&this.fetcher.increFailConns(),t&&this.failedDCSet.add(e.remotePeerId),this._doSignalFusing(this.scheduler.peersNum),this._tryConnectToAllPeers()))})).once(T.DC_TIMEOUT,(()=>{this.notFoundDCSet.add(e.remotePeerId)})).once(T.DC_CLOSE,(t=>{this.logger.info(`datachannel ${e.channelId} closed fatal ${t}`),this.scheduler&&(this.scheduler.deletePeer(e),this._doSignalFusing(this.scheduler.peersNum)),this._destroyAndDeletePeer(e.remotePeerId,t),t&&this.failedDCSet.add(e.remotePeerId),this.requestMorePeers(),this._tryConnectToAllPeers()})).once(T.DC_OPEN,(()=>{e.isInitiator&&this.scheduler.handshakePeer(e)})).once(T.DC_METADATA,(t=>{const{scheduler:s}=this;e.isInitiator||s.handshakePeer(e),s.handleMetaData(e,t);const i=this.DCMap.size>=this.minConns+3;this.requestMorePeers(i),this.peersIncrement++,this._doSignalFusing(s.peersNum+1)}))}_doSignalFusing(e){if(this.fuseRate<=0)return;const t=this.signalerWs.connected;t&&e>=this.fuseRate+2?(this.logger.warn("reach fuseRate, report stats close signaler"),this.totalConns-1>0&&this.fetcher.postStats(),this.signalerWs.close()):!t&&e<this.fuseRate&&(this.logger.warn("low conns, reconnect signaler"),this.signalerWs.reconnect())}_initSignalerWs(e,t,s,i){const r=(e,t)=>{let s=`${e}?id=${this.peerId}&p=web&v=0.5.1`;return t&&(s=`${s}&token=${t}`),s};let n,o=r(e,s);if(!this.overloaded&&t&&t!==e){let e=r(t,i);n=new pe(this.logger,this.config,o,e)}else n=new ge(this.logger,this.config,o,270);return n.onopen=()=>{this.connected=!0,this.engine.emit("serverConnected",!0),this._tryConnectToAllPeers()},n.onmessage=(e,t)=>{let s=e.action;const i=e.from_peer_id||e.from;if(i)switch(s){case"signal":this._handleSignalMsg(i,e,null,t);break;case"reject":this._handSignalRejected(i,e);break;default:this.logger.warn(`Signal websocket unknown action ${s}`)}else this.logger.warn("fromPeerId is missed")},n.onclose=()=>{this.connected=!1,this.engine.emit("serverConnected",!1)},n.onerror=e=>{e.message&&this.engine.emit(T.EXCEPTION,O()(e,"SIGNAL_EXPT"))},n}_handSignalRejected(e,t){this.logger.warn(`signaling ${e} rejected, reason ${t.reason}`);const s=this.DCMap.get(e);s&&!s.connected&&(s.destroy(t.fatal),this.DCMap.delete(e)),this.requestMorePeers(),t.fatal&&this.failedDCSet.add(e),this._tryConnectToAllPeers()}_handleSignalMsg(e,t,s,i){if(!this.scheduler)return;const{logger:r}=this;if(t.data){if(this.failedDCSet.has(e))return void this._sendSignalReject(e,`peer ${e} in blocked list`,s,i,!0);this._handleSignal(e,t.data,s,i)}else{const t=this.DCMap.get(e);if(!t)return;if(this.signalerWs.backupConnected&&t&&t.signalMsgs.length>0&&"main"===i&&!t.useBackupSignal){t.useBackupSignal=!0,t.signalName="backup",r.warn(`${e} not found from main, try backup signal`);for(let s of t.signalMsgs)this.signalerWs.sendSignal(e,s,"backup");return}if(t.useBackupSignal)return;this._destroyAndDeletePeer(e),r.info(`signaling ${e} not found`);const{scheduler:n}=this;n.waitForPeer&&(n.waitingPeers--,0===n.waitingPeers&&n.notifyPeersLoaded(0)),this.requestMorePeers(),this._tryConnectToAllPeers(),s||this.notFoundDCSet.add(e)}}_handleSignal(e,t,s,i){const r=t.type,{logger:n}=this;let o=this.DCMap.get(e);if(o){if(o.connected)return void n.info("datachannel had connected, signal ignored");if("offer"===r){if(!(this.peerId>e))return void n.warn(`signal type wrong ${r}, ignored`);this._destroyAndDeletePeer(e,!1),n.warn(`signal type wrong ${r}, convert to non initiator`),o=this._createDatachannel(e,!1,s)}}else{if("answer"===r){const t=`signal type wrong ${r}`;return n.warn(t),this._sendSignalReject(e,t,s,i),void this._destroyAndDeletePeer(e,!1)}if(n.debug(`receive node ${e} connection request`),this.DCMap.size>=this.maxConns){const t=`peers reach limit ${this.maxConns}`;return n.warn(t),void this._sendSignalReject(e,t,s,i)}o=this._createDatachannel(e,!1,s)}o&&(i&&(o.signalName=i),o.receiveSignal(t))}_createDatachannel(e,t,s){if(!this.engine.fetcher)return;let i;if(t&&this.peerPool.size>0)i=this.peerPool.getPeer(),this.logger.info(`get peer from pool, signal size ${i.signalMsgs.length}`),i.intermediator=s,i.assignPeerId(this.peerId,e);else{let r=this.config.trickleICE;s||this.overloaded&&(r=!1),i=new D(this.engine,this.peerId,e,t,this.config,{stuns:this.stuns,intermediator:s,trickle:r})}return this.DCMap.set(e,i),this._setupDC(i),i}_sendSignalReject(e,t,s,i,r){if(s){const i=this.DCMap.get(s);if(i&&i.sendMsgSignalReject(e,this.peerId,t,r))return}this.signalerWs.sendReject(e,t,r,i)}_requestMorePeers(e){if(!this.fetcher)return;const{logger:t}=this;t.info(`requestMorePeers after delay ${e}`);const s=this.scheduler.peersNum,i=this.peersIncrement;this.peersIncrement=0,s>=this.minConns||(0===s||i<=3&&!this.gotPeersFromTracker&&!this.overloaded?(this.failedDCSet.size>50&&(this.failedDCSet=new Set([...this.failedDCSet].slice(-50))),this.notFoundDCSet.size>20&&(this.notFoundDCSet=new Set([...this.notFoundDCSet].slice(-20))),this.fetcher.btGetPeers([...this.DCMap.keys(),...this.failedDCSet.keys(),...this.notFoundDCSet.keys()],0===s).then((e=>{e&&e.peers&&(t.info(`requestMorePeers resp ${JSON.stringify(e,null,2)}`),this.peers=this._filterPeers(e.peers),this._tryConnectToAllPeers())})).catch((e=>{t.error(`requestMorePeers error ${e}`)})),this.gotPeersFromTracker=!0):s<this.maxConnsActive&&(this.scheduler.requestPeers(),this.gotPeersFromTracker=!1))}_destroyAndDeletePeer(e,t=!0){const s=this.DCMap.get(e);return!!s&&(s.destroy(t),this.DCMap.delete(e),!0)}}const ve=ye;let be={wsMaxRetries:10,p2pEnabled:!0,wifiOnly:!1,memoryCacheLimit:{pc:419430400,mobile:104857600},dcDownloadTimeout:25,logLevel:"error",tag:"",webRTCConfig:{},token:void 0,appName:void 0,appId:void 0,prefetchNum:5,showSlogan:!0,trickleICE:!0,announceLocation:"eu",trackerZone:void 0,geoIpPreflight:!0,getStats:function(e,t,s){},getPeerId:function(e){},getPeersInfo:function(e){}};const Se=be;const we=class{constructor(){this.peerMap=new Map}isEmpty(){return 0===this.peerMap.size}size(){return this.peerMap.size}clear(){this.peerMap.clear()}getPeers(){return[...this.peerMap.values()]}getPeerValues(){return this.peerMap.values()}hasPeer(e){return this.peerMap.has(e)}addPeer(e,t){this.peerMap.set(e,t)}getPeerIds(){return[...this.peerMap.keys()]}removePeer(e){this.peerMap.delete(e)}getPeersOrderByWeight(){const e=this.getAvailablePeers();return e.sort(((e,t)=>0===t.weight?1:0===e.weight?-1:t.weight-e.weight)),e}getPeer(e){return this.peerMap.get(e)}getAvailablePeers(){return this.getPeers().filter((e=>e.isAvailableUrgently))}},Pe=1,Ee=2,Te=3,Ce=4;class Ie{constructor(e){this.generator=e,this.status=Pe,this.next=this.next.bind(this)}next(e){if(this.status===Ce)return console.warn("status is canceled");if(this.status===Ee)return console.warn("status is waiting");const t=this.execute.bind(this,this.cb);this.nextInfo=this.generator(t),this.status=Ee,this.nextInfo.execute(e)}execute(e,t){this.status=Te,e.apply(t,[this.next])}cancel(){this.status=Ce,this.nextInfo&&"function"==typeof this.nextInfo.cancel&&this.nextInfo.cancel()}start(e,t){if("function"!=typeof e)throw new SyntaxError("param cb must be a function");this.cb=e,this.next(t)}continue(e){this.status=Pe,this.next(e)}}const Ne=Symbol("shareOnly");class Le extends(y()){constructor(e,t){super(),this.engine=e,this.config=t,this.logger=e.logger,this.bufMgr=null,this.peerManager=new we,this._setupEngine&&this._setupEngine(),this.startCheckConnsTimer(),this.dcDownloadTimeout=t.dcDownloadTimeout,this[Ne]=!1,this.downloadOnly=!1,this.loadedPeerNum=0}get isMobileNet(){return this.engine.isMobileNet}startCheckConnsTimer(){this.checkConnsTimer=setInterval((()=>{this.logger.info("start check conns");const e=this.getStatsForPeer();let t=this.peersNum;const s=h();this.getPeers().forEach((i=>{t>4&&(s-i.dataExchangeTs>120||s-i.gotStatsTs>=83)?(this.logger.warn(`close dead or different level peer ${i.remotePeerId} level ${i.currentLevel}`),i.close(!1),t--):i.connected&&i.sendMsgStats(t,e)}))}),4e4)}getStatsForPeer(){return{}}requestPeers(){this.logger.info("request peers from peer");const e={event:T.DC_GET_PEERS};for(let t of this.getPeers())t.mobileNet||t.super||t.sendJson(e)}chokePeerRequest(e){const t={event:T.DC_CHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}unchokePeerRequest(e){const t={event:T.DC_UNCHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}stopRequestFromPeers(){for(let e of this.getPeers())e.choked=!0}resumeRequestFromPeers(){for(let e of this.getPeers())e.choked=!1}setShareOnly(){this[Ne]=!0}deletePeer(e){this.peerManager.hasPeer(e.remotePeerId)&&this.peerManager.removePeer(e.remotePeerId),this._peersStats(this.peerManager.getPeerIds())}getPeers(){return[...this.peerManager.getPeerValues()]}addPeer(e){const{logger:t}=this;this.peerManager.addPeer(e.remotePeerId,e),this[Ne]&&(e.choked=!0);const s=this.peerManager.getPeerIds();this._peersStats(s),t.info(`add peer ${e.remotePeerId}, now has ${s.length} peers`),!e.mobileNet&&!this.waitForPeer&&e.isInitiator&&this.peersNum<=5&&e.peersConnected>1&&e.sendPeersRequest()}get hasPeers(){return this.peersNum>0}get peersNum(){return this.peerManager.size()}get hasIdlePeers(){const{logger:e}=this,t=this.getIdlePeer().length;if(e.info(`peers: ${this.peersNum} idle peers: ${t}`),t<this.peersNum){const t=this.peerManager.getPeers(),s=t.filter((e=>e.downloading));e.warn(`downloading: ${s.length} choked: ${t.filter((e=>e.choked)).length}`);for(let t of s)e.warn(`${t.remotePeerId} loading ${t.segId} packets ${t.bufArr.length} total ${t.pieceMsg.attachments}`)}return t>0}getIdlePeer(){return this.peerManager.getAvailablePeers()}set bufferManager(e){this.bufMgr=e,e.on(T.BM_LOST,(({sn:e,segId:t,next:s,level:i})=>{this.config.live||this._broadcastToPeers({event:T.DC_LOST,sn:e,seg_id:t,level:i||void 0}),this.onBufferManagerLost(e,t,s,i)})).on(T.BM_SEG_ADDED,(e=>{this.onBufferManagerSegAdded(e)}))}onBufferManagerSegAdded(e){}destroy(){const{logger:e}=this;this.peersNum>0&&this.peerManager.clear(),this.removeAllListeners(),clearInterval(this.checkConnsTimer),this.checkTimer&&this.checkTimer.cancel(),e.warn("destroy BtScheduler")}notifyPeersLoaded(e){}_setupDC(e){const{logger:t}=this;e.on(T.DC_PIECE_ACK,(s=>{s.size&&(this.engine.fetcher.reportUploaded(s.size),t.info(`uploaded ${s.seg_id} size ${s.size} to ${e.remotePeerId}, canceled ${s.canceled||!1}`))})).on(T.DC_PIECE_ABORT,(s=>{t.warn(`peer ${e.remotePeerId} download aborted, reason ${s.reason}`),e.downloading&&this._handlePieceAborted&&this._handlePieceAborted(e.remotePeerId),e.downloading=!1})).on(T.DC_REQUEST,(()=>{})).on(T.DC_SEND_REQUEST,(()=>{}))}_broadcastToPeers(e){for(let t of this.getPeers())t.sendJson(e)}_peersStats(e){this.engine.emit("peers",e);const t=this.engine.config.getPeersInfo;t&&"function"==typeof t&&t(e)}startCheckPeersTimer(e=3e3){this.checkTimer=new Ie((function(e){let t;return{execute:function(s=1e3){t=setTimeout(e,s)},cancel:function(){clearTimeout(t)}}})),this.checkTimer.start((e=>{this.checkPeers();const t=1e3*(0===(s=this.loadedPeerNum)?3:.5*s+1.67);var s;this.logger.debug(`loaded peers ${this.loadedPeerNum} nextDelay ${t}`),this.loadedPeerNum=0,e(t)}),e)}}const De=Le;class Re extends(y()){constructor(e,t,s=!0){super(),this.isSequential=s,this.logger=t.logger;const i=e.browserInfo.device;this.maxBufSize=i===N().device.PC_WEB||i===N().device.PC_NATIVE?t.memoryCacheLimit.pc:t.memoryCacheLimit.mobile,t.live&&(this.maxBufSize=36700160),this._segPool=new Map,this._currBufSize=0,this.id2Sn=new Map,this.overflowed=!1}get currBufSize(){return this._currBufSize}hasSegOfId(e){if(this.isSequential){const t=this.id2Sn.get(e);return this._segPool.has(t)}return this._segPool.has(e)}hasSegOfSN(e){return!!this.isSequential&&this._segPool.has(e)}_calSegPoolSize(){let e=0;return this._segPool.forEach((t=>{e+=t.size})),e}putSeg(e){if(this._currBufSize>=1.5*this.maxBufSize&&(this._currBufSize=this._calSegPoolSize(),this._currBufSize>=1.5*this.maxBufSize&&(this.clear(),this.overflowed=!1)),this.isSequential){if(this._segPool.has(e.sn))return;this._addSequentialSeg(e)}else{if(this._segPool.has(e.segId))return;this._addUnsequentialSeg(e)}}_addSequentialSeg(e){const{logger:t}=this,{segId:s,sn:i,size:r}=e;this.id2Sn.set(s,i),this._segPool.set(i,e),this._currBufSize+=parseInt(r);const n=this._segPool.size;if(this.emit(`${T.BM_ADDED_SN_}${e.sn}`,e),this.emit(T.BM_SEG_ADDED,e),this._currBufSize<this.maxBufSize||n<=5)return;let o=Array.from(this._segPool.keys()).sort(((e,t)=>e-t)),a=0;do{if(a++>10){console.error("too much loops in SegmentCache");break}const e=o.shift();if(void 0===e){t.error("lastSN not found");continue}const s=o[0],i=this._segPool.get(e);if(!i){t.error("lastSeg not found");continue}const r=i.size;this._currBufSize-=parseInt(r),this._segPool.delete(e),this.id2Sn.delete(i.segId),t.info(`pop seg ${e} size ${r} currBufSize ${this._currBufSize}`),this.overflowed||(this.overflowed=!0),this.emit(T.BM_LOST,{sn:e,segId:i.segId,next:s,level:i.level})}while(this._currBufSize>=this.maxBufSize&&this._segPool.size>5)}_addUnsequentialSeg(e){const{logger:t}=this,{segId:s,size:i}=e;this._segPool.set(s,e),this._currBufSize+=parseInt(i),this.emit(`${T.BM_ADDED_SEG_}${e.segId}`,e),this.emit(T.BM_SEG_ADDED,e);let r=0;for(;this._currBufSize>=this.maxBufSize&&this._segPool.size>5;){if(r++>10){console.error("too much loops in SegmentCache");break}const e=[...this._segPool.values()].shift(),s=e.segId,i=e.size;this._currBufSize-=parseInt(i),t.info(`pop seg ${s} size ${i}`),this._segPool.delete(s),this.overflowed||(this.overflowed=!0),this.emit(T.BM_LOST,{sn:-1,segId:s,level:e.level})}}getSegById(e){if(this.isSequential){const t=this.id2Sn.get(e);return this._segPool.get(t)}return this._segPool.get(e)}getSegIdBySN(e){const t=this._segPool.get(e);return t?t.segId:null}getSegBySN(e){if(this.isSequential)return this._segPool.get(e);throw new Error("fatal error in SegmentCache")}clear(){this.logger.warn("clear segment cache"),this._segPool.clear(),this.id2Sn.clear(),this._currBufSize=0}destroy(){this.clear(),this.removeAllListeners()}}const Me=Re,Ae={debug:0,info:1,warn:2,error:3,none:4};const Oe=class{constructor(e){this.logLevel=e,this.onlineDebug=!1;try{console.debug=console.log}catch(e){}"debug"!==e&&"info"!==e||(this.logLevel="warn"),!0===e?this.logLevel="warn":!1===e?this.logLevel="none":e in Ae||(this.logLevel="error"),this.resetLogger()}enableDebug(){this.onlineDebug=!0;for(let e in Ae)this[e]=console[e]}resetLogger(){this.onlineDebug=!1;for(let e in Ae)Ae[e]<Ae[this.logLevel]?this[e]=a:this[e]=console[e]}get isDebugLevel(){return Ae[this.logLevel]<=2||this.onlineDebug}},ke={DPlayer:"dplayer",CBPlayer:"cbplayer",jwplayer:"jwplayer",videojs:"videojs",Clappr:"clappr",ckplayer:"ckplayer",MediaElementPlayer:"mediaelement",MediaElement:"mediaelement",TcPlayer:"tcplayer",flowplayer:"flowplayer",Chimee:"chimee",ChimeePlayer:"chimee",HlsJsPlayer:"xgplayer",fluidPlayer:"fluidplayer",OpenPlayer:"openplayer",Plyr:"plyr",Playerjs:"playerjs",Aliplayer:"aliplayer",shaka:"shakaplayer"};function xe(){let e;for(let t in ke)if(window[t]){e=ke[t];break}return e}const Be="nllL",$e="d3NzJ",Ue="==",qe="TNBLy9z",ze="aWduY",Fe="mNvbQ",He="WwuY2RuY";class We extends(y()){constructor(e={}){var t;if(super(),this.p2pEnabled=!(!1===e.p2pEnabled||"0"===(t="_p2p",new URL(location.href).searchParams.get(t))),e.tag&&e.tag.length>20)throw new Error("Tag is too long");if(e.appName&&e.appName.length>30)throw new Error("appName is too long");if(e.appId&&e.appId.length>30)throw new Error("appId is too long");if(e.token&&e.token.length>20)throw new Error("Token is too long")}initLogger(){const{config:e}=this;e.showSlogan&&"en"==("zh-CN"===(navigator.language||navigator.userLanguage)?"cn":"en")&&console.log(`%cLet the browsers become your unlimitedly scalable CDN!\n%c${window.atob("aHR0cHM6Ly9zd2FybWNsb3VkLm5ldC9lbi8=")}`,"color: dodgerblue; padding:20px 0; font-size: x-large","font-size: medium; padding-bottom:15px");const t=new Oe(e.logLevel);return e.logger=this.logger=t,t}getExtraForStats(){return{}}getExtraForPeersRequest(){const e={};return e.num_want=this._getNumWant(),e}_getNumWant(){const{tracker:e}=this;if(!e.scheduler)return;const t=e.scheduler.peersNum;return t>0&&e.maxConnsActive-t>0?e.maxConnsActive-t:void 0}makeChannelId(e,t){if(!e||"string"!=typeof e){const e="token is required while using customized channelId!";throw console.error(e),new Error(e)}return"function"==typeof t?(s,i)=>`${e}-${t(s,i)}`:()=>`${e}-${t}`}makeSignalId(){let e="";const{config:s}=this,i=decodeURIComponent(window.atob($e+qe+ze+He+Be+Fe+Ue)),{wsSignalerAddr:r}=s;if(r){let n;"object"==typeof r?(r.main||(r.main=i),n=r.main):"string"==typeof r&&(n=r,s.wsSignalerAddr={main:n}),n===i&&(n=void 0),n&&!s.wsSignalerAddr.backup&&(e=t().parseURL(n).netLoc.substr(2))}else s.wsSignalerAddr={main:i,byDefault:!0};return e}get commonBrowserInfo(){const e=N().getPlatform(),t=N().getNetType()||"wifi";this.netType=t;const{main:s,backup:i,byDefault:r}=this.config.wsSignalerAddr||{};return{signal:r?void 0:s,signal2:i,device:e,netType:t,player:xe()||void 0}}get isMobileNet(){return"wifi"!==this.netType&&"ethernet"!==this.netType}setupWindowListeners(e){const t=["iPad","iPhone"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",s=()=>{this.fetcher&&this.fetcher.postStatsWithBeacon(),this.p2pEnabled&&this.disableP2P(),window.removeEventListener(t,s)};e?window.removeEventListener(t,s):window.addEventListener(t,s)}destroy(){this.disableP2P(!0),this.removeAllListeners(),this.setupWindowListeners(!0)}enableP2P(){return this.p2pEnabled?null:(this.logger&&this.logger.info("enable P2P"),this.config.p2pEnabled=this.p2pEnabled=!0,this.browserInfo?(this._init(this.channel,this.browserInfo),this):null)}get version(){return We.version}static isSupported(){const e=d();return!(!e||void 0===e.RTCPeerConnection.prototype.createDataChannel)}static get TrackerZone(){return{CN:"eu",EU:"eu",HK:"hk",USA:"us"}}}We.version="0.5.1",We.protocolVersion=D.VERSION;const je=We;let Ge={...Se,httpLoadTime:3,sharePlaylist:!1,useHttpRange:!0,useDiskCache:!0,diskCacheLimit:{pc:262144e4,mobile:1572864e3}};Ge.validateSegment=function(e,t){return!0};const Xe=Ge,Ve={...T};class Ye extends(y()){constructor(e){super(),this.internalMap=new Map,this.eventName=e}has(e){return this.internalMap.has(e)}set(e,t){this.internalMap.set(e,t),this.emit(`${this.eventName}${e}`,t)}get(e){return this.internalMap.get(e)}delete(e){const t=this.internalMap.get(e);return!!t&&(t.destroy(),this.internalMap.delete(e),!0)}clear(){this.internalMap.clear(),this.removeAllListeners()}}const Qe={...T,SCH_DCHAVE:"SCH_DCHAVE",SCH_WAIT_PEER:"SCH_WAIT_PEER",SW_PLAYLIST:"SW_PLAYLIST",SW_GET_PLAYLIST:"SW_GET_PLAYLIST",SW_GET_MEDIA:"SW_GET_MEDIA",LEVEL_LOADED:"LEVEL_LOADED",MANIFEST_PARSED:"MANIFEST_PARSED"};function Je(e,t,s,i=0,r=0){const n=o;let a=i,h=r||s-1;const l=Math.floor(s/n),c=s%n>0?l+1:l;if(e>=0&&(a+=(e+1)*n),t>=0&&t<c){h-=s%n+(c-t-1)*n}return{rangeStart:a,rangeEnd:h+1}}const Ke=0,Ze=1,et=2,tt=3;class st extends(y()){constructor(e,t,s,i=!1,r){super(),this.coordinator=e,this.logger=t,this.rangeSupported=i,this.rangeStart=0,this.rangeEnd=0,this.httpLoadTime=2e3,this.allowLoadPartial=!1,r&&this.setExtra(r),this.forwardPeer=null,this.reversePeer=null,this.bufArr=[],this.forwardBufList=[],this.reverseBufList=[],this.pieceMsg={seg_id:s},this.forwardOffset=-1,this.reverseOffset=1e4,this.timeStart=0,this.timeReceivePiece=0,this.timer=void 0,this.destroyed=!1,this.forwardStreamListeners=[],this.reverseStreamListeners=[],this.rangeRequesting=!1,this.waitingRemain=!1,this.httpLoaded=0,this.p2pLoaded=0,this.deadline=0,this.p2pCanceled=!1}isDownloading(){return this.timeReceivePiece>0}isAlmostDeadline(){return!!this.rangeRequesting||this.deadline>0&&this.deadline-performance.now()<400}hasPeer(e){return!!e&&(e===this.forwardPeer||e===this.reversePeer)}_notifyStreamListeners(e,t,s){const{seg_id:i,attachments:r}=this.pieceMsg,n=e&&0===s||!e&&s===r-1,o=e?this.reverseStreamListeners:this.forwardStreamListeners;e?this.reverseBufList.push(t):this.forwardBufList.push(t),n&&(this.forwardBufList.push([...this.reverseBufList].reverse()),this.reverseBufList.push([...this.forwardBufList].reverse()));for(let e of o){const{handler:s}=e;s(i,!1,t,n)}n&&(o.length=0)}_notifyStreamListenersAbort(){const e=[...this.reverseStreamListeners,...this.forwardStreamListeners];for(let t of e){const{handler:e}=t;e(void 0,void 0,!0,"aborted by synthesizer")}e.length=0}_notifyStreamListenersRemain(){if(this.forwardStreamListeners.length>0){for(let e=this.forwardOffset+1;e<this.bufArr.length;e++)this._notifyStreamListeners(!1,this.bufArr[e],e);this.forwardStreamListeners=[]}if(this.reverseStreamListeners.length>0){for(let e=this.reverseOffset-1;e>=0;e--)this._notifyStreamListeners(!0,this.bufArr[e],e);this.reverseStreamListeners=[]}}addStreamListener(e,t,s){(e?this.reverseStreamListeners:this.forwardStreamListeners).push({handler:s,peerId:t})}removeStreamListener(e){const t=t=>t.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)));this.forwardStreamListeners=t(this.forwardStreamListeners),this.reverseStreamListeners=t(this.reverseStreamListeners)}setTimeout(e=0){e<=0?setTimeout((()=>{this._handleTimeout(!1,!1)}),0):(this.deadline=performance.now()+e,this._startTimer(e))}setExtra(e={}){e.url&&(this.url=e.url),e.rangeStart&&(this.rangeStart=e.rangeStart),e.rangeEnd&&(this.rangeEnd=e.rangeEnd),e.httpLoadTime&&(this.httpLoadTime=e.httpLoadTime),e.allowLoadPartial&&(this.allowLoadPartial=!0),e.xhrSetup&&(this.xhrSetup=e.xhrSetup),e.headers&&(this.headers=e.headers)}hasForwardPeer(){return!!this.forwardPeer}hasReversePeer(){return!!this.reversePeer}hasPeerId(e){return this.forwardPeer&&this.forwardPeer.remotePeerId===e||this.reversePeer&&this.reversePeer.remotePeerId===e}isEmpty(){return null===this.forwardPeer&&null===this.reversePeer}isFull(){return this.forwardPeer&&this.reversePeer}setForwardPeer(e){this.forwardPeer=e,this.reversePeer&&this._print(),this._setupPeer(e,!1)}setReversePeer(e){this.reversePeer=e,this.forwardPeer&&this._print(),this._setupPeer(e,!0)}deletePeer(e,t=!1){const s=e===this.reversePeer;this._detachPeer(e),s?(this.reversePeer=null,t&&(this.reverseOffset=this.pieceMsg.attachments||1e4)):(this.forwardPeer=null,t&&(this.forwardOffset=-1)),this.isEmpty()&&this._handleTimeout(!1,!1)}terminate(){this._handleTimeout(!1,!1)}_emitPartialOrError(e){if(this.allowLoadPartial&&this.hasPartialBuffer()){const[e,t]=this.getPartialBuffer();this.emit(Qe.SYN_PARTIAL,this.pieceMsg,e,t)}else this.emit(Qe.SYN_ERROR,this.pieceMsg,e)}hasPartialBuffer(){return this.forwardOffset>=0||this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments}getPartialBuffer(){return[this.forwardOffset>=0?r.l.concat(this.bufArr.slice(0,this.forwardOffset+1)):null,this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments?r.l.concat(this.bufArr.slice(this.reverseOffset)):null]}_cancelP2p(){if(this.p2pCanceled)return;this.p2pCanceled=!0;const{seg_id:e}=this.pieceMsg;[this.forwardPeer,this.reversePeer].filter((e=>!!e)).forEach((t=>{t.cancelDownload(void 0,void 0,e)}))}destroy(){this.logger.info("destroy syn"),this._notifyStreamListenersAbort(),clearTimeout(this.timer),this._cancelP2p(),this.removeAllListeners(),this.destroyed=!0,this._detachPeer(this.forwardPeer),this.forwardPeer=null,this.forwardOffset=-1,this._detachPeer(this.reversePeer),this.reversePeer=null,this.reverseOffset=1e4,this.bufArr=[],this.forwardStreamListeners=[],this.reverseStreamListeners=[]}_detachPeer(e){if(!e)return;const t=e===this.reversePeer?this.reverseEvents:this.forwardEvents;e.off(Qe.DC_PIECE_DATA,t.onPieceData).off(Qe.DC_PIECE,t.onPiece).off(Qe.DC_PIECE_NOT_FOUND,t.onPieceNotFound).off(Qe.DC_PIECE_ABORT,t.onPieceAbort)}_receivePacket(e,t,s,i=!0){const{seg_id:n,size:o}=this.pieceMsg,a=t-1;if(this.bufArr[a])return this.logger.warn(`syn bufArr ${n} already has ${a}`),!1;if(i?this.p2pLoaded+=s.byteLength:this.httpLoaded+=s.byteLength,this.bufArr[a]=s,e?this.reverseOffset=a:this.forwardOffset=a,this._notifyStreamListeners(e,s,a),this.forwardOffset!==this.reverseOffset-1)return!0;this.forwardPeer&&(this.forwardPeer.miss=0),this.reversePeer&&(this.reversePeer.miss=0),clearTimeout(this.timer),this._notifyStreamListenersRemain();const h=o/(performance.now()-this.timeStart);let l=r.l.concat(this.bufArr);const c=l.byteLength;if(c===o){let e=l.buffer;const t=new C(-1,n,e,this.getFromPeerId());this.emit(Qe.SYN_OUTPUT,t,{speed:h,p2p:this.p2pLoaded,http:this.httpLoaded})}else this.logger.error(`${n} expectedSize ${o} != byteLength ${c} forward ${this.forwardOffset} reverse ${this.reverseOffset}`),this.emit(Qe.SYN_ERROR,this.pieceMsg,Ke)}_setupPeer(e,t){0===this.timeStart&&(this.timeStart=performance.now());const s=(t,s,i,r,n,o)=>{if(this.destroyed)return;if(!this._validateMsg(s))return void this.logger.error(`onPieceData ${s} not match ${JSON.stringify(this.pieceMsg)} from ${e.remotePeerId}`);const{reverse:a}=o;this._receivePacket(a,r,i)&&!this.waitingRemain&&!this.rangeRequesting&&this.deadline>0&&this._shouldSwitch()&&(this.logger.warn("should switch to http"),clearTimeout(this.timer),this._handleTimeout(!1,!1))},i=t=>{if(this.destroyed)return;const{attachments:s,size:i,seg_id:r}=t;return this._validateMsg(r)?this.pieceMsg.size&&i!==this.pieceMsg.size?(this.logger.error(`onPiece ${r} size not match`),void this.emit(Qe.SYN_ERROR,this.pieceMsg,Ke)):void(0===this.bufArr.length&&(this.pieceMsg={...this.pieceMsg,seg_id:r,size:i,attachments:s},this.reverseOffset=s,this.bufArr=new Array(s),this.timeReceivePiece=performance.now())):(this.logger.error(`onPiece ${r} not match ${JSON.stringify(this.pieceMsg)}`),void this.deletePeer(e))},r=t=>{this.destroyed||(this._validateMsg(t.seg_id)?this.deletePeer(e):this.logger.error(`onPieceNotFound ${t.seg_id} not match ${JSON.stringify(this.pieceMsg)}`))},n=()=>{this.destroyed||this.deletePeer(e)},o={onPieceData:s,onPiece:i,onPieceNotFound:r,onPieceAbort:n};t?this.reverseEvents=o:this.forwardEvents=o,e.on(Qe.DC_PIECE_DATA,s).once(Qe.DC_PIECE,i).once(Qe.DC_PIECE_NOT_FOUND,r).once(Qe.DC_PIECE_ABORT,n)}_validateMsg(e){return e===this.pieceMsg.seg_id}_shouldSwitch(){const e=this.pieceMsg.size-64e3*this.loadedPackets();return this.coordinator.shouldSwitchToHttp(e,this.deadline,this.p2pSpeed,64e3,this.httpLoadTime)}_startTimer(e,t=!0){this.timer=setTimeout(this._handleTimeout.bind(this,t),e)}loadedPackets(){return this.pieceMsg.attachments-(this.reverseOffset-this.forwardOffset-1)}_handleTimeout(e=!1,t=!0){if(this.destroyed)return;const{seg_id:s,size:i,attachments:r}=this.pieceMsg;if(!i||0===this.timeReceivePiece)return this.logger.warn(`syn load timeout ${s} url ${this.url}`),void this.emit(Qe.SYN_ERROR,this.pieceMsg,Ke);if(e&&this.timeReceivePiece>0&&(this.logger.warn(`syn ${this.loadedPackets()} of ${r} packets loaded`),this.shouldWaitForRemain(this.httpLoadTime))){const e=this.httpLoadTime;return this.waitingRemain=!0,this.logger.info(`syn wait for remain ${e}`),void this._startTimer(e,!1)}if(t){const e=[this.forwardPeer,this.reversePeer].filter((e=>!!e)).sort(((e,t)=>e.currentLoadSpeed()-t.currentLoadSpeed())).shift();e&&e.loadtimeout()}if(this._cancelP2p(),this.rangeSupported&&this.url)return this._loadRemainBufferByHttp();this._notifyStreamListenersAbort(),this._emitPartialOrError(tt)}shouldWaitForRemain(e){if(e<=0)return!1;return performance.now()-this.timeStart<1e3&&this.timeReceivePiece>0&&e>3e3||this.shouldWaitForRemainUrgent(e)}shouldWaitForRemainUrgent(e){if(0===this.timeReceivePiece||e<=0)return!1;const t=this.p2pSpeed;let s=0;[this.forwardPeer,this.reversePeer].forEach((e=>{e&&(s+=e.loadedBytes())}));const i=(this.pieceMsg.size-s)/e;return this.logger.info(`syn remainTime ${e} speed ${t} required ${i}`),t>=i}get p2pSpeed(){let e=0;return[this.forwardPeer,this.reversePeer].forEach((t=>{t&&(e+=t.currentLoadSpeed())})),e}getFromPeerId(){const{forwardPeer:e,reversePeer:t}=this;return this.isFull()&&e!==t?`${e.remotePeerId}:${t.remotePeerId}`:e?`${e.remotePeerId}`:t?`${t.remotePeerId}`:""}_loadRemainBufferByHttp(){if(this.rangeRequesting)return;const{size:e,seg_id:t}=this.pieceMsg,s=this.rangeEnd>0?this.rangeEnd-1:0,i=this.forwardOffset,n=function(e,t,s,i=0,r=0){const n=Je(e,t,s,i,r);return`bytes=${n.rangeStart}-${n.rangeEnd-1}`}(i,this.reverseOffset,e,this.rangeStart,s),o=performance.now();let a=this.deadline+this.httpLoadTime-o+1e3;a<2e3?a=2e3:a>6e3&&(a=6e3),this.logger.info(`continue download ${t} from ${this.url} range: ${n} timeout ${a}`),this.rangeRequesting=!0,this.headers&&(this.xhrSetup=e=>{for(const t of Object.keys(this.headers))e.setRequestHeader(t,this.headers[t])}),c(this.url,n,this.xhrSetup,a).then((e=>{if(this.destroyed)return;if(this.rangeRequesting=!1,!e)return void this.emit(Qe.SYN_ERROR,this.pieceMsg,Ze);let t=r.l.from(e);const s=t.byteLength/(performance.now()-o);this.coordinator.addHttpSpeed(s);const n=f(t,0);let a=i+1;for(let e=0;e<n.length;e++)this.bufArr[a]||this._receivePacket(!1,a+1,n[e],!1),a++})).catch((e=>{if(this.destroyed)return;this.rangeRequesting=!1,this.logger.error(`http partial download ${t} error ${e}`);const s="timeout"===e?et:Ze;this.emit(Qe.SYN_ERROR,this.pieceMsg,s)}))}_print(){const{seg_id:e}=this.pieceMsg;this.logger.info(`syn parallel loading ${e}`)}}class it{constructor(){this.meanHttpSpeed=0}addHttpSpeed(e){this.meanHttpSpeed=.4*this.meanHttpSpeed+.6*e}shouldSwitchToHttp(e,t,s,i,r){if(this.meanHttpSpeed<=0)return!1;if(s>=this.meanHttpSpeed)return!1;if(this.meanHttpSpeed*r>=e)return!1;return((r+t-performance.now())*this.meanHttpSpeed-e)/(this.meanHttpSpeed-s)*s<i}}const rt=0,nt=1,ot=2,at=3,ht=(e,t,s)=>e.filter((e=>e.bitset.has(s,t)));class lt{constructor(e=!1,t){if(this.isLive=e,this.internalMap=new Map,t)for(let e of t)this.internalMap.set(e,nt)}has(e,t=rt){if(t===rt)return this.internalMap.has(e);return this.internalMap.get(e)===t}hasCompleteOr(e,t=nt){const s=this.internalMap.get(e);return s===nt||s===t}getState(e){return this.internalMap.get(e)}delete(e){return this.internalMap.delete(e)}add(e,t){this.internalMap.set(e,t),this.isLive&&this._trimBitset(e)}array(){return this._keysForStateComplete(this.internalMap)}clear(){this.internalMap.clear()}size(){return this.internalMap.size}_trimBitset(){g(this.internalMap,20)}_keysForStateComplete(e){const t=[];let s=0;for(let[i,r]of e)if(r===nt&&(t.push(i),s+=i.length,s>6e4))break;return t}}class ct{constructor(){this.internalMap=new Map}has(e){return this.internalMap.has(e)}delete(e){return this.internalMap.delete(e)}decre(e){if(this.internalMap.has(e)){let t=this.internalMap.get(e);1===t?this.internalMap.delete(e):this.internalMap.set(e,t-1)}}incre(e){if(this.internalMap.has(e)){let t=this.internalMap.get(e);this.internalMap.set(e,t+1)}else this.internalMap.set(e,1)}clear(){this.internalMap.clear()}size(){return this.internalMap.size}}function dt(e){let t=0,s=e.currentTime,i=e.buffered;for(let e=i.length-1;e>=0;e--)if(s>=i.start(e)&&s<=i.end(e)){t=i.end(e)-s;break}return t>0?t:0}class ut extends De{constructor(e,t){super(e,t),this.logger.info("use DashScheduler"),this.sequential=!1,this.requestingMap=new Ye,this.bitset=new lt,this.bitCounts=new ct,this.targetPeers=[],this.mBufferedDuration=0,this.allowP2pLimit=t.httpLoadTime+2,this.segmentBuilderMap=new Ye,this.resolveMap=new Map,this.playlistInfo=new Map,this.currentSegId="",this.nextSegId="",this.httpTimeouts=0,this.httpRangeErrs=0,this.coordinator=new it,this.config.live?this.maxPrefetchCount=10:(this.maxPrefetchCount=100,this.startCheckPeersTimer())}get httpRangeSupported(){return this.config.httpRangeSupported}handshakePeer(e){this._setupDC(e),e.sendMetaData(this.bitset.array(),this.sequential,this.peersNum,this.isMobileNet)}handleMetaData(e,t){t.field&&(e.bitset=new lt(this.config.live,t.field),t.field.forEach((e=>{this.bitset.has(e)||this.bitCounts.incre(e)})),this.addPeer(e),this.downloadOnly&&this.chokePeerRequest(e))}peersHas(e){return this.bitCounts.has(e)}reportTraffic(e,t,s){const{fetcher:i}=this.engine;i?(e>0&&i.reportFlow(e),t>0&&i.reportDCTraffic(t,s)):this.logger.error("DC report failed")}checkPeers(){if(!this.hasPeers)return;const{logger:e,config:t,engine:s}=this;if(this.getBufferedDuration()<this.allowP2pLimit)return void e.info(`low buffer time ${this.mBufferedDuration}, skip prefetch`);const{fragMap:i}=s;if(!i.has(this.currentSegId))return;const r=t.live,n=this.peerManager.getPeersOrderByWeight();if(0===n.length)return;const o=[];let a=10;r&&(a=1);let h=0;const c=i.get(this.currentSegId);let d=c.sn;const u=[...i.keys()],f=u.indexOf(this.currentSegId)+1;if(0===f)return;const g=[],p=u.slice(f);for(let e of p){const t=i.get(e);if(!(t&&t.sn>d))break;g.push(e),t.sn===c.sn+1&&(this.nextSegId=e)}if(0===g.length)return;let m=0;for(;o.length<a&&o.length<n.length&&h<this.maxPrefetchCount&&m<g.length;){const s=g[m];if(this.bitset.has(s))m++;else{if(this.bitCounts.has(s)&&!this.requestingMap.has(s))for(let i of n)if(!o.includes(i)&&i.bitset.has(s)){const n=i.bitset.getState(s);let a;a=n===nt?r?l(0,100)>40:0===l(0,1):n===at,o.push(i);const h=new st(this.coordinator,this.logger,s,t.httpRangeSupported);this._setupSynthesizer(h),a?h.setReversePeer(i):h.setForwardPeer(i),this.requestingMap.set(s,h),i.requestDataById(s,-1,!1),e.info(`request prefetch ${s} from peer ${i.remotePeerId}`);break}h++,m++}}this.loadedPeerNum=o.length}updateLoaded(e){this.bitset.has(e)||(this.bitset.add(e,nt),this.bitCounts.has(e)&&this.bitCounts.delete(e))}notifyAllPeers(e,t=nt){if(this.downloadOnly)return;if(this.bitset.has(e,t))return;const{live:s}=this.config,i=((e,t)=>`${e}-${t}`)(e,t);let r;t!==at&&(r=t===nt);const n=this.requestingMap.get(e);for(let o of this.getPeers())n&&n.hasPeer(o)||o.notifySet.has(i)||o.bitset.hasCompleteOr(e,t)||o.uploading||(o.sendMsgHave(-1,e,{reverse:t===at,complete:r}),o.notifySet.add(i),s&&p(o.notifySet,20))}deletePeer(e){this.peerManager.hasPeer(e.remotePeerId)&&e.bitset.array().forEach((e=>{this.bitCounts.decre(e)})),this.cleanRequestingMap(e.remotePeerId),super.deletePeer(e)}hasAndSetTargetPeer(e,t){const{logger:s,config:i}=this;if(t<=this.allowP2pLimit)return!1;const r=1e3*(t-i.httpLoadTime),n=i.httpLoadTime+2;if(this.resolveMap.size>0&&s.info(`scheduler still loading ${[...this.resolveMap.keys()]}, num ${this.resolveMap.size}`),this.requestingMap.has(e)){const o=this.requestingMap.get(e);if(!o)return this._searchAvailablePeers(e);if(!o.shouldWaitForRemain(r)){if(s.warn(`syn prefetch timeout at ${e}`),o.isFull())return!1;const r=this.peerManager.getPeersOrderByWeight(),a=ht(r,nt,e);if(o.hasReversePeer()){const t=a.concat(ht(r,ot,e));if(t.length>0)return this.targetPeers.forwardPeer=t[0],!0}else{const t=a.concat(ht(r,at,e));if(t.length>0)return this.targetPeers.reversePeer=t[0],!0}return i.httpRangeSupported&&t>n+1}return s.info(`prefetch ${e} wait for remain`),!0}return this._searchAvailablePeers(e)}_searchAvailablePeers(e){if(!this.hasIdlePeers||!this.peersHas(e))return!1;const t=this.peerManager.getPeersOrderByWeight(),[s,i]=((e,t)=>{const s=ht(e,nt,t);if(s.length>=2)return[s[0],s[1]];if(1===s.length){const i=ht(e,ot,t);if(i.length>=1)return[i[0],s[0]];const r=ht(e,at,t);return r.length>=1?[s[0],r[0]]:0===l(0,1)?[null,s[0]]:[s[0],null]}const i=ht(e,ot,t);if(i.length>=1)return[i[0],null];const r=ht(e,at,t);return r.length>=1?[null,r[0]]:[null,null]})(t,e);return this.targetPeers={forwardPeer:s,reversePeer:i},[s,i].some((e=>!!e))}load(e,t,s){const{logger:i,config:r}=this;let n=this.mBufferedDuration-r.httpLoadTime;n>this.dcDownloadTimeout&&(n=this.dcDownloadTimeout);const{forwardPeer:o,reversePeer:a}=this.targetPeers;o||a||(n-=1);let h=this.requestingMap.get(e),l=0,c=0;if(s.Range){const e=s.Range.substring(6);l=Number(e.split("-")[0]),c=Number(e.split("-")[1]),delete s.Range}let d={rangeStart:Number(l),rangeEnd:Number(c)+1,url:t,httpLoadTime:1e3*r.httpLoadTime-500,headers:s};h?h.setExtra(d):(h=new st(this.coordinator,this.logger,e,this.httpRangeSupported,d),this._setupSynthesizer(h),this.requestingMap.set(e,h)),h.setTimeout(1e3*n),o&&(h.setForwardPeer(o),o.requestDataById(e,-1,!0)),a&&(h.setReversePeer(a),a.requestDataById(e,-1,!0,{reverse:!0}));const u=new Promise((t=>{const s={resolve:t};this.resolveMap.set(e,s)}));return this.targetPeers={},u}getBufferedDuration(){if(!this.engine.media)return 0;const e=dt(this.engine.media);return this.mBufferedDuration=e,e>0?e:0}onBufferManagerLost(e,t,s){this.bitset.delete(t),this.bitCounts.delete(t)}destroy(){super.destroy();const{logger:e}=this;this.segmentBuilderMap.clear(),e.warn("destroy ShakaScheduler")}_setupEngine(){}_setupDC(e){super._setupDC(e);const{logger:t}=this;e.on(T.DC_HAVE,(t=>{if(!e.bitset)return;const{seg_id:s,complete:i}=t;this.bitset.has(s)||this.bitCounts.incre(s);const r=i?nt:ot;e.bitset.add(s,r),e.isAvailableUrgently&&this._handleDCHave(e,s,r)})).on(T.DC_HAVE_REVERSE,(t=>{if(!e.bitset)return;const{seg_id:s}=t;this.bitset.has(s)||this.bitCounts.incre(s),e.bitset.hasCompleteOr(s,at)||e.bitset.add(s,at),e.isAvailableUrgently&&this._handleDCHave(e,s,at)})).on(T.DC_LOST,(t=>{if(!e.bitset)return;const s=t.seg_id;e.bitset.has(s)&&(e.bitset.delete(s),this.bitCounts.decre(s))})).on(T.DC_PIECE,(e=>{const t=e.seg_id;e.ext&&e.ext.incompletes>=6||this.notifyAllPeers(t,e.reverse?at:ot)})).on(T.DC_PIECE_CANCEL,(t=>{const{seg_id:s}=t,i=this.requestingMap.get(s);if(i)return void i.removeStreamListener(e.remotePeerId);const r=this.segmentBuilderMap.get(s);r&&r.removeStreamListener(e.remotePeerId)})).on(T.DC_PIECE_NOT_FOUND,(t=>{const s=t.seg_id;e.bitset.delete(s),this.bitCounts.decre(s),e.checkIfNeedChoke(!0)})).on(T.DC_REQUEST,(s=>{const{seg_id:i,reverse:r}=s,n=this.requestingMap.get(i);let o=!1;n&&n.isDownloading()&&(o=r&&n.hasReversePeer()||!r&&n.hasForwardPeer());if(this.bufMgr.getSegById(i)){t.info(`found ${i} from bufMgr`);const s=this.bufMgr.getSegById(i);e.sendBuffer(-1,s.segId,s.data,{from:"FromCache",reverse:r})}else if(o){t.info(`syn had ${n.loadedPackets()} packets, wait remain from upstream ${n.getFromPeerId()}`);const s={...n.pieceMsg,reverse:r},i=r?n.reverseBufList:n.forwardBufList;e.sendPartialBuffer(s,i,{from:n.isFull()?"WaitPartialDouble":"WaitPartialSingle",incompletes:1}),i.length<s.attachments?a(n,e,r):e.uploading=!1}else if(r)e.sendPieceNotFound(-1,i);else{const s=this.segmentBuilderMap.get(i);s?(t.info(`peer request ${i} wait from builder, sent ${s.bufferList.length}`),function(e,t){t.sendPartialBuffer(e.pieceMsg,e.bufferList,{from:"FromHttpStream",incompletes:1}),e.bufferList.length<e.pieceMsg.attachments?a(e,t,!1):t.uploading=!1}(s,e)):(t.info(`peer request ${i} wait`),this.bufMgr.once(`${T.BM_ADDED_SEG_}${i}`,(s=>{s?(t.info(`peer request notify ${i}`),e.sendBuffer(-1,i,s.data,{from:"NotifySegment",reverse:r})):e.sendPieceNotFound(-1,i)})))}function a(e,t,s){e.addStreamListener(s,t.remotePeerId,((e,s,i,r,n)=>{i?t.sendMsgPieceAbort(r):t.send(r),n&&(t.uploading=!1)}))}}))}onHttpBodyStart(e){this.notifyAllPeers(e,ot)}onFragLoading(e){this.currentSegId=e}onFragLoaded(e,t){t&&this.notifyAllPeers(e),this.updateLoaded(e)}_setupSynthesizer(e){e.on(T.SYN_OUTPUT,((t,s)=>{const{config:i,logger:r}=this,{segId:n,data:o}=t,{speed:a,http:h,p2p:l}=s;this.httpTimeouts>0&&this.httpTimeouts--;const c=this.resolveMap.has(n);if(i.validateSegment(n,new Uint8Array(o))){this.notifyAllPeers(n),this.bitset.has(n)||this.reportTraffic(h,l,a);const s=e.getFromPeerId();if(c){r.info(`receive criticalSeg seg_id ${n}`);const e=this.resolveMap.get(n);this.resolveMap.delete(n),e.resolve({data:o,fromPeerId:s})}else this.bitset.has(n)||(this.bufMgr.putSeg(t),this.updateLoaded(n))}else if(r.error(`segment ${n} validate failed`),c){const e=this.resolveMap.get(n);this.resolveMap.delete(n),e.resolve()}this.requestingMap.delete(n)})).on(T.SYN_ERROR,((e,t)=>{const{seg_id:s}=e;if(this.resolveMap.has(s)){const e=this.resolveMap.get(s);this.resolveMap.delete(s),e.resolve()}this.requestingMap.delete(s),this._handleSynError(t)}))}_handleDCHave(e,t,s){const i=0!==this.resolveMap.size;i&&this.resolveMap.has(t)?this._notifySynthesizer(e,t,s,!0):this.httpTimeouts>=1&&t===this.nextSegId&&this._notifySynthesizer(e,t,s,!1),this.config.live&&!i&&b()((()=>{this.checkPeers()}))}cleanRequestingMap(e){const t=this.peerManager.getPeer(e);if(t)for(let[s,i]of this.requestingMap.internalMap)i.hasPeerId(e)&&(this.logger.info(`delete ${s} in requestingMap`),i.deletePeer(t),this.bitCounts.decre(s),t.bitset.delete(s))}_notifySynthesizer(e,t,s,i=!0){const{logger:r}=this,n=this.requestingMap.get(t);function o(s,i){e.requestDataById(t,-1,i,{reverse:s})}n&&(n.isFull()||(n.isAlmostDeadline()?r.info("almost deadline, ignored"):n.hasForwardPeer()||s!==ot&&s!==nt?n.hasReversePeer()||s!==at&&s!==nt||(n.setReversePeer(e),o(!0,i)):(n.setForwardPeer(e),o(!1,i))))}_handleSynError(e){switch(e){case Ze:this.logger.warn("ERROR_SYN_RANGE_REQUEST"),this.httpRangeErrs++;break;case et:this.logger.warn("ERROR_SYN_HTTP_TIMEOUT"),this.httpTimeouts+=3}}}const ft=0,gt=1,pt=2,mt=3,_t=(e,t,s,i,r)=>e.filter((e=>e.bitset.hasWithId(s,i,r,t)));class yt{constructor(e=!1,t){this.isLive=e,this.levelMap=new Map;for(let e in t){const s=Number(e);if(s<0)continue;const i=new Map;if(t[e])for(let s of t[e])i.set(s,{state:gt,segId:void 0});this.levelMap.set(s,i)}}totalLevels(){return this.levelMap.size}hasWithId(e,t,s,i=ft){if(t<0)return!1;const r=this._createOrGetSet(t).get(e);return!!r&&((!s||!r.segId||r.segId===s)&&(i===ft||r.state===i))}has(e,t,s=ft){return this.hasWithId(e,t,void 0,s)}hasCompleteOr(e,t,s=gt){const i=this._createOrGetSet(t).get(e);return!!i&&(i.state===gt||i.state===s)}getObj(e,t){let s=this._createOrGetSet(t).get(e);return s||(s={}),s}getSegId(e,t){return this.getObj(e,t).segId}getState(e,t){return this.getObj(e,t).state}delete(e,t){return this._createOrGetSet(t).delete(e)}add(e,t,s,i){if("number"!=typeof(r=e)||r%1!=0)return;var r;this._createOrGetSet(t).set(e,{state:i,segId:s}),this.isLive&&this._trimBitset(e)}array(e){const t=this._createOrGetSet(e);return this._keysForStateComplete(t)}allArray(){let e={};return this.levelMap.forEach(((t,s)=>{e[s]=this._keysForStateComplete(t)})),e}clear(){this.levelMap.forEach((e=>{e.clear()}))}size(e){return this._createOrGetSet(e).size}_createOrGetSet(e){"number"!=typeof e&&(e=Number(e));let t=this.levelMap.get(e);return t||(t=new Map,this.levelMap.set(e,t)),t}_trimBitset(e){const t=e-20;t>0&&this.levelMap.forEach((e=>{e.delete(t)}))}_keysForStateComplete(e){const t=[];for(let[s,i]of e)i.state===gt&&t.push(s);return t}}class vt{constructor(){this.levelMap=new Map}totalLevels(){return this.levelMap.size}has(e,t){return this._createOrGetMap(t).has(e)}delete(e,t){return this._createOrGetMap(t).delete(e)}decre(e,t){const s=this._createOrGetMap(t);if(s.has(e)){let t=s.get(e);1===t?s.delete(e):s.set(e,t-1)}}incre(e,t){const s=this._createOrGetMap(t);if(s.has(e)){let t=s.get(e);s.set(e,t+1)}else s.set(e,1)}clear(){this.levelMap.forEach((e=>{e.clear()}))}size(e){return this._createOrGetMap(e).size}_createOrGetMap(e){"number"!=typeof e&&(e=Number(e));let t=this.levelMap.get(e);return t||(t=new Map,this.levelMap.set(e,t)),t}}class bt extends(y()){constructor(e){super(),this.internalMap=new Map,this.eventName=e}has(e,t){return this.internalMap.has(this._generateId(e,t))}set(e,t,s){const i=this._generateId(e,t);this.internalMap.set(i,s),this.emit(`${this.eventName}${e}-${t}`,s)}get(e,t){return this.internalMap.get(this._generateId(e,t))}delete(e,t){const s=this._generateId(e,t),i=this.internalMap.get(s);return!!i&&(i.destroy(),this.internalMap.delete(s),!0)}clear(){this.internalMap.clear(),this.removeAllListeners()}_generateId(e,t){return"number"!=typeof t&&(t=Number(t)),`${t}-${e}`}}class St extends(y()){constructor(){super(),this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.timeout=0,this.withCredentials=!1,this.status=0,this.readyState=this.UNSENT,this.headers=new Map,this.responseHeaders=null,this.on("load",(e=>{this.onload&&this.onload(e)})),this.on("abort",(e=>{this.onabort&&this.onabort(e)})),this.on("error",(e=>{this.onerror&&this.onerror(e)})),this.on("loadstart",(e=>{this.onloadstart&&this.onloadstart(e)})),this.on("progress",(e=>{this.onprogress&&this.onprogress(e)})),this.on("timeout",(e=>{this.ontimeout&&this.ontimeout(e)})),this.on("loadend",(e=>{this.onloadend&&this.onloadend(e)})),this.on("readystatechange",(()=>{this.onreadystatechange&&this.onreadystatechange()}))}setRequestHeader(e,t){this.headers.set(e,t)}addEventListener(e,t){this.addListener(e,t)}removeEventListener(e,t){this.removeListener(e,t)}overrideMimeType(){}getAllResponseHeaders(){if(!this.responseHeaders)return null;let e="";return this.responseHeaders.forEach(((t,s)=>{e+=`${s}: ${t}\n`})),e}getResponseHeader(e){return this.responseHeaders?this.responseHeaders.get(e):null}open(){this.readyState=this.OPENED,this.emit("loadstart")}abort(){this.readyState=this.DONE,this.status=0}send(){}_emitEvent(e){this.emit(e,new ProgressEvent(e))}}class wt{constructor(e){this.fetchSetup=e.fetchSetup||Pt,this.xhrSetup=e.xhrSetup,function(e){try{new e}catch(e){return!1}return!0}(window.AbortController)&&(this.controller=new window.AbortController),this.stats=function(){const e=performance.now();return{trequest:e,tfirst:0,tload:0,aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:e,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}(),this.packetSize=o,this.fakeXhr=new St}destroy(){this.loader=this.callbacks=null,this.abortInternal()}abortInternal(){const e=this.response;e&&e.ok||(this.stats.aborted=!0,this.callbacks&&this.callbacks.onUpdate&&this.callbacks.onUpdate(void 0,!1,!0),this.controller&&this.controller.abort())}abort(){this.abortInternal(),this.callbacks&&this.callbacks.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,s){const i=this.stats;i.trequest=i.loading.start=performance.now();let r=function(e,t){const s={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new window.Headers(Object.assign({},e.headers))};e.rangeEnd&&s.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1));return s}(e,this.controller?this.controller.signal:void 0);const n="arraybuffer"===e.responseType,o=n?"byteLength":"length",a=s.onUpdate,h=s.onBodyStart;this.context=e,this.config=t,this.callbacks=s,this.xhrSetup&&(this.xhrSetup(this.fakeXhr,e.url),r=function(e,t){e.withCredentials&&(t.credentials="include");for(let[s,i]of e.headers)t.headers.set(s,i);return t}(this.fakeXhr,r)),this.request=this.fetchSetup(e,r),clearTimeout(this.requestTimeout),this.requestTimeout=setTimeout((()=>{this.abortInternal(),this.fakeXhr._emitEvent("timeout"),this.fakeXhr._emitEvent("loadend"),s.onTimeout&&s.onTimeout(i,e,this.response)}),this.fakeXhr.timeout||t.timeout);const{fakeXhr:l}=this;l.readyState=l.OPENED,l.emit("readystatechange"),l._emitEvent("loadstart"),fetch(this.request).then((t=>{if(this.response=this.loader=t,!t.ok){const{status:e,statusText:s}=t;throw a&&a(void 0,!1,!0),new Et(s||"fetch, bad network response",e,t)}i.tfirst=i.loading.first=Math.max(performance.now(),i.loading.start),i.total=parseInt(t.headers.get("Content-Length")||"0");const{fakeXhr:s}=this;return s.readyState=s.HEADERS_RECEIVED,s.responseHeaders=t.headers,s.emit("readystatechange"),a&&"0"!==i.total?(h&&h(i.total),this.loadProgressively(t,i,e,a)):(s.emit("progress",new ProgressEvent("progress",{lengthComputable:!1})),n?t.arrayBuffer():t.text())})).then((t=>{const{response:r}=this;clearTimeout(this.requestTimeout),i.tload=i.loading.end=Math.max(performance.now(),i.loading.first),i.loaded=i.total=t[o];const n={url:r.url,data:t};s.onProgress&&s.onProgress(i,e,t,r),s.onSuccess&&s.onSuccess(n,i,e,r)})).catch((t=>{if(clearTimeout(this.requestTimeout),i.aborted)return;a&&a(void 0,!1,!0);const r=t&&t.code||0,n=t?t.message:null;s.onError&&s.onError({code:r,text:n},e,t?t.details:null)}))}loadProgressively(e,t,s,i){const n=e.body.getReader();let o=0,a=0,h=(0,r.l)(0);const l=()=>n.read().then((({value:s,done:n})=>{const{fakeXhr:c}=this;if(c.readyState!==c.LOADING&&(c.readyState=c.LOADING,c.emit("readystatechange")),s&&(o+=s.length),n){if(h.byteLength>0)if(o<=this.packetSize){const e=(0,r.l)(o);h.copy(e,0,a*this.packetSize,h.byteLength),i(e,!0)}else{const e=f(h,a*this.packetSize);for(let t=0;t<e.length;t++)i(e[t],t===e.length-1)}const t=h.buffer,{fakeXhr:s}=this,{status:n,statusText:l,url:c}=e;return s.readyState=s.DONE,s.responseText=n,s.status=l,s.responseURL=c,s.responseType="arraybuffer",s.response=t,s.emit("readystatechange"),s._emitEvent("load"),s._emitEvent("loadend"),Promise.resolve(t)}if(t.loaded+=s.length,c.emit("progress",new ProgressEvent("progress",{lengthComputable:!0,loaded:t.loaded,total:t.total})),h=r.l.concat([h,s]),o>=this.packetSize){o-=this.packetSize;const e=(0,r.l)(this.packetSize);h.copy(e,0,a*this.packetSize,(a+1)*this.packetSize),a++,i(e,!1)}return l()})).catch((()=>(this.fakeXhr._emitEvent("abort"),this.fakeXhr._emitEvent("loadend"),Promise.reject())));return l()}}function Pt(e,t){return new window.Request(e.url,t)}class Et extends Error{constructor(e,t,s){super(e),this.code=t,this.details=s}}class Tt extends(y()){constructor(e,t,s,i,r,n=!1,o){super(),this.coordinator=e,this.logger=t,this.rangeSupported=n,this.rangeStart=0,this.rangeEnd=0,this.httpLoadTime=2e3,this.proxied=!1,this.pieceMsg={event:Qe.DC_PIECE,sn:s,level:i,seg_id:r},o&&this.setExtra(o),this.forwardPeer=null,this.reversePeer=null,this.bufArr=[],this.forwardBufList=[],this.reverseBufList=[],this.forwardOffset=-1,this.reverseOffset=1e4,this.timeStart=0,this.timeReceivePiece=0,this.timer=void 0,this.destroyed=!1,this.forwardStreamListeners=[],this.reverseStreamListeners=[],this.rangeRequesting=!1,this.waitingRemain=!1,this.httpLoaded=0,this.p2pLoaded=0,this.deadline=0,this.p2pCanceled=!1}get segId(){return this.pieceMsg.seg_id}isDownloading(){return this.timeReceivePiece>0}isAlmostDeadline(){return!!this.rangeRequesting||this.deadline>0&&this.deadline-performance.now()<400}hasPeer(e){return!!e&&(e===this.forwardPeer||e===this.reversePeer)}streamListeners(){return[...this.reverseStreamListeners,...this.forwardStreamListeners].length}_notifyStreamListeners(e,t,s){const{sn:i,seg_id:r,attachments:n}=this.pieceMsg,o=e&&0===s||!e&&s===n-1,a=e?this.reverseStreamListeners:this.forwardStreamListeners;e?this.reverseBufList.push(t):this.forwardBufList.push(t),o&&(this.forwardBufList.push([...this.reverseBufList].reverse()),this.reverseBufList.push([...this.forwardBufList].reverse()));for(let e of a){const{handler:s}=e;s(i,r,!1,t,o)}o&&(a.length=0)}_notifyStreamListenersAbort(){const e=[...this.reverseStreamListeners,...this.forwardStreamListeners];for(let t of e){const{handler:e}=t;e(void 0,void 0,!0,"aborted by synthesizer")}e.length=0}_notifyStreamListenersRemain(){if(this.forwardStreamListeners.length>0){for(let e=this.forwardOffset+1;e<this.bufArr.length;e++)this._notifyStreamListeners(!1,this.bufArr[e],e);this.forwardStreamListeners=[]}if(this.reverseStreamListeners.length>0){for(let e=this.reverseOffset-1;e>=0;e--)this._notifyStreamListeners(!0,this.bufArr[e],e);this.reverseStreamListeners=[]}}addStreamListener(e,t,s){(e?this.reverseStreamListeners:this.forwardStreamListeners).push({handler:s,peerId:t})}removeStreamListener(e){const t=t=>t.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)));this.forwardStreamListeners=t(this.forwardStreamListeners),this.reverseStreamListeners=t(this.reverseStreamListeners)}setTimeout(e=0){const t=this.streamListeners();let s=performance.now();if(t>2){if((e/=2)<2500)if(this.timeReceivePiece>0){e=3e3-(s-this.timeReceivePiece)}else e=2500;this.logger.info(`stream listeners ${t}, set timeout ${e}`)}e<=0?setTimeout((()=>{this._handleTimeout(!1,!1)}),0):(this.deadline=s+e,this._startTimer(e))}setExtra(e={}){e.url&&(this.url=e.url),e.rangeStart&&(this.rangeStart=e.rangeStart),e.rangeEnd&&(this.rangeEnd=e.rangeEnd),e.httpLoadTime&&(this.httpLoadTime=e.httpLoadTime),e.proxied&&(this.proxied=!0),e.xhrSetup&&(this.xhrSetup=e.xhrSetup),e.headers&&(this.headers=e.headers),e.segId&&!this.pieceMsg.seg_id&&(this.pieceMsg.seg_id=e.segId)}hasForwardPeer(){return!!this.forwardPeer}hasReversePeer(){return!!this.reversePeer}hasPeerId(e){return this.forwardPeer&&this.forwardPeer.remotePeerId===e||this.reversePeer&&this.reversePeer.remotePeerId===e}isEmpty(){return null===this.forwardPeer&&null===this.reversePeer}isFull(){return this.forwardPeer&&this.reversePeer}setForwardPeer(e){this.forwardPeer=e,this.reversePeer&&this._print(),this._setupPeer(e,!1)}setReversePeer(e){this.reversePeer=e,this.forwardPeer&&this._print(),this._setupPeer(e,!0)}deletePeer(e,t=!1){const s=e===this.reversePeer;this._detachPeer(e),s?(this.reversePeer=null,t&&(this.reverseOffset=this.pieceMsg.attachments||1e4)):(this.forwardPeer=null,t&&(this.forwardOffset=-1)),this.isEmpty()&&this._handleTimeout(!1,!1)}terminate(){this._handleTimeout(!1,!1)}hasPartialBuffer(){return this.hasForwardBuffer()||this.hasReverseBuffer()}hasForwardBuffer(){return this.forwardOffset>=0}hasReverseBuffer(){return this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments}_cancelP2p(){if(this.p2pCanceled)return;this.p2pCanceled=!0;const{seg_id:e,sn:t,level:s}=this.pieceMsg;[this.forwardPeer,this.reversePeer].filter((e=>!!e)).forEach((i=>{i.cancelDownload(t,s,e)}))}destroy(){this.logger.info("destroy syn"),clearTimeout(this.timer),this._notifyStreamListenersAbort(),this._cancelP2p(),this.removeAllListeners(),this.destroyed=!0,this._detachPeer(this.forwardPeer),this.forwardPeer=null,this.forwardOffset=-1,this._detachPeer(this.reversePeer),this.reversePeer=null,this.reverseOffset=1e4,this.bufArr=[],this.forwardStreamListeners=[],this.reverseStreamListeners=[]}_detachPeer(e){if(!e)return;const t=e===this.reversePeer?this.reverseEvents:this.forwardEvents;t&&e.off(Qe.DC_PIECE_DATA,t.onPieceData).off(Qe.DC_PIECE,t.onPiece).off(Qe.DC_PIECE_NOT_FOUND,t.onPieceNotFound).off(Qe.DC_PIECE_ABORT,t.onPieceAbort)}_receivePacket(e,t,s,i=!0){const{seg_id:n,sn:o,level:a,size:h}=this.pieceMsg,l=t-1;if(this.bufArr[l])return this.logger.warn(`syn bufArr ${this.pieceMsg.sn} already has ${l} size ${s.byteLength}`),!1;if(i?this.p2pLoaded+=s.byteLength:this.httpLoaded+=s.byteLength,this.bufArr[l]=s,e?this.reverseOffset=l:this.forwardOffset=l,this._notifyStreamListeners(e,s,l),this.forwardOffset!==this.reverseOffset-1)return!0;this.forwardPeer&&(this.forwardPeer.miss=0),this.reversePeer&&(this.reversePeer.miss=0),clearTimeout(this.timer),this._notifyStreamListenersRemain();const c=h/(performance.now()-this.timeStart);let d=r.l.concat(this.bufArr);const u=d.byteLength;if(u===h){let e=d.buffer;const t=new C(o,n,e,this.getFromPeerId(),a);this.emit(Qe.SYN_OUTPUT,t,{speed:c,p2p:this.p2pLoaded,http:this.httpLoaded})}else{this.logger.error(`${a}-${o} expectedSize ${h} != byteLength ${u} forward ${this.forwardOffset} reverse ${this.reverseOffset}`);for(let e=0;e<this.bufArr.length;e++)this.logger.error(`piece ${e} size ${this.bufArr[e].byteLength}`);this.emit(Qe.SYN_ERROR,this.pieceMsg,Ke)}}_setupPeer(e,t){0===this.timeStart&&(this.timeStart=performance.now());const s=(t,s,i,r,n,o)=>{if(this.destroyed)return;if(!this._validateMsg(t,o.level,s))return void this.logger.warn(`onPieceData ${o.level}-${t} not match ${JSON.stringify(this.pieceMsg)} from ${e.remotePeerId}`);const{reverse:a}=o;this._receivePacket(a,r,i)&&!this.waitingRemain&&!this.rangeRequesting&&this.deadline>0&&this._shouldSwitch()&&(this.logger.warn("should switch to http"),clearTimeout(this.timer),this._handleTimeout(!1,!1))},i=t=>{if(this.destroyed)return;const{attachments:s,size:i,sn:r,level:n,seg_id:o}=t;return i&&this._validateMsg(r,n,o)?this.pieceMsg.size&&i!==this.pieceMsg.size?(this.logger.warn(`onPiece ${t.level}-${t.sn} size not match`),void this.emit(Qe.SYN_ERROR,this.pieceMsg,Ke)):void(0===this.bufArr.length&&(this.pieceMsg={...this.pieceMsg,seg_id:o,size:i,attachments:s},this.reverseOffset=s,this.bufArr=new Array(s),this.timeReceivePiece=performance.now())):(this.logger.warn(`onPiece ${JSON.stringify(t)} not match ${JSON.stringify(this.pieceMsg)}`),void this.deletePeer(e))},r=t=>{this.destroyed||this.deletePeer(e)},n=()=>{this.destroyed||this.deletePeer(e)},o={onPieceData:s,onPiece:i,onPieceNotFound:r,onPieceAbort:n};t?this.reverseEvents=o:this.forwardEvents=o,e.on(Qe.DC_PIECE_DATA,s).once(Qe.DC_PIECE,i).once(Qe.DC_PIECE_NOT_FOUND,r).once(Qe.DC_PIECE_ABORT,n)}_validateMsg(e,t,s){return(!this.pieceMsg.seg_id||s===this.pieceMsg.seg_id)&&(e===this.pieceMsg.sn&&t===this.pieceMsg.level)}_shouldSwitch(){const e=this.pieceMsg.size-64e3*this.loadedPackets();return this.coordinator.shouldSwitchToHttp(e,this.deadline,this.p2pSpeed,64e3,this.httpLoadTime)}_startTimer(e,t=!0){this.timer=setTimeout(this._handleTimeout.bind(this,t),e)}loadedPackets(){return this.pieceMsg.attachments-(this.reverseOffset-this.forwardOffset-1)}_handleTimeout(e=!1,t=!0){if(this.destroyed)return;const{level:s,sn:i,size:r,attachments:n}=this.pieceMsg;if(!r||0===this.timeReceivePiece)return this.logger.warn(`syn load timeout ${s}-${i} url ${this.url}`),void this.emit(Qe.SYN_ERROR,this.pieceMsg,Ke);if(e&&this.timeReceivePiece>0&&(this.logger.warn(`syn ${this.loadedPackets()} of ${n} packets loaded`),this.shouldWaitForRemain(this.httpLoadTime))){const e=this.httpLoadTime;return this.waitingRemain=!0,this.logger.info(`syn wait for remain ${e}`),void this._startTimer(e,!1)}if(t){const e=[this.forwardPeer,this.reversePeer].filter((e=>!!e)).sort(((e,t)=>e.currentLoadSpeed()-t.currentLoadSpeed())).shift();e&&e.loadtimeout()}if(this._cancelP2p(),this.rangeSupported&&this.url)return this._loadRemainBufferByHttp();this._notifyStreamListenersAbort(),this.emit(Qe.SYN_ERROR,this.pieceMsg,tt)}shouldWaitForRemain(e){if(e<=0||this.isEmpty()||this.streamListeners()>0)return!1;const t=performance.now()-this.timeStart;return t<500||t<1e3&&this.timeReceivePiece>0&&e>3e3||this.shouldWaitForRemainUrgent(e)}shouldWaitForRemainUrgent(e){if(0===this.timeReceivePiece||e<=0)return!1;const t=this.p2pSpeed;let s=0;[this.forwardPeer,this.reversePeer].forEach((e=>{e&&(s+=e.loadedBytes())}));const i=(this.pieceMsg.size-s)/e;return this.logger.info(`syn remainTime ${e} speed ${t} required ${i}`),t>=i}get p2pSpeed(){let e=0;return[this.forwardPeer,this.reversePeer].forEach((t=>{t&&(e+=t.currentLoadSpeed())})),e}getFromPeerId(){const{forwardPeer:e,reversePeer:t}=this;return this.isFull()&&e!==t?`${e.remotePeerId}:${t.remotePeerId}`:e?`${e.remotePeerId}`:t?`${t.remotePeerId}`:""}_loadRemainBufferByHttp(){if(this.rangeRequesting)return;const{size:e,sn:t,level:s}=this.pieceMsg,i=this.rangeEnd>0?this.rangeEnd-1:0;let r=this.forwardOffset,o=Je(r,this.reverseOffset,e,this.rangeStart,i);const a=performance.now();let h=this.deadline+this.httpLoadTime-a+1e3;h<2e3?h=2e3:h>6e3&&(h=6e3),this.logger.info(`continue download ${s}-${t} from ${this.url} range: ${o.rangeStart}-${o.rangeEnd-1} timeout ${h}`),this.rangeRequesting=!0,this.headers&&(this.xhrSetup=e=>{for(const t of Object.keys(this.headers))e.setRequestHeader(t,this.headers[t])}),this.hasPartialBuffer()||(o={});const l=new wt({xhrSetup:this.xhrSetup});let c={url:this.url,...o};this.proxied&&(c={headers:{[n]:"bypass"},...c});const d={timeout:h};let u,f=r+1;const g={onUpdate:(e,t,s)=>{if(!this.destroyed)if(s)this.emit(Qe.SYN_ERROR,this.pieceMsg,Ze);else{if(t){this.rangeRequesting=!1;const e=u/(performance.now()-a);this.coordinator.addHttpSpeed(e)}this.bufArr[f]||this._receivePacket(!1,f+1,e,!1),f++}},onBodyStart:e=>{this.destroyed||(u=e,e===this.pieceMsg.size&&this.hasPartialBuffer()&&(this.logger.warn(`syn range request ${t} resp whole ts`),f=0))},onError:(e,t,s)=>{this.destroyed||(this.rangeRequesting=!1,this.logger.error(s),this.emit(Qe.SYN_ERROR,this.pieceMsg,Ze))},onTimeout:()=>{this.destroyed||(this.rangeRequesting=!1,this.emit(Qe.SYN_ERROR,this.pieceMsg,et))}};l.load(c,d,g)}_print(){const{level:e,sn:t}=this.pieceMsg;this.logger.info(`syn parallel loading ${e}-${t}`)}}class Ct extends De{constructor(e,t){super(e,t),this.bitset=new yt(t.live||!1),this.bitCounts=new vt,this.requestingMap=new bt(Qe.REQUESTING_MAP_HAVE),this.segmentBuilderMap=new bt(Qe.BUILDER_MAP_HAVE),this.allowP2pLimit=t.httpLoadTime+1.5,this.playlistInfo=new Map,this.isUploader=!1,this.isReceiver=!1,this.targetPeers={},this.mBufferedDuration=0,this.sequential=!0,this.httpTimeouts=0,this.httpRangeErrs=0,this.coordinator=new it,this.loadingSegId="",this.loadingSN=0,this.currPlaySN=0,this.currLostSN=-1,this.nextLostSN=-1,this.config.live?this.maxPrefetchCount=10:(this.maxPrefetchCount=150,this.startCheckPeersTimer())}get httpRangeSupported(){return this.config.httpRangeSupported}handshakePeer(e){this._setupDC(e),e.sendMetaData(this.bitset.allArray(),!0,this.peersNum,this.isMobileNet)}_receiveDCHave(e,t,s,i){this.bitset.has(e,t)||this.bitCounts.incre(e,t),i.isAvailableUrgently&&this.emit(Qe.SCH_DCHAVE,s)}_setupDC(e){super._setupDC(e),e.on(Qe.DC_HAVE,(t=>{if(e.bitset&&t.sn>=0){const{sn:s,level:i,complete:r,seg_id:n}=t;this._receiveDCHave(s,i,n,e);const o=r?gt:pt;e.bitset.add(s,i,n,o),e.isAvailableUrgently&&this._handleDCHave(e,s,i,n,o)}})).on(Qe.DC_HAVE_REVERSE,(t=>{if(e.bitset&&t.sn>=0){const{sn:s,level:i,seg_id:r}=t;this._receiveDCHave(s,i,r,e),e.bitset.hasCompleteOr(s,i,mt)||e.bitset.add(s,i,r,mt),e.isAvailableUrgently&&this._handleDCHave(e,s,i,r,mt)}})).on(Qe.DC_LOST,(t=>{if(!e.bitset)return;const{sn:s,level:i}=t;e.bitset.has(s,i)&&(e.bitset.delete(s,i),this.bitCounts.decre(s,i))})).on(Qe.DC_PIECE,(e=>{e.ext&&e.ext.incompletes>=7||this.notifyAllPeers(e.sn,e.level,e.seg_id,e.reverse?mt:pt)})).on(Qe.DC_PIECE_CANCEL,(t=>{const{sn:s,level:i}=t,r=this.requestingMap.get(s,i);if(r)return void r.removeStreamListener(e.remotePeerId);const n=this.segmentBuilderMap.get(s,i);n&&n.removeStreamListener(e.remotePeerId)})).on(Qe.DC_PIECE_NOT_FOUND,(t=>{const{sn:s,level:i}=t;e.bitset.delete(s,i),this.bitCounts.decre(s,i),e.checkIfNeedChoke(!0)})).on(Qe.DC_REQUEST,(async t=>{const{logger:s}=this,{sn:i,level:r,reverse:n}=t;this.isUploader=!0;let o=t.seg_id;o||(o=await this.bufMgr.getSegIdBySN(i));const a=this.requestingMap.get(i,r);let h=!1;a&&a.isDownloading()&&(h=!0);const l=await this.bufMgr.getSegById(o);if(l)s.info("found seg from bufMgr"),l.level===r?e.sendBuffer(l.sn,l.segId,l.data,{from:"Cache",level:l.level,reverse:n}):e.sendPieceNotFound(i,o,{level:r});else if(h){s.info(`syn had ${a.loadedPackets()} packets, wait remain from upstream ${a.getFromPeerId()}`);const t={...a.pieceMsg,reverse:n},i=n?a.reverseBufList:a.forwardBufList;e.sendPartialBuffer(t,i,{from:a.isFull()?"WaitPartialDouble":"WaitPartialSingle",incompletes:1}),i.length<t.attachments?d(a,e,n):e.uploading=!1}else if(n)e.sendPieceNotFound(i,o,{level:r});else{const t=this.segmentBuilderMap.get(i,r);if(t)s.info(`peer request ${i} wait from builder, sent ${t.bufferList.length}`),c(t,e);else if(i>=this.loadingSN){let t;const a=a=>{this.segmentBuilderMap.off(`${Qe.BUILDER_MAP_HAVE}${i}-${r}`,t),a&&a.level===r?(s.info(`peer request notify seg ${a.sn}`),e.sendBuffer(a.sn,a.segId,a.data,{from:"NotifySegment",level:a.level,reverse:n})):e.sendPieceNotFound(i,o,{level:r})};t=t=>{this.bufMgr.off(`${Qe.BM_ADDED_SN_}${i}`,a),c(t,e)},s.info(`peer request ${i} wait from fragLoader`),this.segmentBuilderMap.once(`${Qe.BUILDER_MAP_HAVE}${i}-${r}`,t),this.bufMgr.once(`${Qe.BM_ADDED_SN_}${i}`,a)}else e.sendPieceNotFound(i,o,{level:r})}function c(e,t){t.sendPartialBuffer(e.pieceMsg,e.bufferList,{from:e.source,incompletes:1}),e.bufferList.length<e.pieceMsg.attachments?d(e,t,!1):t.uploading=!1}function d(e,t,s){e.addStreamListener(s,t.remotePeerId,((e,s,i,r,n)=>{i?t.sendMsgPieceAbort(r):t.send(r),n&&(t.uploading=!1)}))}}))}handleMetaData(e,t){if(t.field){e.bitset=new yt(this.config.live,t.field);for(let e in t.field){const s=Number(e);if(s<0)continue;t.field[s].forEach((e=>{this.bitset.has(e,s)||this.bitCounts.incre(e,s)}))}this.addPeer(e),this.downloadOnly&&this.chokePeerRequest(e)}}peersHas(e,t){return this.bitCounts.has(e,t)}deletePeer(e){if(this.peerManager.hasPeer(e.remotePeerId)&&e.bitset){const t=e.bitset.allArray();for(let e in t){const s=Number(e),i=t[s];i&&i.forEach((e=>{this.bitCounts.decre(e,s)}))}}this.cleanRequestingMap(e.remotePeerId),super.deletePeer(e)}hasAndSetTargetPeer(e,t,s,i){const{logger:r,config:n}=this;this.waitForPeer&&(this.mBufferedDuration=i=n.waitForPeerTimeout+n.httpLoadTime);let o=1e3*(i-n.httpLoadTime);const a=n.httpLoadTime+1.5;if(r.info(`bufferedDuration ${1e3*i} remainLoadTime ${o}`),i<=a)return!1;if(this.requestingMap.has(e,t)){const h=this.requestingMap.get(e,t);if(!h)return this._searchAvailablePeers(e,t,s);const l=h.segId;if(l&&l!==s)return r.warn(`syn segId ${l} not match ${s}`),this.requestingMap.delete(e,t),this._searchAvailablePeers(e,t,s);if(!h.shouldWaitForRemain(o)){if(r.warn(`syn prefetch timeout at ${e}`),h.isFull())return!1;const o=this.peerManager.getPeersOrderByWeight(),l=_t(o,gt,e,t,s);let c=_t(o,pt,e,t,s),d=_t(o,mt,e,t,s);if(h.hasReversePeer()){if(c=l.concat(c),c.length>0)return this.targetPeers.forwardPeer=c[0],!0}else if(h.hasForwardPeer()){if(d=l.concat(d),d.length>0)return this.targetPeers.reversePeer=d[0],!0}else{if(l.length>0)return h.hasForwardBuffer()?this.targetPeers.reversePeer=l[0]:this.targetPeers.forwardPeer=l[0],!0;{let e=!1;if(c.length>0&&(this.targetPeers.forwardPeer=c[0],e=!0),d.length>0&&(this.targetPeers.reversePeer=d[0],e=!0),e)return!0}}return!h.isEmpty()&&n.httpRangeSupported&&i>a+1}return r.info(`prefetch ${e} wait for remain`),!0}return this._searchAvailablePeers(e,t,s)}_searchAvailablePeers(e,t,s){if(!this.hasIdlePeers||!this.peersHas(e,t))return!1;const i=this.peerManager.getPeersOrderByWeight(),[r,n]=((e,t,s,i)=>{const r=_t(e,gt,t,s,i);if(r.length>=2)return[r[0],r[1]];if(1===r.length){const n=_t(e,pt,t,s,i);if(n.length>=1)return[n[0],r[0]];const o=_t(e,mt,t,s,i);return o.length>=1?[r[0],o[0]]:0===l(0,1)?[null,r[0]]:[r[0],null]}const n=_t(e,pt,t,s,i);if(n.length>=1)return[n[0],null];const o=_t(e,mt,t,s,i);return o.length>=1?[null,o[0]]:[null,null]})(i,e,t,s);return this.targetPeers={forwardPeer:r,reversePeer:n},[r,n].some((e=>!!e))}reportTraffic(e,t,s){const{fetcher:i}=this.engine;i&&(e>0&&i.reportFlow(e),t>0&&i.reportDCTraffic(t,s))}notifyAllPeers(e,t,s,i=gt){if(!s)return void this.logger.error("segId is required");if(this.downloadOnly)return;const{live:r}=this.config;if(this.bitset.has(e,t,i))return;const n=((e,t,s)=>`${e}-${t}-${s}`)(e,t,i);let o;i!==mt&&(o=i===gt);const a=this.requestingMap.get(e,t);for(let h of this.getPeers())a&&a.hasPeer(h)||h.notifySet.has(n)||h.bitset.hasCompleteOr(e,t,i)||h.uploading||(h.sendMsgHave(e,s,{level:t,reverse:i===mt,complete:o}),h.notifySet.add(n),r&&p(h.notifySet,20))}checkPeers(){if(!this.hasPeers)return;const{logger:e,config:t,engine:s}=this,i=t.live,{currentLevel:r}=s;if(e.info(`currentLevel ${r}`),0===this.bitCounts.size(r))return;if(!i&&this.nextLostSN>=0&&this.nextLostSN>=this.currPlaySN-10)return;if(this.mBufferedDuration<this.allowP2pLimit&&(0!==this.mBufferedDuration||this.isHlsjs))return void e.info(`low buffer time ${this.mBufferedDuration}, skip prefetch`);const n=this.peerManager.getPeersOrderByWeight();if(0===n.length)return;const o=[];let{prefetchNum:a,endSN:h,startSN:c}=t;i&&(a=1);let d=0,u=this.loadingSN+1;if(!i)if(this.loadingSN>=h&&!this.bufMgr.overflowed)u=c;else{const e=Math.min(...n.filter((e=>e.endSN>=u)).map((e=>e?e.startSN:1/0)));if(!isFinite(e))return;u<e&&(u=e)}for(;o.length<a&&o.length<n.length&&d<this.maxPrefetchCount;){if(!i&&u>h)return;if(i&&u>this.loadingSN+2)return;if(this.bitset.has(u,r))u++;else{if(u!==this.loadingSN&&this.bitCounts.has(u,r)&&!this.requestingMap.has(u,r))for(let s of n)if(!o.includes(s)&&s.bitset.has(u,r)){const i=s.bitset.getState(u,r);let n;n=i===gt?0===l(0,1):i===mt,o.push(s);const a=s.bitset.getSegId(u,r),h=new Tt(this.coordinator,this.logger,u,r,a,t.httpRangeSupported);this._setupSynthesizer(h),n?h.setReversePeer(s):h.setForwardPeer(s),this.requestingMap.set(u,r,h),s.requestDataBySN(u,!1,{level:r,reverse:n}),e.info(`request prefetch ${u} level ${r} from peer ${s.remotePeerId} downloadNum ${s.downloadNum} reverse ${n}`);break}d++,u++}}this.loadedPeerNum=o.length}onBufferManagerLost(e,t,s,i){this.currLostSN=e,s&&(this.nextLostSN=s),this.bitset.delete(e,i),this.bitCounts.delete(e,i)}cleanRequestingMap(e){const t=this.peerManager.getPeer(e);if(t)for(let[s,i]of this.requestingMap.internalMap){const r=s.split("-"),n=Number(r[1]),o=Number(r[0]);i.hasPeerId(e)&&(this.logger.info(`delete ${e} in synthesizer`),i.deletePeer(t),this.bitCounts.decre(n,o),t.bitset.delete(n,o))}}shouldWaitForNextSeg(){let e;return e=!this.isUploader&&(!!this.isReceiver||l(0,100)>20),this.isReceiver=this.isUploader=!1,e}updateLoaded(e,t,s){this.bitset.hasCompleteOr(e,t)||(this.bitset.add(e,t,s,gt),this.bitCounts.delete(e,t))}broadcastPlaylist(e,t){if(!this.config.live)return;const s=function(e){const t=e.split("\n");let s=0,i=0;for(let e of t){const t=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(e);if(t&&t[1]){s=parseInt(t[1],10);break}}for(let e of t)e.startsWith("#EXTINF")&&i++;return s+i-1}(t);if(!this.isMobileNet)for(let i of this.getPeers())i.sendMsgPlaylist(e,t,s);this.playlistInfo.set(e,{seq:s,data:t})}getPlaylistFromPeer(e){if(!this.config.live)return null;const{seq:t,data:s}=this.playlistInfo.get(e);for(let s of this.getPeers()){const i=s.getLatestPlaylist(e,t);if(i)return this.playlistInfo.set(e,i),i}return null}getBufferedDuration(){let{media:e,currentSrc:t}=this.engine;if(!e||e.src!==t&&0===e.currentTime){if(this.logger.info("try get video element"),e=function(e,t){let s;if(e&&("string"==typeof e?s=document.querySelector(e):e instanceof HTMLMediaElement&&(s=e)),!s){const e=[...document.getElementsByTagName("video"),...document.getElementsByTagName("audio")];1===e.length?s=e[0]:(t&&(s=e.find((e=>e.src===t))),s||(s=e.find((e=>e.currentTime>0))))}return s}(this.config.mediaElem,t),!e)return 5;this.engine.media=e}let s=0,i=e.currentTime,r=e.buffered;for(let e=r.length-1;e>=0;e--)if(i>=r.start(e)&&i<=r.end(e)){s=r.end(e)-i;break}return this.mBufferedDuration=s,s>0?s:0}destroy(){super.destroy(),this.requestingMap.clear(),this.segmentBuilderMap.clear()}_handleSynOutput(e){e>0?this.httpTimeouts++:this.httpTimeouts>0&&this.httpTimeouts--}_notifySynthesizer(e,t,s,i,r,n=!0){const{logger:o}=this,a=this.requestingMap.get(s,i);if(!a)return;const h=a.segId;function l(r,n){n?e.requestDataById(t,s,!0,{level:i,reverse:r}):(o.info(`notify syn prefetch ${s}`),e.requestDataBySN(s,!1,{level:i,reverse:r}))}function c(){return r===pt||r===gt}function d(){return r===mt||r===gt}t&&h&&t!==h?o.warn(`notifySynthesizer segId ${t} not match ${h}`):a.isFull()||(a.isAlmostDeadline()?o.info("almost deadline, ignored"):a.isEmpty()?a.hasForwardBuffer()&&d()?(a.setReversePeer(e),l(!0,n)):a.hasReverseBuffer()&&c()&&(a.setForwardPeer(e),l(!1,n)):!a.hasForwardPeer()&&c()?(a.setForwardPeer(e),l(!1,n)):!a.hasReversePeer()&&d()&&(a.setReversePeer(e),l(!0,n)))}_setupEngine(){}getStatsForPeer(){const{currentLevel:e,media:t}=this.engine,s={level:e};if(t&&!this.config.live){const{currentTime:e}=t;s.pos=Math.round(e)}return s}_handleSynError(e){switch(e){case Ze:this.logger.warn("ERROR_SYN_RANGE_REQUEST"),this.httpRangeErrs++;break;case et:this.logger.warn("ERROR_SYN_HTTP_TIMEOUT"),this.httpTimeouts+=3}this.httpRangeErrs>=5&&(this.config.httpLoadTime<=4.5&&(this.config.httpLoadTime+=.5),this.httpRangeErrs=0)}}class It extends Ct{constructor(e,t){super(e,t),this.logger.info("use HlsScheduler"),this.isHlsjs=!0,this.resolveMap=new Map}load(e,t,s,i,r){const{logger:n,config:o}=this;this.isReceiver=!0;let a=this.mBufferedDuration-o.httpLoadTime;a>this.dcDownloadTimeout&&(a=this.dcDownloadTimeout);const{forwardPeer:h,reversePeer:l}=this.targetPeers;h||l||(a-=1);let c=this.requestingMap.get(e,s),d=0,u=0;if(r.Range){const e=r.Range.substring(6);d=Number(e.split("-")[0]),u=Number(e.split("-")[1]),delete r.Range}let f={rangeStart:Number(d),rangeEnd:Number(u)+1,url:i,httpLoadTime:1e3*o.httpLoadTime-500,headers:r};c?c.setExtra(f):(c=new Tt(this.coordinator,this.logger,e,s,t,this.httpRangeSupported,f),this._setupSynthesizer(c),this.requestingMap.set(e,s,c)),c.setTimeout(1e3*a),h&&(c.setForwardPeer(h),h.requestDataById(t,e,!0,{level:s})),l&&(c.setReversePeer(l),l.requestDataById(t,e,!0,{level:s,reverse:!0}));const g=new Promise((i=>{const r={resolve:i,sn:e,level:s,segId:t};this.resolveMap.set(e,r)}));return this.targetPeers={},g}_setupSynthesizer(e){e.on(Qe.SYN_OUTPUT,((t,s)=>{const{config:i,logger:r}=this,{segId:n,sn:o,data:a,level:h}=t,{speed:l,http:c,p2p:d}=s;this.httpTimeouts>0&&this.httpTimeouts--;const u=this.resolveMap.has(o);if(i.validateSegment(n,new Uint8Array(a))){this.notifyAllPeers(o,h,n),this.bitset.has(o,h)||this.reportTraffic(c,d,l);const s=e.getFromPeerId();if(u){r.info(`receive criticalSeg seg_id ${n}`);const e=this.resolveMap.get(o);this.resolveMap.delete(o),e.resolve({data:a,fromPeerId:s})}else this.bitset.has(o,h)||(this.bufMgr.putSeg(t),this.updateLoaded(o,h,n))}else if(r.error(`segment ${n} validate failed`),u){const e=this.resolveMap.get(o);this.resolveMap.delete(o),e.resolve()}this.requestingMap.delete(o,h)})).on(Qe.SYN_ERROR,((e,t)=>{const{sn:s,level:i}=e;if(this.resolveMap.has(s)){const e=this.resolveMap.get(s);this.resolveMap.delete(s),e.resolve()}this.requestingMap.delete(s,i)}))}destroy(){super.destroy(),this.logger.warn("destroy HlsSwScheduler")}onFragLoading(e,t,s){this.loadingSN=e,this.isMobileNet||this.notifyAllPeers(e,t,s,pt)}onFragLoaded(e,t,s,i){if(i&&this.notifyAllPeers(e,t,s),this.updateLoaded(e,t,s),!this.engine)return;const{media:r,targetDuration:n}=this.engine;!this.config.live&&r&&n&&(this.currPlaySN=Math.ceil(r.currentTime/n))}_handleDCHave(e,t,s,i,r){const n=0!==this.resolveMap.size;n&&this.resolveMap.has(t)?this._notifySynthesizer(e,i,t,s,r):this.httpTimeouts>=1&&t===this.loadingSN+1&&this._notifySynthesizer(e,void 0,t,s,r,!1),this.config.live&&!n&&b()((()=>{this.checkPeers()}))}getBufferedDuration(){if(!this.engine.media)return 0;const e=dt(this.engine.media);return this.mBufferedDuration=e,e>0?e:0}}class Nt{static parse(e,t,s,i,r){const n=new window.Headers;(function(e){const t=new Map;for(const s of Object.keys(e))t.set(s,e[s]);return t})(t.headers).forEach(((e,t)=>{n.append(t,e)}));const o=new window.AbortController,a={body:t.body||void 0,headers:n,method:t.method,signal:o.signal,credentials:t.allowCrossSiteCredentials?"include":void 0},h={canceled:!1,timedOut:!1},l=Nt.request_(e,s,a,h,i,r,t.streamDataCallback),c=new shaka.util.AbortableOperation(l,(()=>(h.canceled=!0,o.abort(),Promise.resolve()))),d=t.retryParameters.timeout;if(d){const e=new shaka.util.Timer((()=>{h.timedOut=!0,o.abort()}));e.tickAfter(d/1e3),c.finally((()=>{e.stop()}))}return c}static async request_(e,t,s,i,n,a,h){const l=window.fetch,c=window.ReadableStream;let d,u,g=0,p=Date.now();try{d=await l(e,s),a&&a(Nt.headersToGenericObject_(d.headers));const t=d.clone().body.getReader(),i=d.headers.get("Content-Length"),m=i?parseInt(i,10):0,_=o;let y=0,v=0,b=(0,r.l)(0);new c({start:e=>{const s=async()=>{let i;try{i=await t.read()}catch(e){return void console.error("error reading from stream",e.message)}const{value:o,done:a}=i,l=Date.now();o&&(y+=o.length);let c=l-p,d=g-0,u=m-g;if(a||(g+=o.byteLength,h&&await h(i.value)),a){if(b.byteLength>0)if(y<=_){const e=(0,r.l)(y);b.copy(e,0,v*_,b.byteLength),n(c,d,0,{buffers:[e],aborted:!1})}else{const e=f(b,v*_);n(c,d,0,{buffers:e,aborted:!1})}e.close()}else{if(b=r.l.concat([b,o]),y>=_){y-=_;const e=(0,r.l)(_);b.copy(e,0,v*_,(v+1)*_),v++,n(c,d,u,{buffers:[e],aborted:!1})}e.enqueue(o),s()}};s()}}),u=await d.arrayBuffer()}catch(s){throw n(0,0,0,{buffers:[],aborted:!0}),i.canceled?new shaka.util.Error(shaka.util.Error.Severity.RECOVERABLE,shaka.util.Error.Category.NETWORK,shaka.util.Error.Code.OPERATION_ABORTED,e,t):i.timedOut?new shaka.util.Error(shaka.util.Error.Severity.RECOVERABLE,shaka.util.Error.Category.NETWORK,shaka.util.Error.Code.TIMEOUT,e,t):new shaka.util.Error(shaka.util.Error.Severity.RECOVERABLE,shaka.util.Error.Category.NETWORK,shaka.util.Error.Code.HTTP_ERROR,e,s,t)}return function(e,t,s,i,r,n){if(s>=200&&s<=299&&202!=s){return{uri:r||i,originalUri:i,data:t,status:s,headers:e,fromCache:!!e["x-shaka-from-cache"]}}{let r=null;try{r=shaka.util.StringUtils.fromBytesAutoDetect(t)}catch(e){}console.error("HTTP error text:",r);const o=401==s||403==s?shaka.util.Error.Severity.CRITICAL:shaka.util.Error.Severity.RECOVERABLE;throw new shaka.util.Error(o,shaka.util.Error.Category.NETWORK,shaka.util.Error.Code.BAD_HTTP_STATUS,i,s,r,e,n)}}(Nt.headersToGenericObject_(d.headers),u,d.status,e,d.url,t)}static headersToGenericObject_(e){const t={};return e.forEach(((e,s)=>{t[s.trim()]=e})),t}static isSupported(){if(!window.ReadableStream)return!1;try{new ReadableStream({})}catch(e){return!1}return!(!window.fetch||!window.AbortController)}}class Lt{constructor(e,t){this.bufferList=[],this.streamListeners=[],this.finished=!1,this.source="HttpStream",this.packetSize=o,this.attachments=t%this.packetSize==0?t/this.packetSize:Math.floor(t/this.packetSize)+1,this.pieceMsg={event:T.DC_PIECE,attachments:this.attachments,seg_id:e,size:t}}receiveBytes(e,t){e.byteLength&&(this.bufferList.push(e),t&&(this.finished=!0),this._notifyStreamListeners(e))}destroy(){this.finished||this._notifyStreamListenersAbort()}addStreamListener(e,t,s){this.streamListeners.push({handler:s,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_notifyStreamListenersAbort(){const{sn:e,seg_id:t}=this.pieceMsg;for(let s of this.streamListeners){const{handler:i}=s;i(e,t,!0,"aborted by httpLoader")}this.streamListeners.length=0}_notifyStreamListeners(e){const{sn:t,seg_id:s}=this.pieceMsg;for(let i of this.streamListeners){const{handler:r}=i;r(t,s,!1,e,this.finished)}this.finished&&(this.streamListeners.length=0)}}class Dt{constructor(e,t,s,i){this.bufferList=[],this.streamListeners=[],this.finished=!1,this.packetSize=o,this.attachments=i%this.packetSize==0?i/this.packetSize:Math.floor(i/this.packetSize)+1,this.pieceMsg={event:T.DC_PIECE,attachments:this.attachments,seg_id:s,sn:e,level:t,size:i,reverse:!1},this.sink=(0,r.l)(0),this.source="HttpStream"}receiveBytes(e,t){e.byteLength&&(this.sink=r.l.concat([this.sink,e]),this.bufferList.push(e),t&&(this.finished=!0),this._notifyStreamListeners(e))}getCompleteBuffer(){return this.sink.buffer}destroy(){this.finished||this._notifyStreamListenersAbort()}addStreamListener(e,t,s){this.streamListeners.push({handler:s,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_notifyStreamListenersAbort(){for(let e of this.streamListeners){const{handler:t}=e;t(void 0,void 0,!0,"aborted by httpLoader")}this.streamListeners.length=0}_notifyStreamListeners(e){const{sn:t,seg_id:s}=this.pieceMsg;for(let i of this.streamListeners){const{handler:r}=i;r(t,s,!1,e,this.finished)}this.finished&&(this.streamListeners.length=0)}}class Rt{constructor(){this.method=null,this.key=null,this.iv=null,this._uri=null}get uri(){return!this._uri&&this.reluri&&(this._uri=e.buildAbsoluteURL(this.baseuri,this.reluri,{alwaysNormalize:!0})),this._uri}}class Mt{constructor(){this._url=null,this._byteRange=null,this._decryptdata=null,this.tagList=[],this.programDateTime=null,this.rawProgramDateTime=null,this._elementaryStreams={[Mt.ElementaryStreamTypes.AUDIO]:!1,[Mt.ElementaryStreamTypes.VIDEO]:!1}}static get ElementaryStreamTypes(){return{AUDIO:"audio",VIDEO:"video"}}get url(){return!this._url&&this.relurl&&(this._url=e.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url}set url(e){this._url=e}get byteRange(){if(!this._byteRange&&!this.rawByteRange)return[];if(this._byteRange)return this._byteRange;let e=[];if(this.rawByteRange){const t=this.rawByteRange.split("@",2);if(1===t.length){const t=this.lastByteRangeEndOffset;e[0]=t||0}else e[0]=parseInt(t[1]);e[1]=parseInt(t[0])+e[0],this._byteRange=e}return e}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get decryptdata(){return this._decryptdata||(this._decryptdata=this.fragmentDecryptdataFromLevelkey(this.levelkey,this.sn)),this._decryptdata}get endProgramDateTime(){if(!Number.isFinite(this.programDateTime))return null;let e=Number.isFinite(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){return!(!this.decryptdata||null===this.decryptdata.uri||null!==this.decryptdata.key)}addElementaryStream(e){this._elementaryStreams[e]=!0}hasElementaryStream(e){return!0===this._elementaryStreams[e]}createInitializationVector(e){let t=new Uint8Array(16);for(let s=12;s<16;s++)t[s]=e>>8*(15-s)&255;return t}fragmentDecryptdataFromLevelkey(e,t){let s=e;return e&&e.method&&e.uri&&!e.iv&&(s=new Rt,s.method=e.method,s.baseuri=e.baseuri,s.reluri=e.reluri,s.iv=this.createInitializationVector(t)),s}}class At{constructor(e){this.endCC=0,this.endSN=0,this.fragments=[],this.initSegment=null,this.live=!0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=e,this.version=null}get hasProgramDateTime(){return!(!this.fragments[0]||!Number.isFinite(this.fragments[0].programDateTime))}}const Ot=/^(\d+)x(\d+)$/,kt=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class xt{constructor(e){"string"==typeof e&&(e=xt.parseAttrList(e));for(let t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const s=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)s[e]=parseInt(t.slice(2*e,2*e+2),16);return s}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}enumeratedString(e){return this[e]}decimalResolution(e){const t=Ot.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t,s={};for(kt.lastIndex=0;null!==(t=kt.exec(e));){let e=t[2],i='"';0===e.indexOf(i)&&e.lastIndexOf(i)===e.length-1&&(e=e.slice(1,-1)),s[t[1]]=e}return s}}const Bt=xt,$t={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0}};const Ut=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,qt=/#EXT-X-MEDIA:(.*)/g,zt=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/|(?!#)([\S+ ?]+)/.source,/|#EXT-X-BYTERANGE:*(.+)/.source,/|#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/|#.*/.source].join(""),"g"),Ft=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:(#)([^:]*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,Ht=/\.(mp4|m4s|m4v|m4a)$/i;class Wt{static findGroup(e,t){if(!e)return null;let s=null;for(let i=0;i<e.length;i++){const r=e[i];r.id===t&&(s=r)}return s}static convertAVC1ToAVCOTI(e){let t,s=e.split(".");return s.length>2?(t=s.shift()+".",t+=parseInt(s.shift()).toString(16),t+=("000"+parseInt(s.shift()).toString(16)).substr(-4)):t=e,t}static resolve(t,s){return e.buildAbsoluteURL(s,t,{alwaysNormalize:!0})}static parseMasterPlaylist(e,t){let s,i=[];function r(e,t){["video","audio"].forEach((s=>{const i=e.filter((e=>function(e,t){const s=$t[t];return!!s&&!0===s[e.slice(0,4)]}(e,s)));if(i.length){const r=i.filter((e=>0===e.lastIndexOf("avc1",0)||0===e.lastIndexOf("mp4a",0)));t[`${s}Codec`]=r.length>0?r[0]:i[0],e=e.filter((e=>-1===i.indexOf(e)))}})),t.unknownCodecs=e}for(Ut.lastIndex=0;null!=(s=Ut.exec(e));){const e={},n=e.attrs=new Bt(s[1]);e.url=Wt.resolve(s[2],t);const o=n.decimalResolution("RESOLUTION");o&&(e.width=o.width,e.height=o.height),e.bitrate=n.decimalInteger("AVERAGE-BANDWIDTH")||n.decimalInteger("BANDWIDTH"),e.name=n.NAME,r([].concat((n.CODECS||"").split(/[ ,]+/)),e),e.videoCodec&&-1!==e.videoCodec.indexOf("avc1")&&(e.videoCodec=Wt.convertAVC1ToAVCOTI(e.videoCodec)),i.push(e)}return i}static parseMasterPlaylistMedia(e,t,s,i=[]){let r,n=[],o=0;for(qt.lastIndex=0;null!==(r=qt.exec(e));){const e={},a=new Bt(r[1]);if(a.TYPE===s){if(e.groupId=a["GROUP-ID"],e.name=a.NAME,e.type=s,e.default="YES"===a.DEFAULT,e.autoselect="YES"===a.AUTOSELECT,e.forced="YES"===a.FORCED,a.URI&&(e.url=Wt.resolve(a.URI,t)),e.lang=a.LANGUAGE,e.name||(e.name=e.lang),i.length){const t=Wt.findGroup(i,e.groupId);e.audioCodec=t?t.codec:i[0].codec}e.id=o++,n.push(e)}}return n}static parseLevelPlaylist(e,t){let s,i,r=0,n=0,o=new At(t),a=new Rt,h=0,l=null,c=new Mt,d=null;for(zt.lastIndex=0;null!==(s=zt.exec(e));){const e=s[1];if(e){c.duration=parseFloat(e);const t=(" "+s[2]).slice(1);c.title=t||null,c.tagList.push(t?["INF",e,t]:["INF",e])}else if(s[3]){if(Number.isFinite(c.duration)){const e=r++;c.start=n,c.levelkey=a,c.sn=e,c.cc=h,c.baseurl=t,c.relurl=(" "+s[3]).slice(1),jt(c,l),o.fragments.push(c),l=c,n+=c.duration,c=new Mt}}else if(s[4]){if(c.rawByteRange=(" "+s[4]).slice(1),l){const e=l.byteRangeEndOffset;e&&(c.lastByteRangeEndOffset=e)}}else if(s[5])c.rawProgramDateTime=(" "+s[5]).slice(1),c.tagList.push(["PROGRAM-DATE-TIME",c.rawProgramDateTime]),null===d&&(d=o.fragments.length);else{for(s=s[0].match(Ft),i=1;i<s.length&&void 0===s[i];i++);const e=(" "+s[i+1]).slice(1),n=(" "+s[i+2]).slice(1);switch(s[i]){case"#":c.tagList.push(n?[e,n]:[e]);break;case"PLAYLIST-TYPE":o.type=e.toUpperCase();break;case"MEDIA-SEQUENCE":r=o.startSN=parseInt(e);break;case"TARGETDURATION":o.targetduration=parseFloat(e);break;case"VERSION":o.version=parseInt(e);break;case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"DIS":h++,c.tagList.push(["DIS"]);break;case"DISCONTINUITY-SEQ":h=parseInt(e);break;case"KEY":var u=new Bt(e),f=u.enumeratedString("METHOD"),g=u.URI,p=u.hexadecimalInteger("IV");f&&(a=new Rt,g&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(f)>=0&&(a.method=f,a.baseuri=t,a.reluri=g,a.key=null,a.iv=p));break;case"START":let i=new Bt(e).decimalFloatingPoint("TIME-OFFSET");Number.isFinite(i)&&(o.startTimeOffset=i);break;case"MAP":let l=new Bt(e);c.relurl=l.URI,c.rawByteRange=l.BYTERANGE,c.baseurl=t,c.sn="initSegment",o.initSegment=c,c=new Mt,c.rawProgramDateTime=o.initSegment.rawProgramDateTime;break;default:console.warn(`line parsed but not handled: ${s}`)}}}return c=l,c&&!c.relurl&&(o.fragments.pop(),n-=c.duration),o.totalduration=n,o.averagetargetduration=n/o.fragments.length,o.endSN=r-1,o.startCC=o.fragments[0]?o.fragments[0].cc:0,o.endCC=h,!o.initSegment&&o.fragments.length&&o.fragments.every((e=>Ht.test(e.relurl)))&&(console.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),c=new Mt,c.relurl=o.fragments[0].relurl,c.baseurl=t,c.level=id,c.sn="initSegment",o.initSegment=c,o.needSidxRanges=!0),d&&function(e,t){let s=e[t];for(let i=t-1;i>=0;i--){const t=e[i];t.programDateTime=s.programDateTime-1e3*t.duration,s=t}}(o.fragments,d),o}}function jt(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),Number.isFinite(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}const Gt="store not init";function Xt(e){return new Promise(((t,s)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>s(e.error)}))}function Vt(e,t){return t?t("readonly",(t=>Xt(t.get(e)))):Promise.reject(Gt)}function Yt(e,t,s){return s?s("readwrite",(s=>(s.put(t,e),Xt(s.transaction)))):Promise.reject(Gt)}function Qt(e,t){return t?t("readwrite",(t=>(t.delete(e),Xt(t.transaction)))):Promise.reject(Gt)}function Jt(e){return e?e("readwrite",(e=>(e.clear(),Xt(e.transaction)))):Promise.reject(Gt)}function Kt(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},Xt(e.transaction)}const Zt="size";class es extends(y()){constructor(e,t){super(),this.name="SegmentStore",this.logger=t.logger,this.logger.info("use SegmentStore"),this.channel=e.channel;const s=e.browserInfo.device;this.isPC=s===N().device.PC_WEB||s===N().device.PC_NATIVE,this.maxBufSize=this.isPC?t.diskCacheLimit.pc:t.diskCacheLimit.mobile,this.overflowed=!1,this.loadingSN=0}async setupStore(){if(navigator.storage&&navigator.storage.estimate){const e=await navigator.storage.estimate(),t=Math.floor(e.quota-e.usage);t<this.maxBufSize&&(this.maxBufSize=t-104857600)}return new Promise((async(e,t)=>{if(this.isPC&&this.maxBufSize<419430400||!this.isPC&&this.maxBufSize<104857600)return void t("disk storage not enough");const s=["segments","id2Sn","metadata"];let i;try{i=function(e,t){const s=indexedDB.open(e);s.onupgradeneeded=()=>{const e=s.result;t.forEach((t=>{e.createObjectStore(t)}))};const i=Xt(s);return t.map((e=>(t,s)=>i.then((i=>s(i.transaction(e,t).objectStore(e))))))}(this.channel,s)}catch(e){return void t(e)}this.segmentsStore=i[0],this.id2SnStore=i[1],this.metaStore=i[2];const r=setTimeout((()=>{t("setupStore timeout")}),500);this._initMetaStore().then((()=>{clearTimeout(r),e()})).catch((e=>{t(e)}))}))}_initMetaStore(){return this.logger.info("init MetaStore size"),Yt(Zt,0,this.metaStore)}currBufSize(){return Vt(Zt,this.metaStore)}async hasSegOfId(e){if(!e)return Promise.resolve(!1);const t=await Vt(e,this.id2SnStore);return new Promise(((s,i)=>{void 0!==t?Vt(t,this.segmentsStore).then((t=>{t&&t.length>0&&t.some((t=>t.segId===e))?s(!0):s(!1)})).catch((e=>{this.logger.error(e),s(!1)})):s(!1)}))}async getSegById(e){if(!e)return null;const t=await Vt(e,this.id2SnStore);return new Promise(((e,s)=>{void 0!==t?Vt(t,this.segmentsStore).then((t=>{if(t&&t.length>0){const s=t[0];if(!m(s.data))return this.logger.error(`getSegById ${s.sn} is not buffer`),void e(null);e(C.fromSegment(s))}else e(null)})).catch((t=>{this.logger.error(t),e(null)})):e(null)}))}getSegIdBySN(e){return new Promise(((t,s)=>{Vt(e,this.segmentsStore).then((e=>{e&&e.length>0?t(e[0].segId):t(null)})).catch((e=>{this.logger.error(e),t(null)}))}))}putSeg(e){const{logger:t}=this;m(e.data)?this._addSeg(e).then((e=>{this.emit(`${T.BM_ADDED_SN_}${e.sn}`,e),this.emit(T.BM_SEG_ADDED,e)})).catch((e=>{e&&(t.error(e),("QuotaExceededError"===e.name||e.inner&&"QuotaExceededError"===e.inner.name)&&this._trimDisk(!0))})):t.error(`putSeg ${e.sn} is not buffer`)}_addSeg(e){const{segId:t,sn:s}=e;return Yt(t,s,this.id2SnStore),new Promise(((i,r)=>{Vt(s,this.segmentsStore).then((n=>{n?0===n.filter((e=>e.segId===t)).length&&(n.push(this._segmentToCache(e)),Yt(s,n,this.segmentsStore).then((()=>{this._increaseBufSize(e.data.byteLength),i(e)})).catch((e=>{r(e)}))):Yt(s,[this._segmentToCache(e)],this.segmentsStore).then((()=>{this._increaseBufSize(e.data.byteLength),i(e)})).catch((e=>{r(e)}))})).catch((e=>{r(e)}))}))}async _trimDisk(e=!1){let t=this.maxBufSize;const{logger:s}=this;let i=await this.currBufSize();var r;(e&&(t=i-104857600,t<0&&(t=0)),i<t)||(r=this.segmentsStore,r?r("readonly",(e=>{if(e.getAllKeys)return Xt(e.getAllKeys());const t=[];return Kt(e,(e=>t.push(e.key))).then((()=>t))})):Promise.reject(Gt)).then((async e=>{const r=e.sort(((e,t)=>e-t));let n=0;do{if(n++>10){console.error("too much loops in SegmentStore");break}const e=r.shift();if(void 0===e){s.error("lastSN not found");continue}if(e>=this.loadingSN){s.warn(`trimDisk failed, loadingSN ${this.loadingSN}`);break}const t=r[0],o=await Vt(e,this.segmentsStore);if(!o){s.warn("lastSeg not found");continue}let a=0;o.forEach((e=>{a+=e.data.byteLength})),Qt(e,this.segmentsStore).then((()=>{this._decreaseBufSize(parseInt(a))})),o.forEach((i=>{Qt(i.segId,this.id2SnStore),s.info(`pop seg ${i.segId} size ${i.data.byteLength}`),this.emit(T.BM_LOST,{sn:e,segId:i.segId,next:t,level:i.level})})),i-=a,s.info(`pop sn ${e} size ${a} currBufSize ${i}`),this.overflowed||(this.overflowed=!0)}while(i>=t)}))}_decreaseBufSize(e){Vt(Zt,this.metaStore).then((t=>{t&&Yt(Zt,t-e,this.metaStore)})).catch((e=>{this.logger.error(e)}))}_increaseBufSize(e){Vt(Zt,this.metaStore).then((t=>{Yt(Zt,t+e,this.metaStore),this._trimDisk()})).catch((e=>{this.logger.error(e)}))}_segmentToCache(e){return{data:e.data,level:e.level,segId:e.segId,sn:e.sn}}clear(){this.logger.warn("clear segment store");try{this._clearDisk()}catch(e){}}_clearDisk(){Jt(this.segmentsStore),Jt(this.id2SnStore),Jt(this.metaStore)}destroy(){this.clear(),this.removeAllListeners()}}const ts=es;class ss extends(y()){constructor(e,t){super(),this.name="SegmentCache",this.logger=t.logger,this.logger.info("use SegmentCache");const s=e.browserInfo.device;if(this.maxBufSize=s===N().device.PC_WEB||s===N().device.PC_NATIVE?t.memoryCacheLimit.pc:t.memoryCacheLimit.mobile,t.live)this.maxBufSize=31457280;else{if(0===this.maxBufSize)throw new Error("cannot use SegmentCache");const e=function(){const{memory:e}=performance;return e?e.jsHeapSizeLimit-e.usedJSHeapSize:-1}();e>=0&&e<this.maxBufSize&&(this.maxBufSize=e-31457280)}this._segPool=new Map,this._currBufSize=0,this.id2Sn=new Map,this.overflowed=!1,this.loadingSN=0}get currBufSize(){return this._currBufSize}hasSegOfId(e){return new Promise(((t,s)=>{const i=this.id2Sn.get(e);this._segPool.has(i)?t(this._segPool.get(i).some((t=>t.segId===e))):t(!1)}))}getSegById(e){const t=this.id2Sn.get(e);return new Promise(((s,i)=>{if(!this._segPool.has(t))return void s(null);const r=this._segPool.get(t);for(let t of r)if(t.segId===e)return void s(t);s(null)}))}getSegIdBySN(e){return new Promise(((t,s)=>{if(this._segPool.has(e)){t(this._segPool.get(e)[0].segId)}else t(null)}))}_calSegPoolSize(){let e=0;return this._segPool.forEach((t=>{t.forEach((t=>{e+=t.size}))})),e}putSeg(e){this._currBufSize>=1.5*this.maxBufSize&&(this._currBufSize=this._calSegPoolSize(),this._currBufSize>=1.5*this.maxBufSize&&(this.clear(),this.overflowed=!1)),m(e.data)?this._addSeg(e):this.logger.error(`putSeg ${e.sn} is not buffer`)}_addSeg(e){const{logger:t}=this,{segId:s,sn:i,size:r}=e;if(this.id2Sn.set(s,i),this._segPool.has(i)){this._segPool.get(i).push(e)}else this._segPool.set(i,[e]);this._currBufSize+=parseInt(r);const n=this._segPool.size;if(this.emit(`${T.BM_ADDED_SN_}${e.sn}`,e),this.emit(T.BM_SEG_ADDED,e),this._currBufSize<this.maxBufSize||n<=5)return;const o=Array.from(this._segPool.keys()).sort(((e,t)=>e-t));let a=0;do{if(a++>10){console.error("too much loops in SegmentCache");break}const e=o.shift();if(void 0===e){t.error("lastSN not found");continue}const s=o[0],i=this._segPool.get(e);if(!i){t.error("lastSeg not found");continue}let r=0;i.forEach((e=>{r+=e.size})),this._currBufSize-=parseInt(r),this._segPool.delete(e),i.forEach((t=>{this.id2Sn.delete(t.segId),this.emit(T.BM_LOST,{sn:e,segId:t.segId,next:s,level:t.level})})),t.info(`pop sn ${e} size ${r} currBufSize ${this._currBufSize}`),this.overflowed||(this.overflowed=!0)}while(this._currBufSize>=this.maxBufSize&&this._segPool.size>5)}clear(){this.logger.warn("clear segment cache"),this._segPool.clear(),this.id2Sn.clear(),this._currBufSize=0}destroy(){this.clear(),this.removeAllListeners()}}const is=ss,rs=e=>!!e&&"object"==typeof e,ns=(...e)=>e.reduce(((e,t)=>("object"!=typeof t||Object.keys(t).forEach((s=>{Array.isArray(e[s])&&Array.isArray(t[s])?e[s]=e[s].concat(t[s]):rs(e[s])&&rs(t[s])?e[s]=ns(e[s],t[s]):e[s]=t[s]})),e)),{}),os=e=>Object.keys(e).map((t=>e[t])),as=e=>e.reduce(((e,t)=>e.concat(t)),[]),hs=e=>{if(!e.length)return[];const t=[];for(let s=0;s<e.length;s++)t.push(e[s]);return t},ls="INVALID_NUMBER_OF_PERIOD",cs="DASH_EMPTY_MANIFEST",ds="DASH_INVALID_XML",us="NO_BASE_URL",fs="SEGMENT_TIME_UNSPECIFIED";function gs(e){const t=(s=e,window.atob?window.atob(s):Buffer.from(s,"base64").toString("binary"));var s;const i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i}const ps="http://example.com",ms=(e,s)=>{if(/^[a-z]+:/i.test(s))return s;/^data:/.test(e)&&(e=window.location&&window.location.href||"");const i="function"==typeof window.URL,r=/^\/\//.test(e),n=!window.location&&!/\/\//i.test(e);if(i?e=new window.URL(e,window.location||ps):/\/\//i.test(e)||(e=t().buildAbsoluteURL(window.location&&window.location.href||"",e)),i){const t=new URL(s,e);return n?t.href.slice(ps.length):r?t.href.slice(t.protocol.length):t.href}return t().buildAbsoluteURL(e,s)},_s=e=>{let t;return t="bigint"==typeof e.offset||"bigint"==typeof e.length?window.BigInt(e.offset)+window.BigInt(e.length)-window.BigInt(1):e.offset+e.length-1,`${e.offset}-${t}`},ys=({baseUrl:e="",source:t="",range:s="",indexRange:i=""})=>{const r={uri:t,resolvedUri:ms(e||"",t)};if(s||i){const e=(s||i).split("-");let t,n=window.BigInt?window.BigInt(e[0]):parseInt(e[0],10),o=window.BigInt?window.BigInt(e[1]):parseInt(e[1],10);n<Number.MAX_SAFE_INTEGER&&"bigint"==typeof n&&(n=Number(n)),o<Number.MAX_SAFE_INTEGER&&"bigint"==typeof o&&(o=Number(o)),t="bigint"==typeof o||"bigint"==typeof n?window.BigInt(o)-window.BigInt(n)+window.BigInt(1):o-n+1,"bigint"==typeof t&&t<Number.MAX_SAFE_INTEGER&&(t=Number(t)),r.byterange={length:t,offset:n}}return r},vs=e=>(e&&"number"!=typeof e&&(e=parseInt(e,10)),isNaN(e)?null:e),bs={static(e){const{duration:t,timescale:s=1,sourceDuration:i,periodDuration:r}=e,n=vs(e.endNumber),o=t/s;return"number"==typeof n?{start:0,end:n}:"number"==typeof r?{start:0,end:r/o}:{start:0,end:i/o}},dynamic(e){const{NOW:t,clientOffset:s,availabilityStartTime:i,timescale:r=1,duration:n,periodStart:o=0,minimumUpdatePeriod:a=0,timeShiftBufferDepth:h=1/0}=e,l=vs(e.endNumber),c=(t+s)/1e3,d=i+o,u=c+a-d,f=Math.ceil(u*r/n),g=Math.floor((c-d-h)*r/n),p=Math.floor((c-d)*r/n);return{start:Math.max(0,g),end:"number"==typeof l?l:Math.min(f,p)}}},Ss=e=>{const{type:t,duration:s,timescale:i=1,periodDuration:r,sourceDuration:n}=e,{start:o,end:a}=bs[t](e),h=((e,t)=>{const s=[];for(let i=e;i<t;i++)s.push(i);return s})(o,a).map((e=>t=>{const{duration:s,timescale:i=1,periodStart:r,startNumber:n=1}=e;return{number:n+t,duration:s/i,timeline:r,time:t*s}})(e));if("static"===t){const e=h.length-1,t="number"==typeof r?r:n;h[e].duration=t-s/i*e}return h},ws=e=>{const{baseUrl:t,initialization:s={},sourceDuration:i,indexRange:r="",periodStart:n,presentationTime:o,number:a=0,duration:h}=e;if(!t)throw new Error(us);const l=ys({baseUrl:t,source:s.sourceURL,range:s.range}),c=ys({baseUrl:t,source:t,indexRange:r});if(c.map=l,h){const t=Ss(e);t.length&&(c.duration=t[0].duration,c.timeline=t[0].timeline)}else i&&(c.duration=i,c.timeline=n);return c.presentationTime=o||n,c.number=a,[c]},Ps=e=>{return(t=e,s=({timeline:e})=>e,os(t.reduce(((e,t)=>(t.forEach((t=>{e[s(t)]=t})),e)),{}))).sort(((e,t)=>e.timeline>t.timeline?1:-1));var t,s},Es=e=>os(e.reduce(((e,t)=>{const s=t.attributes.id+(t.attributes.lang||"");return e[s]?(t.segments&&(t.segments[0]&&(t.segments[0].discontinuity=!0),e[s].segments.push(...t.segments)),t.attributes.contentProtection&&(e[s].attributes.contentProtection=t.attributes.contentProtection)):(e[s]=t,e[s].attributes.timelineStarts=[]),e[s].attributes.timelineStarts.push({start:t.attributes.periodStart,timeline:t.attributes.periodStart}),e}),{})).map((e=>{var t,s;return e.discontinuityStarts=(t=e.segments||[],s="discontinuity",t.reduce(((e,t,i)=>(t[s]&&e.push(i),e)),[])),e})),Ts=(e,t)=>{const s=(i=e.sidx)&&i.uri+"-"+_s(i.byterange);var i;const r=s&&t[s]&&t[s].sidx;return r&&((e,t,s)=>{const i=e.sidx.map?e.sidx.map:null,r=e.sidx.duration,n=e.timeline||0,o=e.sidx.byterange,a=o.offset+o.length,h=t.timescale,l=t.references.filter((e=>1!==e.referenceType)),c=[],d=e.endList?"static":"dynamic",u=e.sidx.timeline;let f,g=u,p=e.mediaSequence||0;f="bigint"==typeof t.firstOffset?window.BigInt(a)+t.firstOffset:a+t.firstOffset;for(let e=0;e<l.length;e++){const o=t.references[e],a=o.referencedSize,l=o.subsegmentDuration;let m;m="bigint"==typeof f?f+window.BigInt(a)-window.BigInt(1):f+a-1;const _=ws({baseUrl:s,timescale:h,timeline:n,periodStart:u,presentationTime:g,number:p,duration:l,sourceDuration:r,indexRange:`${f}-${m}`,type:d})[0];i&&(_.map=i),c.push(_),f+="bigint"==typeof f?window.BigInt(a):a,g+=l/h,p++}e.segments=c})(e,r,e.sidx.resolvedUri),e},Cs=(e,t={})=>{if(!Object.keys(t).length)return e;for(const s in e)e[s]=Ts(e[s],t);return e},Is=({attributes:e,segments:t,sidx:s,discontinuityStarts:i})=>{const r={attributes:{NAME:e.id,AUDIO:"audio",SUBTITLES:"subs",RESOLUTION:{width:e.width,height:e.height},CODECS:e.codecs,BANDWIDTH:e.bandwidth,"PROGRAM-ID":1},uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:"",targetDuration:e.duration,discontinuityStarts:i,timelineStarts:e.timelineStarts,segments:t,bandwidth:e.bandwidth};return e.contentProtection&&(r.contentProtection=e.contentProtection),s&&(r.sidx=s),r},Ns=({attributes:e})=>"video/mp4"===e.mimeType||"video/webm"===e.mimeType||"video"===e.contentType,Ls=({attributes:e})=>"audio/mp4"===e.mimeType||"audio/webm"===e.mimeType||"audio"===e.contentType,Ds=({attributes:e})=>"text/vtt"===e.mimeType||"text"===e.contentType,Rs=e=>e?Object.keys(e).reduce(((t,s)=>{const i=e[s];return t.concat(i.playlists)}),[]):[],Ms=({dashPlaylists:e,locations:t,sidxMapping:s={}})=>{if(!e.length)return{};const{sourceDuration:i,type:r,suggestedPresentationDelay:n,minimumUpdatePeriod:o}=e[0].attributes,a=Es(e.filter(Ns)).map(Is),h=Es(e.filter(Ls)),l=Es(e.filter(Ds));a.sort(((e,t)=>e.bandwidth-t.bandwidth));const c={discontinuityStarts:[],segments:[],endList:!0,uri:"",duration:i,playlists:Cs(a,s)};o>=0&&(c.minimumUpdatePeriod=1e3*o),t&&(c.locations=t),"dynamic"===r&&(c.suggestedPresentationDelay=n);const d=0===c.playlists.length,u=h.length?((e,t={},s=!1)=>{let i;const r=e.reduce(((e,r)=>{const n=r.attributes.role&&r.attributes.role.value||"",o=r.attributes.lang||"";let a=r.attributes.label||"main";if(o&&!r.attributes.label){const e=n?` (${n})`:"";a=`${r.attributes.lang}${e}`}e[a]||(e[a]={language:o,autoselect:!0,default:"main"===n,playlists:[],uri:""});const h=Ts((({attributes:e,segments:t,sidx:s,mediaSequence:i,discontinuitySequence:r,discontinuityStarts:n},o)=>{const a={attributes:{NAME:e.id,BANDWIDTH:e.bandwidth,CODECS:e.codecs,"PROGRAM-ID":1},uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:"",targetDuration:e.duration,discontinuitySequence:r,discontinuityStarts:n,timelineStarts:e.timelineStarts,mediaSequence:i,segments:t};return e.contentProtection&&(a.contentProtection=e.contentProtection),s&&(a.sidx=s),o&&(a.attributes.AUDIO="audio",a.attributes.SUBTITLES="subs"),a})(r,s),t);return e[a].playlists.push(h),void 0===i&&"main"===n&&(i=r,i.default=!0),e}),{});i||(r[Object.keys(r)[0]].default=!0);return r})(h,s,d):null,f=l.length?((e,t={})=>e.reduce(((e,s)=>{const i=s.attributes.lang||"text";return e[i]||(e[i]={language:i,default:!1,autoselect:!1,playlists:[],uri:""}),e[i].playlists.push(Ts((({attributes:e,segments:t,mediaSequence:s,discontinuityStarts:i,discontinuitySequence:r})=>{void 0===t&&(t=[{uri:e.baseUrl,timeline:e.periodStart,resolvedUri:e.baseUrl||"",duration:e.sourceDuration,number:0}],e.duration=e.sourceDuration);const n={NAME:e.id,BANDWIDTH:e.bandwidth,"PROGRAM-ID":1};return e.codecs&&(n.CODECS=e.codecs),{attributes:n,uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:e.baseUrl||"",targetDuration:e.duration,timelineStarts:e.timelineStarts,discontinuityStarts:i,discontinuitySequence:r,mediaSequence:s,segments:t}})(s),t)),e}),{}))(l,s):null,g=a.concat(Rs(u),Rs(f)),p=g.map((({timelineStarts:e})=>e));var m,_;return c.timelineStarts=Ps(p),m=g,_=c.timelineStarts,m.forEach((e=>{e.mediaSequence=0,e.discontinuitySequence=((e,t)=>{for(let s=0;s<e.length;s++)if(t(e[s]))return s;return-1})(_,(({timeline:t})=>t===e.timeline)),e.segments&&e.segments.forEach(((e,t)=>{e.number=t}))})),c},As=(e,t,s)=>{const{NOW:i,clientOffset:r,availabilityStartTime:n,timescale:o=1,periodStart:a=0,minimumUpdatePeriod:h=0}=e,l=(i+r)/1e3+h-(n+a);return Math.ceil((l*o-t)/s)},Os=(e,t)=>{const{type:s,minimumUpdatePeriod:i=0,media:r="",sourceDuration:n,timescale:o=1,startNumber:a=1,periodStart:h}=e,l=[];let c=-1;for(let d=0;d<t.length;d++){const u=t[d],f=u.d,g=u.r||0,p=u.t||0;let m;if(c<0&&(c=p),p&&p>c&&(c=p),g<0){const a=d+1;m=a===t.length?"dynamic"===s&&i>0&&r.indexOf("$Number$")>0?As(e,c,f):(n*o-c)/f:(t[a].t-c)/f}else m=g+1;const _=a+l.length+m;let y=a+l.length;for(;y<_;)l.push({number:y,duration:f/o,time:c,timeline:h}),c+=f,y++}return l},ks=/\$([A-z]*)(?:(%0)([0-9]+)d)?\$/g,xs=(e,t)=>e.replace(ks,(e=>(t,s,i,r)=>{if("$$"===t)return"$";if(void 0===e[s])return t;const n=""+e[s];return"RepresentationID"===s?n:(r=i?parseInt(r,10):1,n.length>=r?n:`${new Array(r-n.length+1).join("0")}${n}`)})(t)),Bs=(e,t)=>{const s={RepresentationID:e.id,Bandwidth:e.bandwidth||0},{initialization:i={sourceURL:"",range:""}}=e,r=ys({baseUrl:e.baseUrl,source:xs(i.sourceURL,s),range:i.range}),n=((e,t)=>e.duration||t?e.duration?Ss(e):Os(e,t):[{number:e.startNumber||1,duration:e.sourceDuration,time:0,timeline:e.periodStart}])(e,t);return n.map((t=>{s.Number=t.number,s.Time=t.time;const i=xs(e.media||"",s),n=e.timescale||1,o=e.presentationTimeOffset||0,a=e.periodStart+(t.time-o)/n;return{uri:i,timeline:t.timeline,duration:t.duration,resolvedUri:ms(e.baseUrl||"",i),map:r,number:t.number,presentationTime:a}}))},$s=(e,t)=>{const{duration:s,segmentUrls:i=[],periodStart:r}=e;if(!s&&!t||s&&t)throw new Error(fs);const n=i.map((t=>((e,t)=>{const{baseUrl:s,initialization:i={}}=e,r=ys({baseUrl:s,source:i.sourceURL,range:i.range}),n=ys({baseUrl:s,source:t.media,range:t.mediaRange});return n.map=r,n})(e,t)));let o;s&&(o=Ss(e)),t&&(o=Os(e,t));return o.map(((t,s)=>{if(n[s]){const i=n[s],o=e.timescale||1,a=e.presentationTimeOffset||0;return i.timeline=t.timeline,i.duration=t.duration,i.number=t.number,i.presentationTime=r+(t.time-a)/o,i}})).filter((e=>e))},Us=({attributes:e,segmentInfo:t})=>{let s,i;t.template?(i=Bs,s=ns(e,t.template)):t.base?(i=ws,s=ns(e,t.base)):t.list&&(i=$s,s=ns(e,t.list));const r={attributes:e};if(!i)return r;const n=i(s,t.segmentTimeline);if(s.duration){const{duration:e,timescale:t=1}=s;s.duration=e/t}else n.length?s.duration=n.reduce(((e,t)=>Math.max(e,Math.ceil(t.duration))),0):s.duration=0;return r.attributes=s,r.segments=n,t.base&&s.indexRange&&(r.sidx=n[0],r.segments=[]),r},qs=(e,t)=>hs(e.childNodes).filter((({tagName:e})=>e===t)),zs=e=>e.textContent.trim(),Fs=e=>{const t=/P(?:(\d*)Y)?(?:(\d*)M)?(?:(\d*)D)?(?:T(?:(\d*)H)?(?:(\d*)M)?(?:([\d.]*)S)?)?/.exec(e);if(!t)return 0;const[s,i,r,n,o,a]=t.slice(1);return 31536e3*parseFloat(s||0)+2592e3*parseFloat(i||0)+86400*parseFloat(r||0)+3600*parseFloat(n||0)+60*parseFloat(o||0)+parseFloat(a||0)},Hs={mediaPresentationDuration:e=>Fs(e),availabilityStartTime(e){return/^\d+-\d+-\d+T\d+:\d+:\d+(\.\d+)?$/.test(t=e)&&(t+="Z"),Date.parse(t)/1e3;var t},minimumUpdatePeriod:e=>Fs(e),suggestedPresentationDelay:e=>Fs(e),type:e=>e,timeShiftBufferDepth:e=>Fs(e),start:e=>Fs(e),width:e=>parseInt(e,10),height:e=>parseInt(e,10),bandwidth:e=>parseInt(e,10),startNumber:e=>parseInt(e,10),timescale:e=>parseInt(e,10),presentationTimeOffset:e=>parseInt(e,10),duration(e){const t=parseInt(e,10);return isNaN(t)?Fs(e):t},d:e=>parseInt(e,10),t:e=>parseInt(e,10),r:e=>parseInt(e,10),DEFAULT:e=>e},Ws=e=>e&&e.attributes?hs(e.attributes).reduce(((e,t)=>{const s=Hs[t.name]||Hs.DEFAULT;return e[t.name]=s(t.value),e}),{}):{},js={"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b":"org.w3.clearkey","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed":"com.widevine.alpha","urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95":"com.microsoft.playready","urn:uuid:f239e769-efa3-4850-9c16-a903c6932efb":"com.adobe.primetime"},Gs=(e,t)=>t.length?as(e.map((function(e){return t.map((function(t){return ms(e,zs(t))}))}))):e,Xs=e=>{const t=qs(e,"SegmentTemplate")[0],s=qs(e,"SegmentList")[0],i=s&&qs(s,"SegmentURL").map((e=>ns({tag:"SegmentURL"},Ws(e)))),r=qs(e,"SegmentBase")[0],n=s||t,o=n&&qs(n,"SegmentTimeline")[0],a=s||r||t,h=a&&qs(a,"Initialization")[0],l=t&&Ws(t);l&&h?l.initialization=h&&Ws(h):l&&l.initialization&&(l.initialization={sourceURL:l.initialization});const c={template:l,segmentTimeline:o&&qs(o,"S").map((e=>Ws(e))),list:s&&ns(Ws(s),{segmentUrls:i,initialization:Ws(h)}),base:r&&ns(Ws(r),{initialization:Ws(h)})};return Object.keys(c).forEach((e=>{c[e]||delete c[e]})),c},Vs=(e,t,s)=>i=>{const r=Ws(i),n=Gs(t,qs(i,"BaseURL")),o=qs(i,"Role")[0],a={role:Ws(o)};let h=ns(e,r,a);const l=qs(i,"Accessibility")[0],c=(e=>{if("urn:scte:dash:cc:cea-608:2015"===e.schemeIdUri)return("string"!=typeof e.value?[]:e.value.split(";")).map((e=>{let t,s;return s=e,/^CC\d=/.test(e)?[t,s]=e.split("="):/^CC\d$/.test(e)&&(t=e),{channel:t,language:s}}));if("urn:scte:dash:cc:cea-708:2015"===e.schemeIdUri)return("string"!=typeof e.value?[]:e.value.split(";")).map((e=>{const t={channel:void 0,language:void 0,aspectRatio:1,easyReader:0,"3D":0};if(/=/.test(e)){const[s,i=""]=e.split("=");t.channel=s,t.language=e,i.split(",").forEach((e=>{const[s,i]=e.split(":");"lang"===s?t.language=i:"er"===s?t.easyReader=Number(i):"war"===s?t.aspectRatio=Number(i):"3D"===s&&(t["3D"]=Number(i))}))}else t.language=e;return t.channel&&(t.channel="SERVICE"+t.channel),t}))})(Ws(l));c&&(h=ns(h,{captionServices:c}));const d=qs(i,"Label")[0];if(d&&d.childNodes.length){const e=d.childNodes[0].nodeValue.trim();h=ns(h,{label:e})}const u=qs(i,"ContentProtection").reduce(((e,t)=>{const s=Ws(t);s.schemeIdUri&&(s.schemeIdUri=s.schemeIdUri.toLowerCase());const i=js[s.schemeIdUri];if(i){e[i]={attributes:s};const r=qs(t,"cenc:pssh")[0];if(r){const t=zs(r);e[i].pssh=t&&gs(t)}}return e}),{});Object.keys(u).length&&(h=ns(h,{contentProtection:u}));const f=Xs(i),g=qs(i,"Representation"),p=ns(s,f);return as(g.map(((e,t,s)=>i=>{const r=qs(i,"BaseURL"),n=Gs(t,r),o=ns(e,Ws(i)),a=Xs(i);return n.map((e=>({segmentInfo:ns(s,a),attributes:ns(o,{baseUrl:e})})))})(h,n,p)))},Ys=(e,t)=>(s,i)=>{const r=Gs(t,qs(s.node,"BaseURL")),n=ns(e,{periodStart:s.attributes.start});"number"==typeof s.attributes.duration&&(n.periodDuration=s.attributes.duration);const o=qs(s.node,"AdaptationSet"),a=Xs(s.node);return as(o.map(Vs(n,r,a)))};var Qs=s(716);const Js=(e,t={})=>{const s=((e,t={})=>{const{manifestUri:s="",NOW:i=Date.now(),clientOffset:r=0}=t,n=qs(e,"Period");if(!n.length)throw new Error(ls);const o=qs(e,"Location"),a=Ws(e),h=Gs([s],qs(e,"BaseURL"));a.type=a.type||"static",a.sourceDuration=a.mediaPresentationDuration||0,a.NOW=i,a.clientOffset=r,o.length&&(a.locations=o.map(zs));const l=[];return n.forEach(((e,t)=>{const s=Ws(e),i=l[t-1];s.start=(({attributes:e,priorPeriodAttributes:t,mpdType:s})=>"number"==typeof e.start?e.start:t&&"number"==typeof t.start&&"number"==typeof t.duration?t.start+t.duration:t||"static"!==s?null:0)({attributes:s,priorPeriodAttributes:i?i.attributes:null,mpdType:a.type}),l.push({node:e,attributes:s})})),{locations:a.locations,representationInfo:as(l.map(Ys(a,h)))}})((e=>{if(""===e)throw new Error(cs);const t=new Qs.DOMParser;let s,i;try{s=t.parseFromString(e,"application/xml"),i=s&&"MPD"===s.documentElement.tagName?s.documentElement:null}catch(e){}if(!i||i&&i.getElementsByTagName("parsererror").length>0)throw new Error(ds);return i})(e),t),i=s.representationInfo.map(Us);return Ms({dashPlaylists:i,locations:s.locations,sidxMapping:t.sidxMapping})};class Ks extends je{static get Events(){return Ve}constructor(e,s={}){super(s),this.config=Object.assign({},Xe,s),this.player=e,this.xhrPlugin=shaka.net.HttpXHRPlugin.parse?shaka.net.HttpXHRPlugin.parse:shaka.net.HttpXHRPlugin,this.mediaType=null,this.lastMpdManifest=void 0,this.fragMap=new Map,this.levelsHls=[],this.currentLevel=0,this.lastLevel=0,this.multiBitrate=!1;const i=this.initLogger();let{token:r,channelId:n}=this.config;r||(r=this.config.channelIdPrefix);let o=e=>{const s=t().parseURL(e);return`${s.netLoc.substr(2)+s.path.substring(0,s.path.lastIndexOf("."))}`};n&&(o=this.makeChannelId(r,n));const a=this.makeSignalId();e.addEventListener("manifestparsed",(()=>{const{config:t}=this;if(!this.mediaType)throw new Error("mediaType is null");const s=e.isLive();t.live=s,t.mediaType=this.mediaType;const r=this.commonBrowserInfo;this.browserInfo={...r,tag:this.mediaType,live:s,type:"shaka"},r.device===I.device.PC_NATIVE&&(this.browserInfo={...this.browserInfo,app:t.appName,bundle:t.appId}),this.channel=`${o(this.player.getAssetUri())}|${a}[${D.VERSION}]`,"dash"===this.mediaType&&(this.channel=`${this.channel}d`),i.info(`P2P version: ${Ks.version} Shaka version: ${shaka.Player.version}`),i.info(`channel ${this.channel}`),this.eventListened=!1,this._init(this.channel,this.browserInfo)})),this.logger.debug("init shaka networking engine"),shaka.net.NetworkingEngine.registerScheme("http",this._processNetworkRequest.bind(this)),shaka.net.NetworkingEngine.registerScheme("https",this._processNetworkRequest.bind(this))}_processNetworkRequest(e,s,i,r,n){if(!this.mediaType&&0===i){/.m3u8(#|\?|$)/i.exec(e)?this.mediaType="hls":/.mpd(#|\?|$)/i.exec(e)&&(this.mediaType="dash"),this.logger.info(`mediaType ${this.mediaType}`);let{segmentId:t}=this.config;t||("hls"===this.mediaType?this.config.segmentId=(e,t,s,i)=>`${e}-${t}`:this.config.segmentId=(e,t)=>{let s=e.split("?")[0];return s.startsWith("http")&&(s=s.split("://")[1]),t?`${s}|${t}`:`${s}`})}if(i===shaka.net.NetworkingEngine.RequestType.SEGMENT){if(this.curTsUri=e,"dash"===this.mediaType){const t=this.config.segmentId(e);this.fragMap.has(t)&&(this.currentLevel=this.fragMap.get(t).level)}if(this.hybridLoader)return this.hybridLoader.load(e,s,i,r,n)}else if(i===shaka.net.NetworkingEngine.RequestType.MANIFEST){const o=(async()=>{let o;o=this.config.sharePlaylist&&this.pLoader?await this.pLoader.load(e,s,i,r,n).promise:await this.xhrPlugin(e,s,i,r,n).promise;const a=o.data,h=(new TextDecoder).decode(a),l=this.player.getAssetUri();if("hls"===this.mediaType)if(h.indexOf("#EXTINF:")>0||h.indexOf("#EXT-X-TARGETDURATION:")>0){let s=0;const i=Wt.parseLevelPlaylist(h,e);this.levelsHls.length>1?(this.multiBitrate=!0,s=this.levelsHls.indexOf(i.url),-1!==s&&(this.currentLevel=s)):this.levelsHls=[l],this.targetDuration=i.averagetargetduration,i.fragments.forEach((e=>{e.level=s;let i=t().buildAbsoluteURL(e.baseurl,e.relurl,{alwaysNormalize:!0});const r=e.byteRange;2===r.length&&(i=`${i}|bytes=${r[0]}-${r[1]-1}`),this.fragMap.set(i,e)}))}else{const e=Wt.parseMasterPlaylist(h,l);e.length>0&&(e.sort(((e,t)=>e.bitrate-t.bitrate)),this.levelsHls=e.map((e=>e.url)))}else{this.multiBitrate=!0;const{playlists:t}=Js(h,{manifestUri:e});let s=0;for(let e of t)e.segments.forEach((e=>{let t=e.resolvedUri;const i=e.byterange;let r;i&&(r=`bytes=${_s(i)}`);const n=this.config.segmentId(t,r);this.fragMap.set(n,{level:s,sn:e.number,url:e.resolvedUri,duration:e.duration,range:r})})),s++}return this.config.live&&g(this.fragMap,100),o})();return new shaka.util.AbortableOperation(o,(async()=>{}))}return this.xhrPlugin(e,s,i,r,n)}async _init(e,t){const{config:s,logger:i}=this;if(!this.p2pEnabled)return;this.media=this.player.getMediaElement(),this.offEventRebuffer=function(e,t){let s=null;const i=()=>{s||(s=setTimeout((()=>{t()}),2500))},r=()=>{null!=s&&(clearTimeout(s),s=null)};return e.addEventListener("waiting",i),e.addEventListener("playing",r),()=>{e.removeEventListener("waiting",i),e.removeEventListener("playing",r)}}(this.media,(()=>{this.fetcher&&this.fetcher.increRebuffers()})),this.media&&(t.pos=Math.round(this.media.currentTime));const n=()=>{this.fetcher=new te(this,s.token,window.encodeURIComponent(e),s.announce||"",t)};let o;if("hls"===this.mediaType){o=new It(this,s);try{await this.initSegmentManager()}catch(e){return void this.logger.warn(e)}t.live||(t.tag=`${this.mediaType}_${"SegmentStore"===this.bufMgr.name?"d":"m"}`),n(),this.hybridLoader=new class{constructor(e,t,s,i,r){this.config=r,this.fragMap=i,this.logger=r.logger,this.bufMgr=s,this.streamEnabled=shaka.net.HttpFetchPlugin.isSupported(),this.httpPlugin=this.streamEnabled?Nt.parse:shaka.net.HttpXHRPlugin.parse,this.p2pEnabled=r.p2pEnabled,this.scheduler=e,this.fetcher=t,this.forbidden=t.forbidden}destroy(){this.abort(),this.destroyed=!0}abort(){}load(e,t,s,i,n){const{logger:o,scheduler:a}=this,h=t.headers.Range;let l=e;h&&(l=`${l}|${h}`);const c=this.fragMap.get(l);if(!c)return o.warn("no frag"),this.httpPlugin(e,t,s,i,n);const{sn:d,level:f}=c,g=this.config.segmentId(f,d,e,h||void 0);if(o.info(`hybridLoader load segId ${g} sn ${d} level ${f}`),this.forbidden)return;this.fetcher.increMediaRequests(),n||(n=e=>{}),this.streamEnabled&&a.onFragLoading(d,f,g);const p=n;if(n=e=>{const t=e["content-length"],s=t?parseInt(t,10):0;if(this.streamEnabled&&s>0&&!a.segmentBuilderMap.has(d,f)){const e=new Dt(d,f,g,s);a.segmentBuilderMap.set(d,f,e)}p(e)},this.streamEnabled){const e=i;i=(t,s,i,{buffers:r,aborted:n})=>{if(n)return void a.segmentBuilderMap.delete(d,f);const o=a.segmentBuilderMap.get(d,f);if(o)for(let e=0;e<r.length;e++)o.receiveBytes(r[e],0===i&&e===r.length-1);e(t,s,i)}}const m=(async()=>{let h;return this.p2pEnabled&&await this.bufMgr.hasSegOfId(g)?(o.info(`bufMgr found seg segId ${g}`),h=(async()=>{let t=await this.bufMgr.getSegById(g),s=r.l.from(t.data),i=new r.l(t.data.byteLength);s.copy(i);let n=new Uint8Array(i).buffer;const a={uri:e,originalUri:e,data:n,fromCache:!0};return o.debug(`bufMgr loaded segId ${g} size ${n.byteLength}`),a})()):this.p2pEnabled&&a.hasAndSetTargetPeer(d,f,g,a.getBufferedDuration())?(o.info(`p2p load segId ${g}`),h=(async()=>{let r;const h=await a.load(d,g,f,e,t.headers);if(h&&h.data){if(!await this.bufMgr.hasSegOfId(g)){const e=u(h.data).buffer,t=new C(d,g,e,h.fromPeerId||this.fetcher.peerId,f);this.bufMgr.putSeg(t)}a.onFragLoaded(d,f,g,!1),r={uri:e,originalUri:e,data:h.data,fromCache:!0},o.info(`p2p loaded segId ${g} size ${h.data.byteLength}`)}else o.warn(`P2P timeout switched to HTTP load segId ${g}`),r=await this.requestByHttp(e,t,s,i,n,g);return r})()):(o.info(`HTTP load segId ${g}`),h=this.requestByHttp(e,t,s,i,n,g,d,f)),h})();return new shaka.util.AbortableOperation(m,(async()=>{}))}async requestByHttp(e,t,s,i,r,n,o,a){const h=await this.httpPlugin(e,t,s,i,r).promise;this.scheduler.segmentBuilderMap.delete(o,a);const l=h.data;if(!await this.bufMgr.hasSegOfId(n)){const e=u(l).buffer,t=new C(o,n,e,this.fetcher.peerId,a);this.bufMgr.putSeg(t)}return this.scheduler.onFragLoaded(o,a,n,!0),this.fetcher.reportFlow(l.byteLength),this.logger.info(`HTTP loaded ${n} size ${l.byteLength}`),h}}(o,this.fetcher,this.bufMgr,this.fragMap,s)}else o=new ut(this,s),this.bufMgr=new Me(this,s,!1),n(),this.hybridLoader=new class{constructor(e,t,s,i,r){this.config=r,this.logger=r.logger,this.bufMgr=s,this.streamEnabled=shaka.net.HttpFetchPlugin.isSupported(),this.httpPlugin=this.streamEnabled?Nt.parse:shaka.net.HttpXHRPlugin.parse,this.p2pEnabled=r.p2pEnabled,this.scheduler=e,this.fetcher=t,this.forbidden=t.forbidden}destroy(){this.abort(),this.destroyed=!0}abort(){}load(e,t,s,i,n){const{logger:o,scheduler:a}=this,h=this.config.segmentId(e,t.headers.Range||void 0);if(this.forbidden)return;this.fetcher.increMediaRequests(),n||(n=e=>{}),a.onFragLoading(h);const l=n;if(n=e=>{a.onHttpBodyStart(h);const t=e["content-length"],s=t?parseInt(t,10):0;if(s>0&&!a.segmentBuilderMap.has(h)){const e=new Lt(h,s);a.segmentBuilderMap.set(h,e)}l(e)},this.streamEnabled){const e=i;i=(t,s,i,{buffers:r,aborted:n})=>{if(n)return void a.segmentBuilderMap.delete(h);const o=a.segmentBuilderMap.get(h);if(o)for(let e=0;e<r.length;e++)o.receiveBytes(r[e],0===i&&e===r.length-1);e(t,s,i)}}let c;const d=a.getBufferedDuration();return this.p2pEnabled&&this.bufMgr.hasSegOfId(h)?(o.info(`bufMgr found seg segId ${h}`),c=(async()=>{let t=this.bufMgr.getSegById(h),s=r.l.from(t.data),i=new r.l(t.data.byteLength);s.copy(i);let n=new Uint8Array(i).buffer;return{uri:e,originalUri:e,data:n,fromCache:!0}})()):this.p2pEnabled&&a.hasAndSetTargetPeer(h,d)?(o.info(`p2p load segId ${h}`),c=(async()=>{let l;const c=await a.load(h,e,t.headers);if(c&&c.data){if(!this.bufMgr.hasSegOfId(h)){const e=r.l.from(c.data),t=new r.l(c.data.byteLength);e.copy(t);const s=new C(-1,h,t,c.fromPeerId||this.fetcher.peerId);this.bufMgr.putSeg(s)}a.onFragLoaded(h,!1),l={uri:e,originalUri:e,data:c.data,fromCache:!0},o.info(`p2p loaded segId ${h} size ${c.data.byteLength}`)}else o.warn(`P2P timeout switched to HTTP load segId ${h}`),l=await this.requestByHttp(e,t,s,i,n,h);return l})()):(o.info(`HTTP load segId ${h}`),c=this.requestByHttp(e,t,s,i,n,h)),new shaka.util.AbortableOperation(c,(async()=>{}))}async requestByHttp(e,t,s,i,n,o){const a=await this.httpPlugin(e,t,s,i,n).promise;this.scheduler.segmentBuilderMap.delete(o);const h=a.data;if(!this.bufMgr.hasSegOfId(o)){const e=r.l.from(h),t=new r.l(h.byteLength);e.copy(t);const s=new C(-1,o,t,this.fetcher.peerId);this.bufMgr.putSeg(s)}return this.scheduler.onFragLoaded(o,!0),this.fetcher.reportFlow(h.byteLength),this.logger.info(`HTTP loaded ${o} size ${h.byteLength}`),a}}(o,this.fetcher,this.bufMgr,this.fragMap,s);this.tracker=new ve(this,this.fetcher,o,s),o.bufferManager=this.bufMgr,this.pLoader=new class{constructor(e,t,s){this.config=s,this.logger=s.logger,this.xhrPlugin=t,this.p2pEnabled=s.p2pEnabled,this.scheduler=e,this.isHls="hls"===s.mediaType}destroy(){this.abort(),this.destroyed=!0}abort(){}load(e,t,s,i,n){const{logger:o}=this;let a;o.info(`HTTP load playlist ${e}`);const h=e.split("?")[0];if(this.isHls&&this.scheduler.playlistInfo.has(h)){const t=this.scheduler.getPlaylistFromPeer(h);if(t&&t.data){const{data:s,seq:i}=t;return o.info(`got playlist ${e} from peer seq ${i}`),a=(async()=>({uri:e,originalUri:e,data:r.l.from(s).buffer,fromCache:!1}))(),new shaka.util.AbortableOperation(a,(async()=>{}))}}return a=this.requestByHttp(e,t,s,i,n,h),new shaka.util.AbortableOperation(a,(async()=>{}))}async requestByHttp(e,t,s,i,r,n){const o=await this.xhrPlugin(e,t,s,i,r).promise,a=o.data,h=(new TextDecoder).decode(a);return this.scheduler.broadcastPlaylist(n,h),this.logger.info("HTTP loaded playlist"),o}}(o,this.xhrPlugin,s),this.trackerTried=!1,this.trackerTried||this.tracker.connected||!s.p2pEnabled||(this.tracker.resumeP2P(),this.trackerTried=!0,this.once("serverConnected",(()=>{s.useHttpRange&&this.curTsUri?c(this.curTsUri).then((()=>{s.httpRangeSupported=!0,i.info("http range is supported"),s.httpLoadTime-=1.5,s.httpLoadTime<1.5&&(s.httpLoadTime=1.5)})).catch((()=>{s.httpRangeSupported=!1,i.warn("http range is not supported")})):s.httpRangeSupported=!1}))),this.setupWindowListeners()}disableP2P(){this.logger&&this.logger.warn("disable P2P"),this.offEventRebuffer&&this.offEventRebuffer(),this.p2pEnabled&&(this.p2pEnabled=!1,this.config.p2pEnabled=this.p2pEnabled,this.tracker&&this.tracker instanceof ve&&(this.tracker.stopP2P(),this.tracker={},this.fetcher=null,this.bufMgr.destroy(),this.bufMgr=null))}getExtraForStats(){const e=super.getExtraForStats();return this.config.live||(e.pos=Math.round(this.media.currentTime)),this.multiBitrate&&this.currentLevel!==this.lastLevel&&(e.level=this.currentLevel+"",this.lastLevel=this.currentLevel),e}getExtraForPeersRequest(){const e=super.getExtraForPeersRequest();return this.multiBitrate&&(e.level=this.currentLevel+""),e}async initSegmentManager(){const{logger:e,config:t}=this;if(window.indexedDB&&t.useDiskCache&&!t.live){const s=new ts(this,t);try{await s.setupStore(),this.bufMgr=s}catch(s){e.warn(s),this.bufMgr=new is(this,t)}}else this.bufMgr=new is(this,t);if(this.bufMgr.maxBufSize<=0)throw new Error("bufMgr state is invalid")}}window&&(window.P2pEngineShaka=Ks);const Zs=Ks})(),i=i.default})()));